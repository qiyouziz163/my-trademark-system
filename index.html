<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼ä¼˜å’¨Â·å•†æ ‡ç”³è¯·</title>
    <!-- å¼•å…¥ Vant æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/vant@4/lib/index.css">
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Vant ç»„ä»¶åº“ -->
    <script src="https://unpkg.com/vant@4/lib/vant.min.js"></script>
    <!-- å¼•å…¥ docx å’Œ FileSaver ç”¨äºç”Ÿæˆ Word -->
    <script src="https://unpkg.com/docx@8.0.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; background-color: #f5f5f5; font-family: 'Microsoft YaHei', sans-serif; }
        .app { padding: 12px; }
        .section-title { font-size: 16px; font-weight: bold; color: #0078D7; margin: 12px 0 8px; }
        .van-cell-group { margin-bottom: 12px; }
        .selected-item { display: inline-block; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 16px; padding: 4px 12px; margin: 4px; font-size: 13px; }
        .fee-detail { background: white; padding: 12px; border-radius: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.6; max-height: 200px; overflow-y: auto; border: 1px solid #eee; }
        .red { color: #c00000; font-weight: bold; }
        .invoice-checkbox .van-checkbox__label { color: black; }
        .invoice-checkbox.is-checked .van-checkbox__label { color: #c00000; }
        .button-row { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
        .button-row .van-button { flex: 1; }
        .image-preview { width: 100%; max-height: 150px; object-fit: contain; margin-top: 8px; border: 1px dashed #ccc; border-radius: 8px; padding: 4px; }
    </style>
</head>
<body>
    <div id="app">
        <van-config-provider :theme-vars="themeVars">
            <div class="app">
                <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
                <div class="section-title">ğŸ“Œ ä¸€ã€é€‰æ‹©å•†æ ‡å°ç±»</div>
                <van-cell-group inset>
                    <van-cell title="å·²é€‰å°ç±»" :value="selectedCount + 'ä¸ª'" is-link @click="showCategoryPopup = true" />
                </van-cell-group>
                <!-- å·²é€‰å°ç±»æ ‡ç­¾åˆ—è¡¨ -->
                <div style="margin: 8px 0;">
                    <span v-for="item in selectedSubDetails" :key="item.id" class="selected-item">
                        {{ item.category }} - {{ item.name }}
                        <van-icon name="cross" @click="removeSub(item.id)" style="margin-left: 4px;" />
                    </span>
                </div>

                <!-- åˆ†ç±»é€‰æ‹©å¼¹å‡ºå±‚ -->
                <van-popup v-model:show="showCategoryPopup" position="bottom" round :style="{ height: '80%' }">
                    <div style="height: 100%; display: flex; flex-direction: column;">
                        <div style="padding: 16px; font-weight: bold; border-bottom: 1px solid #eee;">é€‰æ‹©å°ç±»</div>
                        <div style="flex:1; overflow-y: auto; padding: 12px;">
                            <van-search v-model="searchText" placeholder="æœç´¢å°ç±»åç§°" />
                            <div v-if="categories.length === 0" style="text-align: center; color: #999; padding: 20px;">
                                æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®...
                            </div>
                            <div v-for="cat in filteredCategories" :key="cat.id" style="margin-bottom: 16px;">
                                <div style="font-weight: bold; background: #f0f0f0; padding: 8px;">{{ cat.name }}</div>
                                <div v-for="group in cat.children" :key="group.id" style="margin-left: 12px;">
                                    <div style="font-size: 14px; color: #666; margin: 8px 0 4px;">{{ group.name }}</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <van-checkbox v-for="sub in group.children" :key="sub.id" v-model="selectedSet" :name="sub.id" shape="square" style="width: 45%; margin-bottom: 4px;">
                                            {{ sub.name }}
                                        </van-checkbox>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px;">
                            <van-button type="primary" block @click="showCategoryPopup = false">å®Œæˆ</van-button>
                        </div>
                    </div>
                </van-popup>

                <!-- ç”³è¯·äººä¿¡æ¯ -->
                <div class="section-title">ğŸ‘¤ äºŒã€ç”³è¯·äººä¿¡æ¯</div>
                <van-cell-group inset>
                    <van-field v-model="form.applicant" label="ç”³è¯·äººå…¨ç§°" placeholder="è¯·è¾“å…¥" />
                    <van-field v-model="form.trademark" label="å•†æ ‡åç§°" placeholder="è¯·è¾“å…¥" />
                    <van-field v-model="form.phone" label="è”ç³»ç”µè¯" placeholder="è¯·è¾“å…¥" />
                    <van-field v-model="form.contact" label="è”ç³»äººå§“å" placeholder="è¯·è¾“å…¥" />
                </van-cell-group>

                <!-- å•†æ ‡å›¾æ · -->
                <div class="section-title">ğŸ–¼ï¸ ä¸‰ã€å•†æ ‡å›¾æ ·</div>
                <van-cell-group inset>
                    <van-uploader v-model="imageList" :max-count="1" :after-read="afterImageRead" />
                </van-cell-group>
                <img v-if="imagePreview" :src="imagePreview" class="image-preview" alt="é¢„è§ˆ" />

                <!-- æœåŠ¡æ–¹æ¡ˆ -->
                <div class="section-title">ğŸ¯ å››ã€æœåŠ¡æ–¹æ¡ˆ</div>
                <van-cell-group inset>
                    <van-radio-group v-model="plan">
                        <van-cell-group>
                            <van-cell title="Aæ–¹æ¡ˆÂ·æµç¨‹è·Ÿè¿› (380å…ƒ/å¤§ç±»ï¼Œå«10å°ç±»)" clickable @click="plan='A'">
                                <template #right-icon><van-radio name="A" /></template>
                            </van-cell>
                            <van-cell title="Bæ–¹æ¡ˆÂ·ä¸“ä¸šè¾…å¯¼ (580å…ƒ/å¤§ç±»ï¼Œå«10å°ç±»)" clickable @click="plan='B'">
                                <template #right-icon><van-radio name="B" /></template>
                            </van-cell>
                            <van-cell title="Cæ–¹æ¡ˆÂ·åç½®ä»˜è´¹ (1100å…ƒ/å¤§ç±»ï¼Œå«10å°ç±»)" clickable @click="plan='C'">
                                <template #right-icon><van-radio name="C" /></template>
                            </van-cell>
                        </van-cell-group>
                    </van-radio-group>
                </van-cell-group>

                <!-- ä¸“ç¥¨é€‰é¡¹ -->
                <van-cell-group inset>
                    <van-cell title="å¼€å…·ä¸“ç¥¨ï¼ˆåŠ æ”¶5%ï¼‰">
                        <template #right-icon>
                            <van-checkbox v-model="needInvoice" :class="{ 'is-checked': needInvoice }" />
                        </template>
                    </van-cell>
                </van-cell-group>

                <!-- è´¹ç”¨æ˜ç»† -->
                <div class="section-title">ğŸ’° äº”ã€è´¹ç”¨æ˜ç»†</div>
                <div class="fee-detail" v-html="feeText"></div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="button-row">
                    <van-button type="primary" @click="exportOrder">ğŸ“„ å¯¼å‡ºWordè®¢å•</van-button>
                    <van-button type="success" @click="copySummary">ğŸ“‹ å¤åˆ¶æ‘˜è¦</van-button>
                </div>
                <div class="button-row">
                    <van-button plain @click="clearAll">ğŸ§¹ æ¸…ç©º</van-button>
                    <van-button plain @click="loadLastRecord">ğŸ”„ åŠ è½½æœ€è¿‘è®°å½•</van-button>
                </div>
                <div style="height: 20px;"></div>
            </div>
        </van-config-provider>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const app = createApp({
            setup() {
                // ä¸»é¢˜å˜é‡
                const themeVars = { primaryColor: '#0078D7' };

                // æ•°æ®
                const categories = ref([]);                // åŸå§‹åˆ†ç±»æ ‘
                const idMap = ref(new Map());               // id -> { category, name } ç”¨äºå¿«é€ŸæŸ¥æ‰¾
                const selectedSet = ref(new Set());         // å·²é€‰å°ç±»idé›†åˆ
                const showCategoryPopup = ref(false);
                const searchText = ref('');

                // è¡¨å•
                const form = reactive({
                    applicant: '',
                    trademark: '',
                    phone: '',
                    contact: ''
                });

                // å›¾ç‰‡
                const imageList = ref([]);
                const imageFile = ref(null);                // åŸå§‹æ–‡ä»¶å¯¹è±¡
                const imagePreview = ref('');                // é¢„è§ˆURL

                // æ–¹æ¡ˆå’Œä¸“ç¥¨
                const plan = ref('A');
                const needInvoice = ref(false);

                // å¤‡é€‰ç¤ºä¾‹æ•°æ®ï¼ˆå½“data.jsonåŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
                const fallbackCategories = [
                    {
                        "id": "category_01åŒ–å­¦åŸæ–™",
                        "name": "å¤§ç±» 01åŒ–å­¦åŸæ–™",
                        "children": [
                            {
                                "id": "group_01åŒ–å­¦åŸæ–™_0101",
                                "name": "ç±»ä¼¼ç¾¤ç»„ 0101",
                                "children": [
                                    { "id": "subclass_01åŒ–å­¦åŸæ–™_0101_æ°¦", "name": "æ°¦" },
                                    { "id": "subclass_01åŒ–å­¦åŸæ–™_0101_æ°¢", "name": "æ°¢" }
                                ]
                            }
                        ]
                    },
                    {
                        "id": "category_02é¢œæ–™æ²¹æ¼†",
                        "name": "å¤§ç±» 02é¢œæ–™æ²¹æ¼†",
                        "children": [
                            {
                                "id": "group_02é¢œæ–™æ²¹æ¼†_0201",
                                "name": "ç±»ä¼¼ç¾¤ç»„ 0201",
                                "children": [
                                    { "id": "subclass_02é¢œæ–™æ²¹æ¼†_0201_æŸ“æ–™", "name": "æŸ“æ–™" },
                                    { "id": "subclass_02é¢œæ–™æ²¹æ¼†_0201_åª’æŸ“å‰‚", "name": "åª’æŸ“å‰‚" }
                                ]
                            }
                        ]
                    }
                ];

                // åŠ è½½åˆ†ç±»æ•°æ®
                const loadCategories = async () => {
                    try {
                        const resp = await fetch('data.json');
                        if (!resp.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                        const data = await resp.json();
                        categories.value = data;
                    } catch (e) {
                        console.warn('åŠ è½½ data.json å¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰ç¤ºä¾‹æ•°æ®', e);
                        categories.value = fallbackCategories; // ä½¿ç”¨å¤‡é€‰æ•°æ®
                    }
                    // æ„å»ºidMap
                    const map = new Map();
                    categories.value.forEach(cat => {
                        cat.children.forEach(group => {
                            group.children.forEach(sub => {
                                map.set(sub.id, { category: cat.name, name: sub.name });
                            });
                        });
                    });
                    idMap.value = map;
                };

                // æœç´¢è¿‡æ»¤
                const filteredCategories = computed(() => {
                    if (!searchText.value) return categories.value;
                    const kw = searchText.value.toLowerCase();
                    const result = [];
                    categories.value.forEach(cat => {
                        const newCat = { ...cat, children: [] };
                        cat.children.forEach(group => {
                            const newGroup = { ...group, children: [] };
                            group.children.forEach(sub => {
                                if (sub.name.includes(kw)) {
                                    newGroup.children.push(sub);
                                }
                            });
                            if (newGroup.children.length > 0) newCat.children.push(newGroup);
                        });
                        if (newCat.children.length > 0) result.push(newCat);
                    });
                    return result;
                });

                // å·²é€‰å°ç±»è¯¦æƒ…
                const selectedSubDetails = computed(() => {
                    return Array.from(selectedSet.value).map(id => {
                        const info = idMap.value.get(id);
                        return { id, category: info?.category || '', name: info?.name || '' };
                    }).filter(item => item.category);
                });

                const selectedCount = computed(() => selectedSet.value.size);

                // ç§»é™¤å°ç±»
                const removeSub = (id) => {
                    selectedSet.value.delete(id);
                    selectedSet.value = new Set(selectedSet.value);
                };

                // å›¾ç‰‡ä¸Šä¼ åå¤„ç†
                const afterImageRead = (file) => {
                    imageFile.value = file.file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.value = e.target.result;
                    };
                    reader.readAsDataURL(file.file);
                };

                // è´¹ç”¨è®¡ç®—
                const feeDetails = computed(() => {
                    // æŒ‰å¤§ç±»ç»Ÿè®¡å°ç±»æ•°é‡
                    const catCount = {};
                    selectedSubDetails.value.forEach(item => {
                        catCount[item.category] = (catCount[item.category] || 0) + 1;
                    });

                    const planParams = {
                        A: { base: 380, extra: 38 },
                        B: { base: 580, extra: 58 },
                        C: { base: 1100, extra: 110 }
                    };
                    const param = planParams[plan.value];
                    const catCountArr = Object.entries(catCount).map(([cat, cnt]) => ({ cat, cnt }));
                    const totalOriginal = catCountArr.reduce((sum, { cnt }) => sum + (cnt <= 10 ? param.base : param.base + (cnt - 10) * param.extra), 0);
                    
                    // å¤§ç±»æ•°é‡
                    const N = catCountArr.length;
                    let discount = 1;
                    let tailDiscount = 1;
                    if (plan.value === 'B' && N > 6) discount = 0.85;
                    if (plan.value === 'C' && N > 6) tailDiscount = 0.85;
                    
                    const totalAfterDiscount = totalOriginal * discount;
                    const invoiceFee = needInvoice.value ? totalAfterDiscount * 0.05 : 0;
                    const totalWithInvoice = totalAfterDiscount + invoiceFee;

                    // å°¾æ¬¾æ¯”ä¾‹ (Cæ–¹æ¡ˆ)
                    const downPaymentRatio = 300 / 1100; // 27.27%
                    const tailPaymentRatio = (800 / 1100) * tailDiscount; // 72.73% * tailDiscount

                    return {
                        catCountArr,
                        totalOriginal,
                        totalAfterDiscount,
                        invoiceFee,
                        totalWithInvoice,
                        N,
                        discount,
                        tailDiscount,
                        downPaymentRatio,
                        tailPaymentRatio
                    };
                });

                // è´¹ç”¨æ˜ç»†HTMLæ–‡æœ¬ï¼ˆæ”¹è¿›ï¼šæœªé€‰å°ç±»æ—¶æ˜¾ç¤ºé»˜è®¤æ–¹æ¡ˆè¯´æ˜ï¼‰
                const feeText = computed(() => {
                    const d = feeDetails.value;
                    if (d.catCountArr.length === 0) {
                        // æœªé€‰æ‹©å°ç±»æ—¶æ˜¾ç¤ºé»˜è®¤æ–¹æ¡ˆè¯´æ˜
                        return `
                            <b>âš ï¸ å°šæœªé€‰æ‹©ä»»ä½•å°ç±»</b><br>
                            è¯·åœ¨åˆ†ç±»ä¸­é€‰æ‹©éœ€è¦çš„å•†æ ‡å°ç±»ï¼Œè´¹ç”¨å°†è‡ªåŠ¨è®¡ç®—ã€‚<br><br>
                            <b>=== æœåŠ¡æ–¹æ¡ˆè¯´æ˜ ===</b><br>
                            Aæ–¹æ¡ˆÂ·æµç¨‹è·Ÿè¿›: 380å…ƒ/å¤§ç±»ï¼ˆå«10å°ç±»ï¼‰<br>
                            Bæ–¹æ¡ˆÂ·ä¸“ä¸šè¾…å¯¼: 580å…ƒ/å¤§ç±»ï¼ˆå«10å°ç±»ï¼‰<br>
                            Cæ–¹æ¡ˆÂ·åç½®ä»˜è´¹: 1100å…ƒ/å¤§ç±»ï¼ˆå«10å°ç±»ï¼‰<br>
                            <span style="color:gray;">*è¶…å‡ºéƒ¨åˆ†æŒ‰38/58/110å…ƒ/å°ç±»åŠ æ”¶</span>
                        `;
                    }
                    let html = '';
                    html += `<b>=== æœåŠ¡æ–¹æ¡ˆ: ${plan.value}æ–¹æ¡ˆ ===</b><br>`;
                    html += `åŸºç¡€ä»·æ ¼ï¼šæ¯å¤§ç±»${plan.value==='A'?380:plan.value==='B'?580:1100}å…ƒï¼ˆå«10å°ç±»ï¼‰ï¼Œè¶…å‡º${plan.value==='A'?38:plan.value==='B'?58:110}å…ƒ/å°ç±»ã€‚<br>`;
                    if (plan.value === 'B' && d.N > 6) html += `<span style="color:red;">ğŸ Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šæ€»é‡‘é¢ç«‹å‡15%</span><br>`;
                    if (plan.value === 'C' && d.N > 6) html += `<span style="color:red;">ğŸ Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šå°¾æ¬¾å‡å…15%</span><br>`;
                    html += '<br><b>=== ğŸ’° è´¹ç”¨æ˜ç»† ===</b><br>';
                    d.catCountArr.forEach(item => {
                        html += `ğŸ“Œ ${item.cat}ï¼ˆ${item.cnt}ä¸ªå°ç±»ï¼‰<br>`;
                    });
                    html += `ğŸ“Š å°è®¡ï¼ˆåŸä»·ï¼‰: ${d.totalOriginal.toFixed(2)}å…ƒ<br>`;
                    if (d.discount < 1) html += `ğŸ“Š å°è®¡ï¼ˆä¼˜æƒ åï¼‰: ${d.totalAfterDiscount.toFixed(2)}å…ƒ<br>`;
                    if (needInvoice.value) {
                        html += `ğŸ§¾ ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰: ${d.invoiceFee.toFixed(2)}å…ƒ<br>`;
                        html += `<span class="red">ğŸ’ æ€»åˆè®¡ï¼ˆå«ä¸“ç¥¨ï¼‰: ${d.totalWithInvoice.toFixed(2)}å…ƒ</span><br>`;
                    } else {
                        html += `ğŸ§¾ ä¸“ç¥¨è´¹ç”¨: 0å…ƒï¼ˆæœªé€‰æ‹©ï¼‰<br>`;
                        html += `<span class="red">ğŸ’ æ€»åˆè®¡: ${d.totalAfterDiscount.toFixed(2)}å…ƒ</span><br>`;
                    }
                    if (plan.value === 'C') {
                        html += '<br><b>ã€Cæ–¹æ¡ˆÂ·ä»˜æ¬¾è®¡åˆ’ã€‘</b><br>';
                        html += `ğŸ”¹ é¦–ä»˜æ¬¾: ${(d.totalWithInvoice * d.downPaymentRatio).toFixed(2)}å…ƒ<br>`;
                        html += 'ğŸ”¹ å°¾æ¬¾ï¼ˆæ¯å¤§ç±»ä¸‹è¯åï¼‰:<br>';
                        d.catCountArr.forEach(item => {
                            // è®¡ç®—è¯¥å¤§ç±»çš„åŸºç¡€è´¹ç”¨
                            const catBase = plan.value === 'C' ? 1100 : 0;
                            const catExtra = plan.value === 'C' ? 110 : 0;
                            const catFee = item.cnt <= 10 ? catBase : catBase + (item.cnt - 10) * catExtra;
                            const catFeeWithInvoice = catFee * (needInvoice.value ? 1.05 : 1);
                            const tail = catFeeWithInvoice * d.tailPaymentRatio;
                            html += `   ${item.cat}ï¼š${tail.toFixed(2)}å…ƒ<br>`;
                        });
                    } else {
                        html += '<br><b>ã€A/Bæ–¹æ¡ˆÂ·ä»˜æ¬¾è®¡åˆ’ã€‘</b><br>';
                        html += `ğŸ“… ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…: ${(needInvoice.value ? d.totalWithInvoice : d.totalAfterDiscount).toFixed(2)}å…ƒ<br>`;
                    }
                    return html;
                });

                // å¯¼å‡ºWordè®¢å•
                const exportOrder = async () => {
                    if (!form.applicant || !form.trademark) {
                        vant.Toast.fail('è¯·å¡«å†™ç”³è¯·äººå…¨ç§°å’Œå•†æ ‡åç§°');
                        return;
                    }
                    if (selectedSet.value.size === 0) {
                        vant.Toast.fail('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°ç±»');
                        return;
                    }

                    const d = feeDetails.value;
                    const doc = new docx.Document({
                        sections: [{
                            children: [
                                new docx.Paragraph({ children: [new docx.TextRun({ text: 'ğŸ“„ å•†æ ‡ç”³è¯·è®¢å•', bold: true, size: 36 })] }),
                                new docx.Paragraph({ text: '' }),
                                new docx.Paragraph({ children: [new docx.TextRun({ text: 'ä¸€ã€åŸºæœ¬ä¿¡æ¯', bold: true })] }),
                                ...createInfoTable(),
                                new docx.Paragraph({ text: '' }),
                                new docx.Paragraph({ children: [new docx.TextRun({ text: 'äºŒã€å·²é€‰ç±»åˆ«æ˜ç»†', bold: true })] }),
                                ...createSelectedTable(),
                                new docx.Paragraph({ text: '' }),
                                new docx.Paragraph({ children: [new docx.TextRun({ text: 'ä¸‰ã€è´¹ç”¨æ˜ç»†', bold: true })] }),
                                new docx.Paragraph({ text: feeText.value.replace(/<[^>]*>/g, '') }), // ç®€å•å»HTML
                                new docx.Paragraph({ text: '' }),
                                new docx.Paragraph({ children: [new docx.TextRun({ text: 'å››ã€å•†æ ‡å›¾æ ·', bold: true })] }),
                                ...(imageFile.value ? await createImageParagraph() : [new docx.Paragraph('æœªä¸Šä¼ å•†æ ‡å›¾æ ·')]),
                            ]
                        }]
                    });

                    const blob = await docx.Packer.toBlob(doc);
                    saveAs(blob, `å•†æ ‡è®¢å•_${form.applicant}.docx`);
                    vant.Toast.success('è®¢å•å·²ç”Ÿæˆ');
                };

                // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä¿¡æ¯è¡¨æ ¼
                function createInfoTable() {
                    const rows = [
                        ['ç”³è¯·äººå…¨ç§°', form.applicant],
                        ['å•†æ ‡åç§°', form.trademark],
                        ['è”ç³»ç”µè¯', form.phone],
                        ['è”ç³»äºº', form.contact],
                        ['ä¸‹è®¢å•æ—¥æœŸ', new Date().toLocaleDateString('zh-CN')],
                        ['æœåŠ¡æ–¹æ¡ˆ', plan.value + 'æ–¹æ¡ˆ'],
                        ['ä¸“ç¥¨é€‰é¡¹', needInvoice.value ? 'æ˜¯ï¼ˆ+5%ï¼‰' : 'å¦']
                    ];
                    const table = new docx.Table({
                        rows: rows.map(([label, val]) => new docx.TableRow({
                            children: [
                                new docx.TableCell({ children: [new docx.Paragraph({ children: [new docx.TextRun({ text: label, bold: true })] })] }),
                                new docx.TableCell({ children: [new docx.Paragraph(val)] })
                            ]
                        }))
                    });
                    return [table];
                }

                function createSelectedTable() {
                    const details = selectedSubDetails.value;
                    // æŒ‰å¤§ç±»åˆ†ç»„
                    const groups = {};
                    details.forEach(item => {
                        if (!groups[item.category]) groups[item.category] = [];
                        groups[item.category].push(item.name);
                    });
                    const rows = Object.entries(groups).map(([cat, subs]) => [cat, subs.join('ï¼›')]);
                    const table = new docx.Table({
                        rows: [
                            new docx.TableRow({
                                children: [
                                    new docx.TableCell({ children: [new docx.Paragraph('å¤§ç±»')] }),
                                    new docx.TableCell({ children: [new docx.Paragraph('å°ç±»')] })
                                ]
                            }),
                            ...rows.map(([cat, subs]) => new docx.TableRow({
                                children: [
                                    new docx.TableCell({ children: [new docx.Paragraph(cat)] }),
                                    new docx.TableCell({ children: [new docx.Paragraph(subs)] })
                                ]
                            }))
                        ]
                    });
                    return [table];
                }

                async function createImageParagraph() {
                    if (!imageFile.value) return [new docx.Paragraph('æœªä¸Šä¼ å•†æ ‡å›¾æ ·')];
                    const buffer = await imageFile.value.arrayBuffer();
                    const image = new docx.ImageRun({
                        data: buffer,
                        transformation: { width: 100, height: 100 }
                    });
                    return [new docx.Paragraph({ children: [image] })];
                }

                // å¤åˆ¶æ‘˜è¦
                const copySummary = () => {
                    const text = `ç”³è¯·äººï¼š${form.applicant}\nå•†æ ‡ï¼š${form.trademark}\nç”µè¯ï¼š${form.phone}\nè”ç³»äººï¼š${form.contact}\nå·²é€‰å°ç±»ï¼š${selectedSubDetails.value.map(i=>i.name).join('ã€')}\nè´¹ç”¨ï¼š${feeText.value.replace(/<[^>]*>/g, '')}`;
                    navigator.clipboard.writeText(text).then(() => {
                        vant.Toast.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(() => {
                        vant.Toast.fail('å¤åˆ¶å¤±è´¥');
                    });
                };

                // æ¸…ç©º
                const clearAll = () => {
                    selectedSet.value.clear();
                    selectedSet.value = new Set();
                    form.applicant = '';
                    form.trademark = '';
                    form.phone = '';
                    form.contact = '';
                    imageList.value = [];
                    imageFile.value = null;
                    imagePreview.value = '';
                    plan.value = 'A';
                    needInvoice.value = false;
                    vant.Toast.success('å·²æ¸…ç©º');
                };

                // æœ¬åœ°å­˜å‚¨
                const saveLastRecord = () => {
                    const record = {
                        applicant: form.applicant,
                        phone: form.phone,
                        contact: form.contact,
                        selected: Array.from(selectedSet.value),
                        plan: plan.value,
                        needInvoice: needInvoice.value
                    };
                    localStorage.setItem('lastTrademarkRecord', JSON.stringify(record));
                };

                const loadLastRecord = () => {
                    const saved = localStorage.getItem('lastTrademarkRecord');
                    if (saved) {
                        try {
                            const record = JSON.parse(saved);
                            form.applicant = record.applicant || '';
                            form.phone = record.phone || '';
                            form.contact = record.contact || '';
                            if (record.selected) {
                                selectedSet.value = new Set(record.selected);
                            }
                            plan.value = record.plan || 'A';
                            needInvoice.value = record.needInvoice || false;
                            vant.Toast.success('å·²åŠ è½½æœ€è¿‘è®°å½•');
                        } catch (e) {
                            vant.Toast.fail('åŠ è½½å¤±è´¥');
                        }
                    } else {
                        vant.Toast.info('æš‚æ— è®°å½•');
                    }
                };

                // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ¯æ¬¡å˜åŒ–ï¼‰
                onMounted(() => {
                    loadCategories();
                });

                // ç›‘å¬å˜åŒ–ä¿å­˜
                Vue.watch([form, selectedSet, plan, needInvoice], () => {
                    saveLastRecord();
                }, { deep: true });

                return {
                    themeVars,
                    categories,
                    selectedSet,
                    showCategoryPopup,
                    searchText,
                    filteredCategories,
                    selectedSubDetails,
                    selectedCount,
                    form,
                    imageList,
                    imagePreview,
                    plan,
                    needInvoice,
                    feeText,
                    removeSub,
                    afterImageRead,
                    exportOrder,
                    copySummary,
                    clearAll,
                    loadLastRecord
                };
            }
        });

        app.use(vant);
        app.mount('#app');
    </script>
</body>
</html>
