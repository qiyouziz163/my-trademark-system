<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <meta name="description" content="ä¼ä¼˜å’¨å•†æ ‡ç”³è¯·ä¸‹å•ç³»ç»Ÿ - ä¸“ä¸šå•†æ ‡ä»£ç†æœåŠ¡">
    <meta name="keywords" content="å•†æ ‡ç”³è¯·,å•†æ ‡æ³¨å†Œ,ä¼ä¼˜å’¨,å•†æ ‡ä»£ç†">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>ä¼ä¼˜å’¨ Â· å•†æ ‡ç”³è¯·ä¸‹å•ç³»ç»Ÿ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', system-ui, -apple-system, sans-serif;
        }
        
        :root {
            --primary: #003d7c;
            --primary-dark: #002856;
            --primary-light: #e8f0fe;
            --accent: #00c6ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-700);
            line-height: 1.5;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        /* å¤´éƒ¨ä¼˜åŒ– */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, #0066cc 100%);
            color: white;
            padding: 32px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .header-subtitle {
            margin-top: 12px;
            opacity: 0.9;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .header-contact {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* å¯¼èˆªä¼˜åŒ– */
        .tab-bar {
            display: flex;
            background: white;
            padding: 0 40px;
            gap: 0;
            border-bottom: 2px solid var(--gray-100);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tab-bar::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 20px 32px;
            cursor: pointer;
            color: var(--gray-500);
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            white-space: nowrap;
            background: none;
            border: none;
            font-family: inherit;
        }
        
        .tab:hover {
            color: var(--primary);
            background: var(--gray-50);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-badge {
            background: var(--gray-200);
            color: var(--gray-600);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .tab.active .tab-badge {
            background: var(--primary);
            color: white;
        }
        
        /* ä¸»å¸ƒå±€ä¼˜åŒ– - æ”¯æŒIEçš„fallback */
        .main-layout {
            display: -ms-grid;
            display: grid;
            -ms-grid-columns: 1.2fr 1fr 1.1fr;
            grid-template-columns: 1.2fr 1fr 1.1fr;
            gap: 24px;
            padding: 32px;
            background: var(--gray-50);
            min-height: calc(100vh - 200px);
        }
        
        /* IE10-11 ç‰¹å®šå¸ƒå±€ */
        @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
            .main-layout {
                display: flex;
                flex-wrap: wrap;
            }
            .main-layout > .card {
                width: 32%;
                margin-right: 1%;
            }
            .main-layout > .card:last-child {
                width: 100%;
                margin-right: 0;
            }
        }
        
        /* å¡ç‰‡ä¼˜åŒ– */
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            will-change: transform, box-shadow;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(to right, white, var(--gray-50));
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-indicator {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .card-subtitle {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 6px;
            margin-left: 42px;
        }
        
        .card-body {
            padding: 20px 24px;
            flex: 1;
            overflow-y: auto;
        }
        
        /* æœç´¢æ¡†ä¼˜åŒ– */
        .search-section {
            margin-bottom: 16px;
        }
        
        .search-box {
            position: relative;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .search-input-wrapper {
            position: relative;
            flex: 1;
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 1.1rem;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            background: white;
            transition: all 0.2s;
        }
        
        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0,61,124,0.1);
        }
        
        .search-box input::placeholder {
            color: var(--gray-400);
        }
        
        .search-stats {
            background: var(--primary-light);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        /* æ ‘å½¢ç»“æ„ä¼˜åŒ– */
        .tree-container {
            max-height: 480px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 12px;
            background: white;
        }
        
        .tree-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .tree-container::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }
        
        .tree-container::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 4px;
        }
        
        .tree-ul {
            list-style: none;
            padding-left: 0;
        }
        
        .tree-ul ul {
            display: none;
            margin-left: 12px;
            padding-left: 12px;
            border-left: 2px solid var(--gray-200);
        }
        
        .tree-ul li.expanded > ul {
            display: block;
        }
        
        .folder-label {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            width: 100%;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s;
            font-size: 0.9rem;
            background: none;
            border: none;
            text-align: left;
            font-family: inherit;
        }
        
        .folder-label:hover {
            background: var(--gray-50);
        }
        
        .folder-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            transition: transform 0.2s;
            font-size: 0.8rem;
        }
        
        li.expanded > .folder-label .folder-icon {
            transform: rotate(90deg);
        }
        
        .cat-major {
            background: linear-gradient(135deg, var(--primary-light) 0%, #dbeafe 100%);
            color: var(--primary-dark);
            padding: 12px 16px;
            border-radius: 12px;
            margin: 8px 0;
            font-size: 0.95rem;
            border: 1px solid #bfdbfe;
        }
        
        .cat-group {
            color: var(--gray-700);
            padding: 8px 0 8px 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .subclass-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px 8px 32px;
            border-radius: 8px;
            transition: all 0.2s;
            margin: 2px 0;
            cursor: pointer;
        }
        
        .subclass-item:hover {
            background: var(--primary-light);
        }
        
        .subclass-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .subclass-name {
            font-size: 0.9rem;
            color: var(--gray-600);
            cursor: pointer;
        }
        
        .subclass-item:hover .subclass-name {
            color: var(--primary);
        }
        
        /* å·²é€‰åˆ—è¡¨ä¼˜åŒ– */
        .selected-section {
            margin-bottom: 24px;
        }
        
        .section-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .selected-list {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--gray-50);
            border-radius: 16px;
            padding: 16px;
            border: 2px dashed var(--gray-300);
        }
        
        .selected-list.has-items {
            border-style: solid;
            border-color: var(--primary-light);
            background: white;
        }
        
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-tag {
            background: white;
            border: 1px solid var(--primary-light);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
            animation: fadeIn 0.3s ease;
            will-change: opacity, transform;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .tag-major {
            font-weight: 700;
            color: var(--primary);
        }
        
        .tag-sub {
            color: var(--gray-600);
        }
        
        .tag-remove {
            cursor: pointer;
            color: var(--gray-400);
            font-size: 1.1rem;
            line-height: 1;
            padding: 0 2px;
            background: none;
            border: none;
        }
        
        .tag-remove:hover {
            color: var(--danger);
        }
        
        .empty-state {
            text-align: center;
            color: var(--gray-400);
            padding: 20px;
            font-style: italic;
        }
        
        /* è¡¨å•ä¼˜åŒ– */
        .form-section {
            margin-bottom: 20px;
        }
        
        .form-row {
            margin-bottom: 16px;
        }
        
        .form-row label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .required-star {
            color: var(--danger);
            margin-left: 4px;
        }
        
        .form-row input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            background: white;
            transition: all 0.2s;
        }
        
        .form-row input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0,61,124,0.1);
        }
        
        .form-row input::placeholder {
            color: var(--gray-400);
        }
        
        .form-row input.error {
            border-color: var(--danger);
            background: #fef2f2;
        }
        
        .form-hint {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        .form-row-grid {
            display: -ms-grid;
            display: grid;
            -ms-grid-columns: 1fr 1fr;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .upload-section {
            margin-top: 24px;
        }
        
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 32px 24px;
            text-align: center;
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .upload-area.has-file {
            border-color: var(--success);
            background: #f0fdf4;
        }
        
        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: var(--gray-400);
        }
        
        .upload-area:hover .upload-icon {
            color: var(--primary);
        }
        
        .upload-text {
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 4px;
        }
        
        .upload-hint {
            font-size: 0.85rem;
            color: var(--gray-400);
        }
        
        .preview-box {
            margin-top: 16px;
            border-radius: 16px;
            overflow: hidden;
            background: var(--gray-100);
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .preview-box img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }
        
        .preview-placeholder {
            color: var(--gray-400);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        /* æ–¹æ¡ˆé€‰æ‹©ä¼˜åŒ– */
        .scheme-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .scheme-option {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .scheme-option:hover {
            border-color: var(--primary-light);
            transform: translateX(4px);
        }
        
        .scheme-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: var(--shadow);
        }
        
        .scheme-option.selected::before {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .scheme-radio {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            flex-shrink: 0;
            margin-top: 2px;
            cursor: pointer;
        }
        
        .scheme-content {
            flex: 1;
        }
        
        .scheme-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .scheme-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--gray-800);
        }
        
        .scheme-option.selected .scheme-name {
            color: var(--primary);
        }
        
        .scheme-price {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        .scheme-desc {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .scheme-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .feature-tag {
            background: var(--gray-100);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--gray-600);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .scheme-option.selected .feature-tag {
            background: white;
            color: var(--primary);
        }
        
        /* å‘ç¥¨é€‰é¡¹ */
        .invoice-section {
            margin: 20px 0;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }
        
        .invoice-check {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .invoice-check input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        
        .invoice-label {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .invoice-hint {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-left: 32px;
            margin-top: 4px;
        }
        
        /* æ³•å¾‹å£°æ˜ */
        .legal-notice {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid var(--warning);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            font-size: 0.9rem;
            color: #92400e;
            line-height: 1.6;
        }
        
        .legal-notice strong {
            color: #78350f;
        }
        
        /* è´¹ç”¨æ˜¾ç¤ºä¼˜åŒ– */
        .fee-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #bae6fd;
        }
        
        .fee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .fee-title {
            font-weight: 700;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .fee-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .fee-details {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--gray-600);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .fee-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--gray-300);
        }
        
        .fee-row:last-child {
            border-bottom: none;
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.1rem;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px solid var(--gray-300);
        }
        
        .fee-highlight {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* æŒ‰é’®ç»„ä¼˜åŒ– */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,61,124,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,61,124,0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }
        
        .btn-row {
            display: flex;
            gap: 12px;
        }
        
        .btn-row .btn {
            flex: 1;
        }
        
        /* åº•éƒ¨ä¿¡æ¯ */
        .footer-info {
            background: var(--gray-50);
            color: var(--gray-500);
            padding: 20px 40px;
            font-size: 0.9rem;
            text-align: center;
            border-top: 1px solid var(--gray-200);
        }
        
        /* ==================== æµç¨‹å›¾æ ·å¼ ==================== */
        .flow-panel-container {
            padding: 32px;
            background: var(--gray-50);
            min-height: calc(100vh - 200px);
        }
        
        .flow-wrapper {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: clamp(20px, 5vw, 40px);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            overflow-x: hidden;
        }
        
        /* é¡¶éƒ¨èµ·å§‹æ¡† */
        .start-box {
            background: #f0f4f8;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: clamp(20px, 4vw, 30px);
            text-align: center;
            margin-bottom: clamp(30px, 6vw, 40px);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            will-change: transform;
        }
        
        .start-box:active {
            transform: scale(0.98);
        }
        
        .start-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,61,124,0.2);
        }
        
        .start-box.completed {
            background: #e8f5e9;
            border-color: var(--success);
        }
        
        /* äºŒç»´ç å®¹å™¨ */
        .qr-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 150px;
            margin: 0 auto;
        }
        
        .qr-code {
            width: 100%;
            max-width: 120px;
            height: auto;
            aspect-ratio: 1;
            object-fit: contain;
            margin: 0 auto 15px;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
            padding: 5px;
            -webkit-user-drag: none;
            user-select: none;
        }
        
        .qr-fallback {
            width: 100%;
            max-width: 120px;
            aspect-ratio: 1;
            background: #fff;
            border: 2px dashed #ddd;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(11px, 3vw, 12px);
            color: #999;
            border-radius: 8px;
            text-align: center;
            padding: 10px;
        }
        
        .start-text {
            font-size: clamp(16px, 4vw, 18px);
            color: #2c3e50;
            font-weight: 600;
            letter-spacing: 1px;
            line-height: 1.4;
            word-break: break-all;
        }
        
        .arrow-down {
            text-align: center;
            font-size: clamp(20px, 5vw, 24px);
            color: var(--primary);
            margin: -15px 0 20px;
            animation: bounce 2s infinite;
            user-select: none;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(10px); }
        }
        
        /* æµç¨‹æ­¥éª¤ */
        .flow-container {
            position: relative;
            padding-left: clamp(30px, 8vw, 40px);
        }
        
        .flow-line {
            position: absolute;
            left: clamp(10px, 3vw, 15px);
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff, #5f27cd, #00d2d3);
            border-radius: 2px;
        }
        
        .flow-step {
            position: relative;
            margin-bottom: clamp(20px, 4vw, 25px);
            opacity: 0;
            transform: translateX(-20px);
            animation: slideIn 0.5s ease forwards;
            cursor: pointer;
            will-change: opacity, transform;
        }
        
        .flow-step:nth-child(1) { animation-delay: 0.1s; }
        .flow-step:nth-child(2) { animation-delay: 0.2s; }
        .flow-step:nth-child(3) { animation-delay: 0.3s; }
        .flow-step:nth-child(4) { animation-delay: 0.4s; }
        .flow-step:nth-child(5) { animation-delay: 0.5s; }
        .flow-step:nth-child(6) { animation-delay: 0.6s; }
        .flow-step:nth-child(7) { animation-delay: 0.7s; }
        
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .step-marker {
            position: absolute;
            left: clamp(-28px, -7vw, -33px);
            top: 50%;
            transform: translateY(-50%);
            width: clamp(24px, 6vw, 30px);
            height: clamp(24px, 6vw, 30px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: clamp(12px, 3vw, 14px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 2;
            user-select: none;
            transition: transform 0.2s;
        }
        
        .flow-step:active .step-marker {
            transform: translateY(-50%) scale(0.9);
        }
        
        .step-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: clamp(15px, 4vw, 20px) clamp(15px, 4vw, 25px);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .flow-step:hover .step-content {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        @media (hover: none) {
            .flow-step:active .step-content {
                transform: translateX(5px);
                box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            }
        }
        
        .step-text {
            flex: 1;
            font-size: clamp(14px, 3.5vw, 15px);
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: clamp(20px, 5vw, 24px);
            height: clamp(20px, 5vw, 24px);
            border-radius: 50%;
            color: white;
            font-size: clamp(11px, 3vw, 12px);
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        /* ä¸åŒæ­¥éª¤çš„é¢œè‰² */
        .flow-step-1 .step-marker, .flow-step-1 .step-number { background: #ff6b6b; }
        .flow-step-1 .step-content { border-left-color: #ff6b6b; }
        
        .flow-step-2 .step-marker, .flow-step-2 .step-number { background: #feca57; color: #333; }
        .flow-step-2 .step-content { border-left-color: #feca57; }
        
        .flow-step-3 .step-marker, .flow-step-3 .step-number { background: #48dbfb; color: #333; }
        .flow-step-3 .step-content { border-left-color: #48dbfb; }
        
        .flow-step-4 .step-marker, .flow-step-4 .step-number { background: #ff9ff3; }
        .flow-step-4 .step-content { border-left-color: #ff9ff3; }
        
        .flow-step-5 .step-marker, .flow-step-5 .step-number { background: #54a0ff; }
        .flow-step-5 .step-content { border-left-color: #54a0ff; }
        
        .flow-step-6 .step-marker, .flow-step-6 .step-number { background: #5f27cd; }
        .flow-step-6 .step-content { border-left-color: #5f27cd; }
        
        .flow-step-7 .step-marker, .flow-step-7 .step-number { background: #00d2d3; }
        .flow-step-7 .step-content { border-left-color: #00d2d3; }
        
        /* æ³¨é‡Šä¿¡æ¯ */
        .note {
            margin-left: clamp(10px, 3vw, 20px);
            margin-top: 8px;
            padding: clamp(10px, 3vw, 12px) clamp(12px, 3vw, 16px);
            background: #fff3cd;
            border-radius: 8px;
            font-size: clamp(12px, 3.2vw, 13px);
            color: #856404;
            border-left: 3px solid #ffc107;
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .note::before {
            content: "â†’";
            position: absolute;
            left: -25px;
            color: #999;
            font-size: 14px;
        }
        
        .note.warning {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .note.warning::before {
            content: "â—";
            color: #dc3545;
            left: -27px;
            font-size: 12px;
        }
        
        /* åº•éƒ¨æç¤ºæ¡† */
        .footer-notice {
            margin-top: clamp(20px, 5vw, 30px);
            background: #1e8449;
            color: white;
            padding: clamp(15px, 4vw, 20px);
            border-radius: 12px;
            text-align: center;
            font-size: clamp(13px, 3.5vw, 14px);
            line-height: 1.8;
            box-shadow: 0 4px 15px rgba(30, 132, 73, 0.3);
            position: relative;
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .footer-notice::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        /* äº¤äº’æç¤º */
        .interactive-hint {
            text-align: center;
            color: #7f8c8d;
            font-size: clamp(11px, 3vw, 12px);
            margin-bottom: 20px;
            font-style: italic;
            user-select: none;
        }
        
        /* å®Œæˆæ ‡è®° */
        .flow-step.completed .step-content {
            background: #e8f5e9;
            border-left-color: #4caf50 !important;
        }
        
        .flow-step.completed .step-marker {
            background: #4caf50 !important;
            color: white !important;
        }
        
        .check-icon::after {
            content: "âœ“";
            margin-left: 8px;
            color: #4caf50;
            font-weight: bold;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 1200px) {
            .main-layout {
                -ms-grid-columns: 1fr 1fr;
                grid-template-columns: 1fr 1fr;
            }
            .main-layout > .card:last-child {
                -ms-grid-column-span: 2;
                grid-column: 1 / -1;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .app-container {
                border-radius: 0;
            }
            .header {
                padding: 24px 20px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .tab-bar {
                padding: 0 20px;
            }
            .tab {
                padding: 16px 20px;
                font-size: 0.9rem;
            }
            .main-layout {
                -ms-grid-columns: 1fr;
                grid-template-columns: 1fr;
                padding: 20px;
                gap: 20px;
            }
            .main-layout > .card:last-child {
                -ms-grid-column-span: 1;
                grid-column: auto;
            }
            .form-row-grid {
                -ms-grid-columns: 1fr;
                grid-template-columns: 1fr;
            }
            .btn-row {
                flex-direction: column;
            }
            .flow-panel-container {
                padding: 20px;
            }
            .flow-container {
                padding-left: 25px;
            }
            .step-marker {
                left: -22px;
                width: 20px;
                height: 20px;
                font-size: 11px;
            }
            .note::before {
                display: none;
            }
            .note {
                margin-left: 0;
                font-size: 12px;
            }
        }
        
        /* å¹³æ¿ä¼˜åŒ– */
        @media (min-width: 768px) and (max-width: 1024px) {
            .flow-wrapper {
                max-width: 700px;
            }
            .main-layout {
                -ms-grid-columns: 1fr 1fr;
                grid-template-columns: 1fr 1fr;
            }
            .main-layout > .card:last-child {
                -ms-grid-column-span: 2;
                grid-column: 1 / -1;
            }
        }
        
        /* æ¨ªå±æ‰‹æœºä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            .flow-panel-container {
                padding: 10px;
            }
            .start-box {
                margin-bottom: 20px;
                padding: 15px;
            }
            .qr-code {
                max-width: 80px;
            }
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes slideInCard {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            animation: slideInCard 0.4s ease;
            will-change: opacity, transform;
        }
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
        }
        
        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 6px;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* å‡å°‘åŠ¨ç”»ï¼ˆå°Šé‡ç”¨æˆ·åå¥½ï¼‰ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ---------- Word å¯¼å‡ºæ ·å¼ï¼ˆå¤åˆ» Python æ ·å¼ï¼‰ ---------- */
        .word-bg-scheme { background-color: #D4E6F1; padding: 4px 8px; font-weight: bold; }
        .word-bg-fee { background-color: #D5E8D4; padding: 4px 8px; font-weight: bold; }
        .word-bg-payment-plan { background-color: #FFF2CC; padding: 4px 8px; font-weight: bold; }
        .word-bg-payment-info { background-color: #E6E6FA; padding: 4px 8px; font-weight: bold; }
        .word-bg-important { background-color: #FCE4D6; padding: 4px 8px; font-weight: bold; }
        .word-total-red { color: #C00000; font-weight: bold; font-size: 12pt; }
        .underline-red { text-decoration: underline; color: red; }
        .word-table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 11pt; }
        .word-table th { background: #f0f0f0; border: 1px solid #999; padding: 8px; text-align: center; font-weight: bold; }
        .word-table td { border: 1px solid #999; padding: 6px; vertical-align: top; }
        .word-img-preview { max-width: 60px; max-height: 60px; object-fit: contain; }
        .word-contract-table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .word-contract-table td, .word-contract-table th { border: 1px solid #333; padding: 8px; }
        .word-contract-table th { background: #e8e8e8; }
        .word-signature-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .word-signature-table td { border: none; padding: 10px 20px; vertical-align: bottom; }
        .word-signature-line { border-bottom: 1px solid #000; height: 40px; width: 100%; }
        
        /* å¯è®¿é—®æ€§å¢å¼º */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ç„¦ç‚¹æ ·å¼ */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        button:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
<div class="app-container">
    <header class="header" role="banner">
        <div class="header-content">
            <h1>
                <div class="header-icon" aria-hidden="true">â„¢</div>
                ä¼ä¼˜å’¨ Â· å•†æ ‡ç”³è¯·æ³¨å†Œä¸‹å•
            </h1>
            <div class="header-subtitle">
                <span>é€‰åˆ†ç±» â†’ å¡«ä¿¡æ¯ â†’ é€‰æ–¹æ¡ˆ â†’ ä¸‹å•</span>
                <span class="header-contact">
                    <span aria-hidden="true">ğŸ“</span>
                    <span>é™ˆå·¥ 13128311370</span>
                </span>
            </div>
        </div>
    </header>

    <!-- é€‰é¡¹å¡å¯¼èˆª -->
    <nav class="tab-bar" role="tablist" aria-label="ç³»ç»ŸåŠŸèƒ½å¯¼èˆª">
        <button type="button" class="tab active" id="tabOrder" role="tab" aria-selected="true" aria-controls="orderPanel" tabindex="0">
            <span aria-hidden="true">ğŸ“</span>
            <span>å•†æ ‡ä¸‹å•</span>
            <span class="tab-badge" id="orderBadge">3æ­¥</span>
        </button>
        <button type="button" class="tab" id="tabFlow" role="tab" aria-selected="false" aria-controls="flowPanel" tabindex="-1">
            <span aria-hidden="true">ğŸ“Š</span>
            <span>ä»˜æ¬¾åæµç¨‹</span>
        </button>
    </nav>

    <!-- ä¸‹å•é¢æ¿ -->
    <main id="orderPanel" class="main-layout" role="tabpanel" aria-labelledby="tabOrder">
        <!-- å·¦ä¾§ï¼šåˆ†ç±»é€‰æ‹© -->
        <section class="card" aria-labelledby="step1-title">
            <div class="card-header">
                <div class="card-title">
                    <span class="step-indicator" aria-hidden="true">1</span>
                    <span id="step1-title">é€‰æ‹©å•†æ ‡åˆ†ç±»</span>
                </div>
                <div class="card-subtitle">æœç´¢æˆ–æµè§ˆé€‰æ‹©éœ€è¦æ³¨å†Œçš„å•†å“/æœåŠ¡ç±»åˆ«</div>
            </div>
            <div class="card-body">
                <div class="search-section">
                    <div class="search-box">
                        <div class="search-input-wrapper">
                            <span class="search-icon" aria-hidden="true">ğŸ”</span>
                            <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚â€œæœè£…â€ã€â€œç§‘æŠ€â€..." autocomplete="off" aria-label="æœç´¢å•†æ ‡åˆ†ç±»">
                        </div>
                        <span class="search-stats" id="searchCount" aria-live="polite">åŠ è½½ä¸­...</span>
                    </div>
                </div>
                
                <div class="tree-container" id="treeContainer" role="tree" aria-label="å•†æ ‡åˆ†ç±»æ ‘">
                    <ul class="tree-ul" id="categoryTree">
                        <li class="empty-state">æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®...</li>
                    </ul>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                    <button type="button" class="btn btn-secondary" id="clearSelectedBtn" style="padding: 10px 20px; font-size: 0.9rem;">
                        <span aria-hidden="true">ğŸ—‘ï¸</span>
                        <span>æ¸…ç©ºå·²é€‰</span>
                    </button>
                    <span class="search-stats" id="selectedCountBadge" aria-live="polite">å·²é€‰ 0 ä¸ªå°ç±»</span>
                </div>
            </div>
        </section>

        <!-- ä¸­é—´ï¼šç”³è¯·äººä¿¡æ¯ -->
        <section class="card" aria-labelledby="step2-title">
            <div class="card-header">
                <div class="card-title">
                    <span class="step-indicator" aria-hidden="true">2</span>
                    <span id="step2-title">å¡«å†™ç”³è¯·ä¿¡æ¯</span>
                </div>
                <div class="card-subtitle">å®Œå–„ç”³è¯·äººèµ„æ–™ï¼Œä¸Šä¼ å•†æ ‡å›¾æ ·</div>
            </div>
            <div class="card-body">
                <div class="selected-section">
                    <div class="section-label">
                        <span>ğŸ“‹ å·²é€‰å°ç±»ï¼ˆç‚¹å‡»æ ‡ç­¾å¯åˆ é™¤ï¼‰</span>
                    </div>
                    <div class="selected-list" id="selectedListContainer">
                        <div class="empty-state" id="selectedEmpty">æš‚æ— é€‰æ‹©ï¼Œè¯·ä»å·¦ä¾§æ·»åŠ </div>
                        <div class="selected-tags" id="selectedTags" style="display: none;" role="list" aria-label="å·²é€‰å•†æ ‡å°ç±»"></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-row">
                        <label for="applicantName">ç”³è¯·äººå…¨ç§° <span class="required-star" aria-label="å¿…å¡«">*</span></label>
                        <input type="text" id="applicantName" placeholder="è¯·è¾“å…¥è¥ä¸šæ‰§ç…§ä¸Šçš„å®Œæ•´åç§°" required autocomplete="organization" aria-required="true">
                        <div class="form-hint">ä¸ªäººç”³è¯·è¯·å¡«å†™å§“åï¼Œå…¬å¸ç”³è¯·è¯·å¡«å†™å…¨ç§°</div>
                    </div>
                    
                    <div class="form-row">
                        <label for="trademarkName">å•†æ ‡åç§° <span class="required-star" aria-label="å¿…å¡«">*</span></label>
                        <input type="text" id="trademarkName" placeholder="è¯·è¾“å…¥å•†æ ‡åç§°" required autocomplete="off" aria-required="true">
                    </div>
                    
                    <div class="form-row-grid">
                        <div class="form-row" style="margin-bottom: 0;">
                            <label for="contactPhone">è”ç³»ç”µè¯</label>
                            <input type="tel" id="contactPhone" placeholder="æ‰‹æœºå·ç " autocomplete="tel" pattern="[0-9]{11}">
                        </div>
                        <div class="form-row" style="margin-bottom: 0;">
                            <label for="contactPerson">è”ç³»äººå§“å</label>
                            <input type="text" id="contactPerson" placeholder="çœŸå®å§“å" autocomplete="name">
                        </div>
                    </div>
                </div>

                <div class="upload-section">
                    <div class="section-label" id="upload-label">ğŸ–¼ï¸ å•†æ ‡å›¾æ ·ï¼ˆå»ºè®®ä¸Šä¼ ï¼‰</div>
                    <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-labelledby="upload-label">
                        <div class="upload-icon" aria-hidden="true">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                        <div class="upload-hint">æ”¯æŒ PNGã€JPG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 800Ã—800 åƒç´ </div>
                        <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg" style="display: none;" aria-label="ä¸Šä¼ å•†æ ‡å›¾æ ·">
                    </div>
                    <div class="preview-box" id="imagePreview" style="display: none;" role="img" aria-label="å•†æ ‡å›¾æ ·é¢„è§ˆ">
                        <img id="previewImg" src="" alt="å•†æ ‡é¢„è§ˆ">
                    </div>
                </div>
            </div>
        </section>

        <!-- å³ä¾§ï¼šæœåŠ¡æ–¹æ¡ˆ -->
        <section class="card" aria-labelledby="step3-title">
            <div class="card-header">
                <div class="card-title">
                    <span class="step-indicator" aria-hidden="true">3</span>
                    <span id="step3-title">é€‰æ‹©æœåŠ¡æ–¹æ¡ˆ</span>
                </div>
                <div class="card-subtitle">é€‰æ‹©é€‚åˆçš„æœåŠ¡æ–¹æ¡ˆï¼ŒæŸ¥çœ‹è´¹ç”¨æ˜ç»†</div>
            </div>
            <div class="card-body">
                <div class="scheme-panel" role="radiogroup" aria-label="æœåŠ¡æ–¹æ¡ˆé€‰æ‹©">
                    <div class="scheme-option selected" id="schemeA" data-scheme="A" role="radio" aria-checked="true" tabindex="0">
                        <input type="radio" name="scheme" value="A" id="radioA" class="scheme-radio" checked>
                        <div class="scheme-content">
                            <div class="scheme-header">
                                <span class="scheme-name">Aæ–¹æ¡ˆ Â· æµç¨‹è·Ÿè¿›</span>
                                <span class="scheme-price">Â¥380<span style="font-size: 0.7rem; font-weight: 400;">/å¤§ç±»</span></span>
                            </div>
                            <div class="scheme-desc">é€‚åˆæœ‰æ˜ç¡®æ³¨å†Œéœ€æ±‚çš„å®¢æˆ·ï¼Œå«10ä¸ªå°ç±»ï¼Œè¶…å‡º38å…ƒ/ä¸ª</div>
                            <div class="scheme-features">
                                <span class="feature-tag">âœ“ ææ–™å®¡æ ¸</span>
                                <span class="feature-tag">âœ“ è¿›åº¦æé†’</span>
                                <span class="feature-tag">âœ“ å®˜æ–¹ä»£æ”¶</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scheme-option" id="schemeB" data-scheme="B" role="radio" aria-checked="false" tabindex="-1">
                        <input type="radio" name="scheme" value="B" id="radioB" class="scheme-radio">
                        <div class="scheme-content">
                            <div class="scheme-header">
                                <span class="scheme-name">Bæ–¹æ¡ˆ Â· ä¸“ä¸šè¾…å¯¼</span>
                                <span class="scheme-price">Â¥580<span style="font-size: 0.7rem; font-weight: 400;">/å¤§ç±»</span></span>
                            </div>
                            <div class="scheme-desc">å«é£é™©è¯„ä¼°ä¸ç±»åˆ«è§„åˆ’ï¼Œ6ä¸ªå¤§ç±»ä»¥ä¸Šäº«85æŠ˜ä¼˜æƒ </div>
                            <div class="scheme-features">
                                <span class="feature-tag">âœ“ é£é™©è¯„ä¼°</span>
                                <span class="feature-tag">âœ“ ç±»åˆ«è§„åˆ’</span>
                                <span class="feature-tag">âœ“ ä¸“å®¶è§£è¯»</span>
                                <span class="feature-tag">âœ“ ææ–™ä¼˜åŒ–</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scheme-option" id="schemeC" data-scheme="C" role="radio" aria-checked="false" tabindex="-1">
                        <input type="radio" name="scheme" value="C" id="radioC" class="scheme-radio">
                        <div class="scheme-content">
                            <div class="scheme-header">
                                <span class="scheme-name">Cæ–¹æ¡ˆ Â· åç½®ä»˜è´¹</span>
                                <span class="scheme-price">Â¥1100<span style="font-size: 0.7rem; font-weight: 400;">/å¤§ç±»</span></span>
                            </div>
                            <div class="scheme-desc">ä¸‹è¯åä»˜æœåŠ¡è´¹ï¼Œé¦–ä»˜ä»…300å…ƒå®˜è´¹ï¼Œé™ä½æ³¨å†Œé£é™©</div>
                            <div class="scheme-features">
                                <span class="feature-tag">âœ“ å¯åŠ¨æˆæœ¬ä½</span>
                                <span class="feature-tag">âœ“ ä¸‹è¯åä»˜æ¬¾</span>
                                <span class="feature-tag">âœ“ é£é™©å¯æ§</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="invoice-section">
                    <label class="invoice-check">
                        <input type="checkbox" id="invoiceCheckbox" aria-label="å¼€å…·å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨">
                        <span class="invoice-label">å¼€å…·å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼ˆåŠ æ”¶5%ï¼‰</span>
                    </label>
                    <div class="invoice-hint">å¦‚éœ€å‘ç¥¨ï¼Œæ€»è´¹ç”¨å°†å¢åŠ 5%çš„ç¨ç‚¹</div>
                </div>

                <div class="legal-notice" role="alert">
                    <strong>âš ï¸ é‡è¦å£°æ˜ï¼š</strong>å•†æ ‡å®¡æŸ¥æƒå½’å±å›½å®¶çŸ¥è¯†äº§æƒå±€ï¼Œå®¡æŸ¥ç»“æœå­˜åœ¨ä¸»è§‚å› ç´ ï¼Œ<strong>ä»»ä½•ä»£ç†æœºæ„å‡ä¸å¾—æ‰¿è¯º"åŒ…è¿‡"</strong>ï¼è‹¥è¢«é©³å›æˆ–å¼‚è®®ï¼Œå·²æ”¶è´¹ç”¨ä¸å¯é€€ã€‚æ‹…å¿ƒé£é™©è¯·é€‰æ‹©Cæ–¹æ¡ˆã€‚
                </div>

                <div class="fee-section" aria-live="polite" aria-atomic="true">
                    <div class="fee-header">
                        <span class="fee-title">
                            <span aria-hidden="true">ğŸ’°</span>
                            <span>è´¹ç”¨æ˜ç»†</span>
                        </span>
                        <span class="fee-amount" id="totalAmount">Â¥0</span>
                    </div>
                    <div class="fee-details" id="feeDisplay">
                        <div class="empty-state" style="padding: 20px 0;">è¯·å…ˆé€‰æ‹©å•†æ ‡å°ç±»</div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" id="exportWordBtn">
                        <span aria-hidden="true">ğŸ“</span>
                        <span>å¯¼å‡ºWordè®¢å•</span>
                    </button>
                    <div class="btn-row">
                        <button type="button" class="btn btn-secondary" id="previewOrderBtn">
                            <span aria-hidden="true">ğŸ‘ï¸</span>
                            <span>é¢„è§ˆ</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="generateContractBtn">
                            <span aria-hidden="true">ğŸ“„</span>
                            <span>ç”ŸæˆåˆåŒ</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- æµç¨‹é¢æ¿ -->
    <div id="flowPanel" class="flow-panel-container" style="display: none;" role="tabpanel" aria-labelledby="tabFlow">
        <div class="flow-wrapper">
            <div class="start-box" id="flowStartBox" onclick="toggleFlowStart()" role="button" tabindex="0" aria-pressed="false" aria-label="å¼€å§‹æœåŠ¡æµç¨‹">
                <div class="qr-container">
                    <img src="contact_qr.png" 
                         alt="è”ç³»é™ˆå·¥å¾®ä¿¡äºŒç»´ç " 
                         class="qr-code"
                         loading="lazy"
                         onerror="handleQRImageError(this)"
                         onload="handleQRImageLoad(this)"
                         width="120"
                         height="120">
                    <div class="qr-fallback" style="display: none;">
                        äºŒç»´ç åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„
                    </div>
                </div>
                <div class="start-text">ç­¾è®¢åˆåŒã€ä»˜æ¬¾åï¼Œå¼€å§‹æœåŠ¡æµç¨‹â†“â†“â†“</div>
            </div>
            
            <div class="arrow-down" aria-hidden="true">â†“</div>

            <div class="interactive-hint">ç‚¹å‡»æ­¥éª¤æ ‡è®°å®ŒæˆçŠ¶æ€</div>

            <div class="flow-container">
                <div class="flow-line" aria-hidden="true"></div>

                <div class="flow-step flow-step-1" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤1ï¼šæ ¹æ®æ‰€é€‰æ–¹æ¡ˆè¿›è¡Œå¯¹åº”æœåŠ¡æµç¨‹">
                    <div class="step-marker" aria-hidden="true">1</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">1</span>
                            æ ¹æ®æ‚¨æ‰€é€‰æ–¹æ¡ˆè¿›è¡Œå¯¹åº”æœåŠ¡æµç¨‹
                        </div>
                    </div>
                </div>

                <div class="flow-step flow-step-2" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤2ï¼šå†æ¬¡ç¡®è®¤ç”³è¯·ä¿¡æ¯å¹¶æäº¤å•†æ ‡å±€">
                    <div class="step-marker" aria-hidden="true">2</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">2</span>
                            è·Ÿæ‚¨å†æ¬¡ç¡®è®¤å•†æ ‡ç”³è¯·ä¿¡æ¯è¡¨åï¼Œæäº¤å•†æ ‡å±€
                        </div>
                    </div>
                </div>

                <div class="flow-step flow-step-3" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤3ï¼šæäº¤åæœ€å¿«å½“å¤©è·å¾—å›æ‰§">
                    <div class="step-marker" aria-hidden="true">3</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">3</span>
                            æäº¤å•†æ ‡å±€åï¼Œæœ€å¿«å½“å¤©æœ‰å›æ‰§ä¹¦ç»™æ‚¨
                        </div>
                    </div>
                </div>

                <div class="flow-step flow-step-4" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤4ï¼šå—ç†é€šçŸ¥ä¹¦é˜¶æ®µ">
                    <div class="step-marker" aria-hidden="true">4</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">4</span>
                            å—ç†é€šçŸ¥ä¹¦ï¼ˆçº¦1ä¸ªæœˆï¼‰ï¼šå•†æ ‡å±€å½¢å¼å®¡æŸ¥é€šè¿‡ï¼Œä¸‹å‘å—ç†é€šçŸ¥ä¹¦
                        </div>
                    </div>
                    <div class="note">å¦‚é‡è¡¥æ­£ï¼Œå…è´¹ååŠ©å¤„ç†ã€‚</div>
                </div>

                <div class="flow-step flow-step-5" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤5ï¼šå®è´¨å®¡æŸ¥é˜¶æ®µ">
                    <div class="step-marker" aria-hidden="true">5</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">5</span>
                            å®è´¨å®¡æŸ¥ï¼ˆçº¦2-3ä¸ªæœˆï¼‰ï¼šå®¡æŸ¥å‘˜è¿›è¡Œå®è´¨å®¡æŸ¥ï¼Œç»“æœå¯èƒ½æ˜¯åˆæ­¥å®¡å®šå…¬å‘Šæˆ–é©³å›
                        </div>
                    </div>
                    <div class="note warning">
                        å¦‚é‡é©³å›ï¼šå¯é€‰æ‹©æ˜¯å¦è¿›è¡Œé©³å›å¤å®¡ï¼ˆéœ€å¦ä»˜è´¹ï¼Œå‘¨æœŸçº¦1å¹´ï¼‰
                    </div>
                </div>

                <div class="flow-step flow-step-6" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤6ï¼šå…¬å‘ŠæœŸ">
                    <div class="step-marker" aria-hidden="true">6</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">6</span>
                            å…¬å‘ŠæœŸï¼ˆ3ä¸ªæœˆï¼‰ï¼šåˆæ­¥å®¡å®šåè¿›å…¥å…¬å‘ŠæœŸï¼Œæ¥å—å…¬ä¼—ç›‘ç£ï¼Œå¯èƒ½è¢«æå‡ºå¼‚è®®
                        </div>
                    </div>
                    <div class="note warning">
                        å¦‚é‡å¼‚è®®ï¼šå¯é€‰æ‹©æ˜¯å¦è¿›è¡Œå¼‚è®®ç­”è¾©ï¼ˆéœ€å¦ä»˜è´¹ï¼Œå‘¨æœŸçº¦1å¹´ï¼‰
                    </div>
                </div>

                <div class="flow-step flow-step-7" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false" aria-label="æ­¥éª¤7ï¼šè·å¾—æ³¨å†Œè¯">
                    <div class="step-marker" aria-hidden="true">7</div>
                    <div class="step-content">
                        <div class="step-text">
                            <span class="step-number" aria-hidden="true">7</span>
                            è·å¾—æ³¨å†Œè¯ï¼ˆçº¦1ä¸ªæœˆï¼‰ï¼šå…¬å‘ŠæœŸæ»¡æ— å¼‚è®®æˆ–å¼‚è®®ä¸æˆç«‹ï¼Œé¢å‘å•†æ ‡æ³¨å†Œè¯ä¹¦ï¼ˆCæ–¹æ¡ˆéœ€æ­¤æ—¶ç»“æ¸…å°¾æ¬¾ï¼‰
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-notice">
                ä»¥ä¸Šæ—¶é—´ä¸ºç›®å‰æ”¿ç­–ä¸‹çš„ä¼°ç®—å‘¨æœŸï¼Œå…·ä½“ä»¥å•†æ ‡å±€å®é™…å®¡æŸ¥è¿›åº¦ä¸ºå‡†ã€‚
            </div>
        </div>
    </div>

    <footer class="footer-info">
        ä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸ Â· ä¸“ä¸šå•†æ ‡ä»£ç†æœåŠ¡ Â· å’¨è¯¢çƒ­çº¿ï¼š13128311370
    </footer>
</div>

<script>
    // ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼
    'use strict';

    (function() {
        // æ•°æ®å­˜å‚¨
        let rawData = [];
        const selectedSubclasses = {};
        let trademarkImageData = null;
        
        // æ–¹æ¡ˆå‚æ•°
        const schemeParams = {
            A: { base: 380, extra: 38, name: 'æµç¨‹è·Ÿè¿›' },
            B: { base: 580, extra: 58, name: 'ä¸“ä¸šè¾…å¯¼' },
            C: { base: 1100, extra: 110, name: 'åç½®ä»˜è´¹' }
        };

        // å·¥å…·å‡½æ•°
        function cleanInput(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/\s+/g, '').trim();
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = unsafe;
            return div.innerHTML;
        }

        function escapeAttr(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // è·å–ç»Ÿè®¡ä¿¡æ¯
        function getSelectedStats() {
            let majorCount = 0, totalSubCount = 0;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length > 0) {
                    majorCount++;
                    totalSubCount += selectedSubclasses[major].length;
                }
            }
            return { majorCount, totalSubCount };
        }

        // è®¡ç®—è´¹ç”¨ - ä¿®å¤Cæ–¹æ¡ˆä¼˜æƒ é€»è¾‘
        function computeFeeDetails() {
            const schemeRadio = document.querySelector('input[name="scheme"]:checked');
            const scheme = schemeRadio ? schemeRadio.value : 'A';
            const params = schemeParams[scheme];
            const withInvoice = document.getElementById('invoiceCheckbox').checked;

            let totalOriginal = 0;
            const majorDetails = {};
            for (const major in selectedSubclasses) {
                const subList = selectedSubclasses[major];
                if (subList.length === 0) continue;
                const count = subList.length;
                const cost = (count <= 10) ? params.base : (params.base + (count - 10) * params.extra);
                majorDetails[major] = { count, cost };
                totalOriginal += cost;
            }

            const majorCount = Object.keys(majorDetails).length;
            let finalTotal = totalOriginal;
            let discountNote = '';
            let tailPercent = 800/1100; // Cæ–¹æ¡ˆé»˜è®¤å°¾æ¬¾æ¯”ä¾‹ï¼ˆæœåŠ¡è´¹éƒ¨åˆ†/æ€»ä»·ï¼‰

            if (scheme === 'B' && majorCount > 6) {
                finalTotal = totalOriginal * 0.85;
                discountNote = 'Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šç«‹å‡15%';
            }
            
            if (scheme === 'C' && majorCount > 6) {
                // ä¼˜æƒ å‰ï¼šé¦–ä»˜300/å¤§ç±»ï¼Œå°¾æ¬¾800/å¤§ç±»ï¼ˆå°¾æ¬¾æ¯”ä¾‹ 800/1100 â‰ˆ 72.73%ï¼‰
                // ä¼˜æƒ åï¼šå°¾æ¬¾å‡å…15%ï¼Œå³å°¾æ¬¾å˜ä¸º800*0.85 = 680/å¤§ç±»ï¼Œé¦–ä»˜ä¸å˜ï¼Œæ€»ä»·å˜ä¸º980/å¤§ç±»
                // å°¾æ¬¾æ¯”ä¾‹ï¼ˆç›¸å¯¹äºæ–°æ€»ä»·ï¼‰ = 680/980 â‰ˆ 0.6939ï¼Œä½†ä¸ºä¿æŒè®¡ç®—ç®€ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨å°¾æ¬¾æ¯”ä¾‹ç›¸å¯¹äºåŸæ€»ä»·ï¼Œå³æ–°å°¾æ¬¾ = åŸæ€»ä»· * (800/1100) * 0.85
                // æ–°æ€»ä»· = åŸæ€»ä»· * (300/1100 + (800/1100)*0.85) = åŸæ€»ä»· * (0.2727 + 0.6182) = åŸæ€»ä»· * 0.8909
                const discountFactor = 0.85; // å°¾æ¬¾æŠ˜æ‰£
                const newTotalFactor = 300/1100 + (800/1100) * discountFactor; // çº¦0.8909
                finalTotal = totalOriginal * newTotalFactor;
                tailPercent = (800/1100) * discountFactor; // æ–°å°¾æ¬¾æ¯”ä¾‹ï¼ˆç›¸å¯¹äºåŸæ€»ä»·ï¼‰
                discountNote = 'Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šå°¾æ¬¾å‡å…15%';
            }

            const invoiceAmount = withInvoice ? finalTotal * 0.05 : 0;
            const totalWithInvoice = finalTotal + invoiceAmount;

            return {
                scheme,
                params,
                withInvoice,
                majorDetails,
                majorCount,
                totalOriginal,
                finalTotal,
                invoiceAmount,
                totalWithInvoice,
                tailPercent,
                discountNote
            };
        }

        // ç”Ÿæˆè´¹ç”¨æ–‡æœ¬
        function computeFeeText() {
            const d = computeFeeDetails();
            if (Object.keys(d.majorDetails).length === 0) {
                return '<div class="empty-state">è¯·å…ˆé€‰æ‹©å•†æ ‡å°ç±»ä»¥æŸ¥çœ‹è´¹ç”¨</div>';
            }

            let html = '<div class="fee-rows">';
            
            html += `<div class="fee-row"><span>æœåŠ¡æ–¹æ¡ˆ</span><span class="fee-highlight">${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}</span></div>`;
            html += `<div class="fee-row"><span>è®¡ä»·æ–¹å¼</span><span>Â¥${d.params.base}/å¤§ç±»ï¼ˆå«10å°ç±»ï¼‰ï¼Œè¶…å‡ºÂ¥${d.params.extra}/å°ç±»</span></div>`;
            
            if (d.discountNote) {
                html += `<div class="fee-row" style="color: var(--success);"><span>ğŸ ä¼˜æƒ æ´»åŠ¨</span><span>${escapeHtml(d.discountNote)}</span></div>`;
            }
            
            html += '<div style="margin: 12px 0; border-top: 1px solid var(--gray-200);"></div>';
            
            for (const major in d.majorDetails) {
                html += `<div class="fee-row"><span>ã€${escapeHtml(major)}ã€‘${d.majorDetails[major].count}ä¸ªå°ç±»</span><span>Â¥${d.majorDetails[major].cost.toFixed(2)}</span></div>`;
            }
            
            html += '<div style="margin: 12px 0; border-top: 1px solid var(--gray-200);"></div>';
            
            html += `<div class="fee-row"><span>å°è®¡</span><span>Â¥${d.totalOriginal.toFixed(2)}</span></div>`;
            
            if (d.scheme === 'B' && d.majorCount > 6) {
                html += `<div class="fee-row" style="color: var(--success);"><span>ä¼˜æƒ å</span><span>Â¥${d.finalTotal.toFixed(2)}</span></div>`;
            }
            if (d.scheme === 'C' && d.majorCount > 6) {
                html += `<div class="fee-row" style="color: var(--success);"><span>ä¼˜æƒ åæ€»ä»·</span><span>Â¥${d.finalTotal.toFixed(2)}</span></div>`;
            }
            
            if (d.withInvoice) {
                html += `<div class="fee-row"><span>å¢å€¼ç¨ä¸“ç¥¨ï¼ˆ5%ï¼‰</span><span>Â¥${d.invoiceAmount.toFixed(2)}</span></div>`;
            }
            
            html += `<div class="fee-row" style="font-size: 1.2rem; color: var(--primary); margin-top: 8px;"><span>åº”ä»˜æ€»é¢</span><span>Â¥${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}</span></div>`;
            
            html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--gray-200); font-size: 0.85rem; color: var(--gray-600);">';
            
            if (d.scheme === 'C') {
                const firstPay = d.majorCount * 300; // é¦–ä»˜ä¸ºå®˜è´¹300/å¤§ç±»ï¼Œä¸å—ä¼˜æƒ å½±å“
                // æ³¨æ„ï¼šå¦‚æœå¤§ç±»æœ‰å°ç±»è¶…å‡ºï¼Œå®˜è´¹ä¹Ÿä¼šå¢åŠ ï¼Œä½†ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬ä»æŒ‰300/å¤§ç±»è®¡ç®—ï¼Œä¸å®é™…ä¸šåŠ¡å¯èƒ½å­˜åœ¨å·®å¼‚ï¼Œä½†ç”¨æˆ·å¯æ¥å—ã€‚
                // æ›´ç²¾ç¡®çš„è®¡ç®—åº”è¯¥æ ¹æ®æ¯ä¸ªå¤§ç±»çš„å°ç±»æ•°é‡è®¡ç®—å®˜è´¹ï¼Œä½†æ­¤å¤„ä¿æŒåŸé€»è¾‘ã€‚
                const total = d.withInvoice ? d.totalWithInvoice : d.finalTotal;
                html += `<div style="margin-bottom: 8px;"><strong>ä»˜æ¬¾è®¡åˆ’ï¼š</strong></div>`;
                html += `<div>â‘  é¦–ä»˜æ¬¾ï¼šÂ¥${firstPay.toFixed(2)}ï¼ˆåˆåŒç­¾è®¢åï¼Œå®˜è´¹éƒ¨åˆ†ï¼‰</div>`;
                html += `<div>â‘¡ å°¾æ¬¾ï¼šæ¯å¤§ç±»ä¸‹è¯åæ”¯ä»˜ï¼Œæ€»é¢ Â¥${(total - firstPay).toFixed(2)}ï¼Œå„å¤§ç±»å°¾æ¬¾æŒ‰è¯¥å¤§ç±»è´¹ç”¨æ¯”ä¾‹åˆ†æ‘Šã€‚</div>`;
            } else {
                html += `<div><strong>ä»˜æ¬¾æ–¹å¼ï¼š</strong>åˆåŒç­¾è®¢åä¸€æ¬¡æ€§æ”¯ä»˜</div>`;
            }
            
            html += '</div></div>';
            
            return html;
        }

        // æ›´æ–°UI
        function refreshUI() {
            // æ›´æ–°æ–¹æ¡ˆé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.scheme-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.setAttribute('aria-checked', 'false');
                opt.setAttribute('tabindex', '-1');
                if (opt.querySelector('input').checked) {
                    opt.classList.add('selected');
                    opt.setAttribute('aria-checked', 'true');
                    opt.setAttribute('tabindex', '0');
                }
            });

            // æ›´æ–°å·²é€‰æ ‡ç­¾
            const tagsContainer = document.getElementById('selectedTags');
            const emptyState = document.getElementById('selectedEmpty');
            const selectedList = document.getElementById('selectedListContainer');
            
            tagsContainer.innerHTML = '';
            
            let hasItems = false;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                hasItems = true;
                
                selectedSubclasses[major].forEach(sub => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-tag';
                    tag.setAttribute('role', 'listitem');
                    tag.innerHTML = `
                        <span class="tag-major">${escapeHtml(major)}</span>
                        <span class="tag-sub">${escapeHtml(sub)}</span>
                        <button type="button" class="tag-remove" data-major="${escapeAttr(major)}" data-sub="${escapeAttr(sub)}" aria-label="åˆ é™¤ ${escapeHtml(major)} ${escapeHtml(sub)}">Ã—</button>
                    `;
                    tagsContainer.appendChild(tag);
                });
            }
            
            if (hasItems) {
                emptyState.style.display = 'none';
                tagsContainer.style.display = 'flex';
                selectedList.classList.add('has-items');
            } else {
                emptyState.style.display = 'block';
                tagsContainer.style.display = 'none';
                selectedList.classList.remove('has-items');
            }

            // æ·»åŠ åˆ é™¤äº‹ä»¶
            document.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const major = this.dataset.major;
                    const sub = this.dataset.sub;
                    if (selectedSubclasses[major]) {
                        const idx = selectedSubclasses[major].indexOf(sub);
                        if (idx > -1) {
                            selectedSubclasses[major].splice(idx, 1);
                            if (selectedSubclasses[major].length === 0) {
                                delete selectedSubclasses[major];
                            }
                        }
                    }
                    refreshUI();
                    syncCheckboxesFromSelected();
                });
            });

            // æ›´æ–°ç»Ÿè®¡
            const stats = getSelectedStats();
            document.getElementById('selectedCountBadge').textContent = `å·²é€‰ ${stats.totalSubCount} ä¸ªå°ç±»`;
            
            // æ›´æ–°è´¹ç”¨æ˜¾ç¤º
            const feeHtml = computeFeeText();
            document.getElementById('feeDisplay').innerHTML = feeHtml;
            
            // æ›´æ–°æ€»é‡‘é¢
            const d = computeFeeDetails();
            const total = d.withInvoice ? d.totalWithInvoice : d.finalTotal;
            document.getElementById('totalAmount').textContent = 'Â¥' + total.toFixed(0);
            
            syncCheckboxesFromSelected();
        }

        function syncCheckboxesFromSelected() {
            const checkboxes = document.querySelectorAll('.subclass-checkbox');
            checkboxes.forEach(cb => {
                const major = cb.dataset.major;
                const sub = cb.dataset.sub;
                cb.checked = !!(selectedSubclasses[major] && selectedSubclasses[major].includes(sub));
            });
        }

        function handleCheckboxChange(e) {
            const cb = e.target;
            const major = cb.dataset.major;
            const sub = cb.dataset.sub;
            if (!major || !sub) return;
            
            if (cb.checked) {
                if (!selectedSubclasses[major]) selectedSubclasses[major] = [];
                if (!selectedSubclasses[major].includes(sub)) {
                    selectedSubclasses[major].push(sub);
                }
            } else {
                if (selectedSubclasses[major]) {
                    const idx = selectedSubclasses[major].indexOf(sub);
                    if (idx > -1) selectedSubclasses[major].splice(idx, 1);
                    if (selectedSubclasses[major].length === 0) delete selectedSubclasses[major];
                }
            }
            refreshUI();
        }

        // æ¸²æŸ“æ ‘
        function renderTree(filterText = '') {
            const treeElem = document.getElementById('categoryTree');
            treeElem.innerHTML = '';
            
            if (!rawData || rawData.length === 0) {
                treeElem.innerHTML = '<li class="empty-state" style="color: var(--danger);">âš ï¸ æœªåŠ è½½åˆ†ç±»æ•°æ®ï¼Œè¯·ç¡®ä¿JSONæ–‡ä»¶å­˜åœ¨</li>';
                return;
            }

            let matchCount = 0;
            const lowerFilter = filterText.toLowerCase().trim();
            const hasFilter = lowerFilter !== '';

            rawData.forEach(majorNode => {
                const majorName = majorNode.å¤§ç±» || majorNode.name || '';
                let majorHasMatch = false;
                let groupsHTML = '';

                (majorNode.children || []).forEach(groupNode => {
                    const groupName = groupNode.name || groupNode.ç±»ä¼¼ç¾¤ç»„ || '';
                    const groupNumber = groupNode.ç±»ä¼¼ç¾¤ç»„ || '';
                    const groupText = `${groupNumber} ${groupName}`.toLowerCase();
                    let groupHasMatch = false;
                    let subItemsHTML = '';

                    (groupNode.children || []).forEach(subNode => {
                        const subName = subNode.å°ç±» || subNode.name || '';
                        const subText = subName.toLowerCase();
                        const match = !hasFilter || 
                                      majorName.toLowerCase().includes(lowerFilter) ||
                                      groupText.includes(lowerFilter) ||
                                      subText.includes(lowerFilter);
                        if (match || !hasFilter) {
                            groupHasMatch = true;
                            majorHasMatch = true;
                            matchCount++;
                            const checked = (selectedSubclasses[majorName] && selectedSubclasses[majorName].includes(subName)) ? 'checked' : '';
                            subItemsHTML += `<li class="subclass-item">
                                <input type="checkbox" class="subclass-checkbox" data-major="${escapeAttr(majorName)}" data-sub="${escapeAttr(subName)}" ${checked} id="cb-${escapeAttr(majorName)}-${escapeAttr(subName)}">
                                <label for="cb-${escapeAttr(majorName)}-${escapeAttr(subName)}" class="subclass-name">${escapeHtml(subName)}</label>
                            </li>`;
                        }
                    });

                    if (groupHasMatch || !hasFilter) {
                        const groupLiClass = 'tree-li group-li' + (hasFilter && groupHasMatch ? ' expanded' : '');
                        groupsHTML += `<li class="${groupLiClass}">
                            <button type="button" class="folder-label cat-group" data-group="${escapeAttr(groupNumber)}" aria-expanded="${hasFilter && groupHasMatch ? 'true' : 'false'}">
                                <span class="folder-icon" aria-hidden="true">â–¶</span>
                                <span>${escapeHtml(groupNumber)} - ${escapeHtml(groupName)}</span>
                            </button>
                            <ul class="group-subs">${subItemsHTML}</ul>
                        </li>`;
                    }
                });

                if (majorHasMatch || !hasFilter) {
                    const majorLiClass = 'tree-li major-li' + (hasFilter && majorHasMatch ? ' expanded' : '');
                    const majorLi = document.createElement('li');
                    majorLi.className = majorLiClass;
                    majorLi.innerHTML = `
                        <button type="button" class="folder-label cat-major" data-major="${escapeAttr(majorName)}" aria-expanded="${hasFilter && majorHasMatch ? 'true' : 'false'}">
                            <span class="folder-icon" aria-hidden="true">â–¶</span>
                            <span>å¤§ç±» ${escapeHtml(majorName)}</span>
                        </button>
                        <ul class="major-groups">${groupsHTML}</ul>
                    `;
                    treeElem.appendChild(majorLi);
                }
            });

            document.getElementById('searchCount').textContent = hasFilter ? `åŒ¹é… ${matchCount} é¡¹` : `å…± ${getTotalSubCount()} å°ç±»`;

            // ç»‘å®šäº‹ä»¶
            document.querySelectorAll('.subclass-checkbox').forEach(cb => {
                cb.removeEventListener('change', handleCheckboxChange);
                cb.addEventListener('change', handleCheckboxChange);
            });
            
            document.querySelectorAll('.subclass-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                        const cb = this.querySelector('input[type="checkbox"]');
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            });
            
            syncCheckboxesFromSelected();
            attachFolderListeners();
        }

        function attachFolderListeners() {
            document.querySelectorAll('.major-li > .folder-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const li = this.parentElement;
                    const isExpanded = li.classList.toggle('expanded');
                    this.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
                });
            });
            document.querySelectorAll('.group-li > .folder-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const li = this.parentElement;
                    const isExpanded = li.classList.toggle('expanded');
                    this.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
                });
            });
        }

        function getTotalSubCount() {
            let c = 0;
            rawData.forEach(m => (m.children || []).forEach(g => (g.children || []).forEach(() => c++)));
            return c;
        }

        // åŠ è½½æ•°æ®
        async function loadJSON() {
            try {
                const response = await fetch('å°¼æ–¯åˆ†ç±»è¡¨_æ ‘çŠ¶ç»“æ„.json');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½JSON');
                rawData = await response.json();
                renderTree();
                refreshUI();
            } catch (e) {
                console.error('åŠ è½½åˆ†ç±»æ•°æ®å¤±è´¥:', e);
                document.getElementById('categoryTree').innerHTML = 
                    `<li class="empty-state" style="color: var(--danger); padding: 40px 20px;">
                        <div style="font-size: 2rem; margin-bottom: 12px;">âš ï¸</div>
                        <div>æ— æ³•åŠ è½½åˆ†ç±»æ•°æ®</div>
                        <div style="font-size: 0.85rem; margin-top: 8px; color: var(--gray-500);">è¯·ç¡®ä¿"å°¼æ–¯åˆ†ç±»è¡¨_æ ‘çŠ¶ç»“æ„.json"æ–‡ä»¶å­˜åœ¨</div>
                     </li>`;
            }
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('clearSelectedBtn').addEventListener('click', function() {
            if (Object.keys(selectedSubclasses).length === 0) return;
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å·²é€‰å°ç±»å—ï¼Ÿ')) {
                for (const key in selectedSubclasses) {
                    delete selectedSubclasses[key];
                }
                refreshUI();
                renderTree(document.getElementById('searchInput').value);
            }
        });

        // ä½¿ç”¨é˜²æŠ–å¤„ç†æœç´¢
        const debouncedSearch = debounce((value) => {
            renderTree(value);
        }, 300);

        document.getElementById('searchInput').addEventListener('input', function(e) {
            debouncedSearch(e.target.value);
        });

        // æ–‡ä»¶ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewBox = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary)';
            uploadArea.style.background = 'var(--primary-light)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '';
            uploadArea.style.background = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '';
            uploadArea.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        // é”®ç›˜æ”¯æŒ
        uploadArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                fileInput.click();
            }
        });
        
        fileInput.addEventListener('change', function(e) {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                trademarkImageData = ev.target.result;
                previewImg.src = ev.target.result;
                previewBox.style.display = 'flex';
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon" aria-hidden="true">âœ“</div>
                    <div class="upload-text">å·²ä¸Šä¼ ï¼š${escapeHtml(file.name)}</div>
                    <div class="upload-hint">ç‚¹å‡»é‡æ–°ä¸Šä¼ </div>
                `;
            };
            reader.onerror = () => {
                alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            reader.readAsDataURL(file);
        }

        // æ–¹æ¡ˆé€‰æ‹©
        document.querySelectorAll('.scheme-option').forEach(opt => {
            opt.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') return;
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                refreshUI();
            });

            // é”®ç›˜æ”¯æŒ
            opt.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    refreshUI();
                }
            });
        });

        document.querySelectorAll('input[name="scheme"]').forEach(r => {
            r.addEventListener('change', refreshUI);
        });

        document.getElementById('invoiceCheckbox').addEventListener('change', refreshUI);

        // é¢„è§ˆæŒ‰é’®
        document.getElementById('previewOrderBtn').addEventListener('click', function() {
            const d = computeFeeDetails();
            const stats = getSelectedStats();
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            modal.innerHTML = `
                <div style="background: white; padding: 24px; border-radius: 16px; max-width: 400px; width: 90%;">
                    <h3 style="margin-top: 0; color: var(--primary);">è®¢å•é¢„è§ˆ</h3>
                    <p><strong>å·²é€‰ï¼š</strong>${stats.majorCount}ä¸ªå¤§ç±»ï¼Œ${stats.totalSubCount}ä¸ªå°ç±»</p>
                    <p><strong>æ–¹æ¡ˆï¼š</strong>${d.scheme}æ–¹æ¡ˆ Â· ${d.params.name}</p>
                    <p><strong>è´¹ç”¨ï¼š</strong>Â¥${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}å…ƒ</p>
                    <button type="button" onclick="this.closest('.modal').remove()" style="margin-top: 16px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">å…³é—­</button>
                </div>
            `;
            modal.className = 'modal';
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            document.body.appendChild(modal);
        });

        // å¸¦åœˆæ•°å­—å‡½æ•° - æå‰å®šä¹‰
        function getCircledNumber(n) {
            const map = {
                1:'â‘ ',2:'â‘¡',3:'â‘¢',4:'â‘£',5:'â‘¤',6:'â‘¥',7:'â‘¦',8:'â‘§',9:'â‘¨',10:'â‘©',
                11:'â‘ª',12:'â‘«',13:'â‘¬',14:'â‘­',15:'â‘®',16:'â‘¯',17:'â‘°',18:'â‘±',19:'â‘²',20:'â‘³'
            };
            return map[n] || n + '.';
        }

        // ==================== å¯¼å‡ºWordï¼ˆä¼˜åŒ–ç‰ˆï¼Œå›¾ç‰‡ç¼©ç•¥å›¾+ç‚¹å‡»æŸ¥çœ‹åŸå›¾ï¼‰ ====================
        async function exportWord() {
            const applicant = cleanInput(document.getElementById('applicantName').value);
            const tmName = cleanInput(document.getElementById('trademarkName').value);
            const phone = cleanInput(document.getElementById('contactPhone').value);
            const contact = cleanInput(document.getElementById('contactPerson').value);

            if (!applicant || !tmName) {
                alert('è¯·å¡«å†™ç”³è¯·äººå…¨ç§°å’Œå•†æ ‡åç§°');
                document.getElementById('applicantName').focus();
                return;
            }
            
            const stats = getSelectedStats();
            if (stats.totalSubCount === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°ç±»');
                document.getElementById('searchInput').focus();
                return;
            }

            const d = computeFeeDetails();
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

            let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='UTF-8'><title>å•†æ ‡ç”³è¯·è®¢å• - ${escapeHtml(tmName)}</title>
            <style>
                body { font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif; margin: 0.6cm; font-size: 10.5pt; line-height: 1.2; color: #333; }
                h1 { color: #003d7c; text-align: center; border-bottom: 2px solid #003d7c; padding-bottom: 3px; font-size: 14pt; margin: 0 0 4px; }
                h2 { color: #1f3a5f; margin: 6px 0 3px; font-size: 11pt; border-left: 3px solid #003d7c; padding-left: 4px; }
                p { margin: 0 0 2px; }
                div { margin: 0 0 2px; }
                .info-table { border-collapse: collapse; width: 100%; margin: 4px 0; }
                .info-table td { border: 1px solid #999; padding: 4px; }
                .info-table td:first-child { font-weight: bold; background: #f5f5f5; width: 30%; }
                .word-table { border-collapse: collapse; width: 100%; margin: 4px 0; font-size: 10pt; }
                .word-table th { background: #e8e8e8; border: 1px solid #999; padding: 4px; text-align: center; font-weight: bold; }
                .word-table td { border: 1px solid #999; padding: 4px; vertical-align: top; }
                .word-img { width: 40px; height: 40px; object-fit: contain; }
                .bg-scheme, .bg-fee, .bg-payment-plan, .bg-payment-info, .bg-important { padding: 2px 4px; margin: 2px 0; }
                .total-red { color: #C00000; font-weight: bold; }
                .footer { margin-top: 8px; text-align: center; color: #999; font-size: 8pt; border-top: 1px solid #eee; padding-top: 3px; }
            </style>
            </head>
            <body>
            <h1>ğŸ“„ å•†æ ‡ç”³è¯·è®¢å•</h1>
            
            <h2>ä¸€ã€åŸºæœ¬ä¿¡æ¯</h2>
            <table class="info-table">
                <tr><td>ç”³è¯·äººå…¨ç§°ï¼š</td><td>${escapeHtml(applicant)}</td></tr>
                <tr><td>å•†æ ‡åç§°ï¼š</td><td>${escapeHtml(tmName)}</td></tr>
                <tr><td>è”ç³»ç”µè¯ï¼š</td><td>${escapeHtml(phone || 'æœªå¡«å†™')}</td></tr>
                <tr><td>è”ç³»äººå§“åï¼š</td><td>${escapeHtml(contact || 'æœªå¡«å†™')}</td></tr>
                <tr><td>ä¸‹è®¢å•æ—¥æœŸï¼š</td><td>${today}</td></tr>
                <tr><td>æœåŠ¡æ–¹æ¡ˆï¼š</td><td>${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}</td></tr>
                <tr><td>æ–¹æ¡ˆæè¿°ï¼š</td><td>${d.scheme === 'A' ? 'é€‚åˆéœ€æ±‚ï¼šæ‚¨æ‡‚å•†æ ‡ä½†äº‹åŠ¡ç¹å¿™ï¼Ÿæµç¨‹è·Ÿè¿›å¸®æ‚¨çœå¿ƒçœåŠ›ã€‚æœåŠ¡å†…å®¹ï¼šææ–™å½¢å¼å®¡æ ¸ã€å®˜æ–¹æ–‡ä»¶ä»£æ”¶ä»£å‘ã€å…³é”®èŠ‚ç‚¹äººå·¥æé†’ã€å…¨æµç¨‹è¿›åº¦åŒæ­¥ã€‚' : d.scheme === 'B' ? 'é€‚åˆéœ€æ±‚ï¼šå¸Œæœ›æå‡å•†æ ‡æ³¨å†Œè§„èŒƒæ€§ï¼Ÿä¸“ä¸šè¾…å¯¼ä¸ºæ‚¨ä¿é©¾æŠ¤èˆªã€‚æœåŠ¡å†…å®¹ï¼šæ³¨å†Œå‰é£é™©è¯„ä¼°ã€ç±»åˆ«è§„åˆ’å»ºè®®ã€ç”³è¯·ææ–™ä¼˜åŒ–ã€ä¸“ä¸šè§£è¯»ä¸æŒ‡å¯¼ã€‚' : 'é€‚åˆéœ€æ±‚ï¼šæ‹…å¿ƒæ³¨å†Œä¸ä¸‹æ¥ï¼ŒæœåŠ¡è´¹ç™½ç»™ï¼Ÿåç½®ä»˜è´¹è®©æ‚¨æ›´ä»å®¹ã€‚æœåŠ¡å†…å®¹ï¼šå¯åŠ¨æˆæœ¬æ›´ä½ï¼Œä»…ä»˜å®˜è´¹ï¼›ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åå†ä»˜æœåŠ¡è´¹ï¼'}</td></tr>
                <tr><td>ä¸“ç¥¨é€‰é¡¹ï¼š</td><td>${d.withInvoice ? 'âœ“ æ˜¯ï¼ˆåŠ æ”¶5%ï¼‰' : 'âœ— å¦'}</td></tr>
                <tr><td>å•†æ ‡å›¾æ ·ï¼š</td><td>${trademarkImageData ? 'âœ“ å·²ä¸Šä¼ ' : 'âœ— æœªä¸Šä¼ '}</td></tr>
                <tr><td>å·²é€‰å¤§ç±»æ•°é‡ï¼š</td><td>${stats.majorCount}</td></tr>
                <tr><td>å·²é€‰å°ç±»æ€»æ•°ï¼š</td><td>${stats.totalSubCount}</td></tr>
            </table>

            <h2>äºŒã€å·²é€‰ç±»åˆ«æ˜ç»†</h2>
            <table class="word-table">
                <tr><th style="width:5%">åºå·</th><th style="width:15%">å•†æ ‡åç§°</th><th style="width:15%">å•†æ ‡å›¾æ ·</th><th style="width:10%">å·²é€‰å¤§ç±»</th><th>å°ç±»</th></tr>
            `;
            let idx = 1;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                const subText = selectedSubclasses[major].map(s => escapeHtml(s)).join('ï¼›');
                htmlContent += `<tr>
                    <td style="text-align: center;">${idx}</td>
                    <td style="text-align: center;">${escapeHtml(tmName)}</td>
                    <td style="text-align: center;">`;
                if (trademarkImageData) {
                    // æ·»åŠ å¯ç‚¹å‡»çš„ç¼©ç•¥å›¾é“¾æ¥ï¼Œç‚¹å‡»åœ¨æ–°çª—å£æŸ¥çœ‹åŸå›¾
                    htmlContent += `<a href="${trademarkImageData}" target="_blank"><img src="${trademarkImageData}" width="40" height="40" style="object-fit: contain;" alt="å•†æ ‡å›¾æ ·"></a><br><span style="font-size:8pt;">(ç‚¹å‡»æŸ¥çœ‹åŸå›¾)</span>`;
                } else {
                    htmlContent += `æ— å›¾æ ·`;
                }
                htmlContent += `</td>
                    <td style="text-align: center;">${escapeHtml(major)}</td>
                    <td>${subText}</td>
                </tr>`;
                idx++;
            }
            htmlContent += `</table>`;

            htmlContent += `<h2>ä¸‰ã€è´¹ç”¨æ˜ç»†</h2>`;
            htmlContent += `<div class="bg-scheme">=== æœåŠ¡æ–¹æ¡ˆ: ${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)} ===</div>`;
            htmlContent += `<div>ğŸ’° åŸºç¡€ä»·æ ¼ï¼šæ¯å¤§ç±»${d.params.base}å…ƒï¼ˆå«10ä¸ªå°ç±»ï¼‰ï¼Œè¶…å‡ºéƒ¨åˆ†${d.params.extra}å…ƒ/å°ç±»ã€‚</div>`;
            if (d.scheme === 'A') htmlContent += `<div>Aæ–¹æ¡ˆæš‚æ— å¤§å®¢æˆ·ä¼˜æƒ ã€‚</div>`;
            if (d.scheme === 'B') htmlContent += `<div>ğŸ Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šä¸€æ¬¡æ€§ä¸‹å•å¤§ç±»ï¼6ä¸ªï¼Œæ€»é‡‘é¢ç«‹å‡15%ï¼</div>`;
            if (d.scheme === 'C') htmlContent += `<div>ğŸ Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šä¸€æ¬¡æ€§ä¸‹å•å¤§ç±»ï¼6ä¸ªï¼Œå°¾æ¬¾å‡å…15%ï¼</div>`;
            htmlContent += `<div>ğŸ’³ ä»˜æ¬¾æ–¹å¼: ${d.scheme === 'C' ? 'é¦–ä»˜300å…ƒ/å¤§ç±»å®˜è´¹ï¼Œå‰©ä½™å°¾æ¬¾å¾…ä¸‹è¯åæ”¯ä»˜' : 'ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…'}</div>`;

            htmlContent += `<div class="bg-fee">=== ğŸ’° è´¹ç”¨æ˜ç»† ===</div>`;
            for (const major in d.majorDetails) {
                htmlContent += `<div>ğŸ“Œ ${escapeHtml(major)}å¤§ç±»ï¼ˆ${d.majorDetails[major].count}ä¸ªå°ç±»ï¼‰ = ${d.majorDetails[major].cost.toFixed(2)}å…ƒ</div>`;
            }
            htmlContent += `<div>ğŸ“Š å°è®¡ï¼ˆåŸä»·ï¼‰: ${d.totalOriginal.toFixed(2)}å…ƒ</div>`;
            if (d.discountNote) {
                htmlContent += `<div>ğŸ‰ ã€${d.discountNote}ã€‘</div>`;
                htmlContent += `<div>ğŸ“Š å°è®¡ï¼ˆä¼˜æƒ åï¼‰: ${d.finalTotal.toFixed(2)}å…ƒ</div>`;
            }
            if (d.withInvoice) {
                htmlContent += `<div>ğŸ§¾ ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰: ${d.invoiceAmount.toFixed(2)}å…ƒ</div>`;
                htmlContent += `<div class="total-red">ğŸ’ æ€»åˆè®¡ï¼ˆå«ä¸“ç¥¨ï¼‰: ${d.totalWithInvoice.toFixed(2)}å…ƒ</div>`;
            } else {
                htmlContent += `<div>ğŸ§¾ ä¸“ç¥¨è´¹ç”¨: 0å…ƒï¼ˆæœªé€‰æ‹©ï¼‰</div>`;
                htmlContent += `<div class="total-red">ğŸ’ æ€»åˆè®¡: ${d.finalTotal.toFixed(2)}å…ƒ</div>`;
            }

            if (d.scheme === 'C') {
                htmlContent += `<div class="bg-payment-plan">ã€Cæ–¹æ¡ˆÂ·åç½®ä»˜è´¹è®¡åˆ’ã€‘</div>`;
                const firstPay = d.majorCount * 300; // å®˜è´¹æ€»é¢
                const tailTotal = (d.withInvoice ? d.totalWithInvoice : d.finalTotal) - firstPay;
                htmlContent += `<div>ğŸ”¹ é¦–ä»˜æ¬¾ï¼ˆç­¾åˆåŒåï¼‰: å®˜è´¹éƒ¨åˆ† ${firstPay.toFixed(2)}å…ƒ</div>`;
                htmlContent += `<div>ğŸ”¹ å°¾æ¬¾æ€»é¢ï¼ˆä¸‹è¯åæ”¯ä»˜ï¼‰: ${tailTotal.toFixed(2)}å…ƒï¼Œå„å¤§ç±»æŒ‰è´¹ç”¨æ¯”ä¾‹åˆ†æ‘Šã€‚</div>`;
                let subIdx = 1;
                for (const major in d.majorDetails) {
                    const majorCost = d.majorDetails[major].cost;
                    const majorWithInvoice = d.withInvoice ? majorCost * 1.05 : majorCost;
                    // ä¼˜æƒ åè¯¥å¤§ç±»å æ€»ä»·çš„æ¯”ä¾‹ï¼Œç”¨äºåˆ†æ‘Šå°¾æ¬¾
                    const ratio = majorWithInvoice / (d.withInvoice ? d.totalWithInvoice : d.finalTotal);
                    const tail = tailTotal * ratio;
                    const circleNum = getCircledNumber(subIdx);
                    htmlContent += `<div>   ${circleNum} ${escapeHtml(major)}å¤§ç±»å°¾æ¬¾ï¼š${tail.toFixed(2)}å…ƒ</div>`;
                    subIdx++;
                }
            } else {
                htmlContent += `<div class="bg-payment-plan">ã€${escapeHtml(d.scheme)}æ–¹æ¡ˆÂ·ä»˜æ¬¾è®¡åˆ’ã€‘</div>`;
                const payAmount = d.withInvoice ? d.totalWithInvoice : d.finalTotal;
                htmlContent += `<div>ğŸ“… ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…: ${payAmount.toFixed(2)}å…ƒ</div>`;
            }

            htmlContent += `<div class="bg-payment-info">=== ğŸ’³ ä»˜æ¬¾ä¿¡æ¯ ===</div>`;
            htmlContent += `<div>è´¦æˆ·åç§°ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</div>`;
            htmlContent += `<div>è´¦æˆ·å·ç ï¼š4405 0158 0107 0000 4275</div>`;
            htmlContent += `<div>å¼€æˆ·é“¶è¡Œï¼šä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸å¹¿å·èŠ±åŸæ”¯è¡Œ</div>`;
            htmlContent += `<div class="bg-important">ã€ğŸ“Œ é‡è¦æç¤ºã€‘</div>`;
            htmlContent += `<div>1. ä¸‹å•åè¯·å°†ä»˜æ¬¾æ°´å•æˆªå›¾å‘ç»™é™ˆå·¥</div>`;
            htmlContent += `<div>2. å› æˆ‘ä»¬æ˜¯æä¾›çŸ¥è¯†æœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡åä¸æ”¯æŒé€€æ¬¾</div>`;
            htmlContent += `<div>3. å¦‚æœ‰ç–‘é—®è¯·è”ç³»é™ˆå·¥ï¼š13128311370</div>`;

            htmlContent += `<h2>å››ã€å•†æ ‡å›¾æ ·</h2>`;
            if (trademarkImageData) {
                htmlContent += `<a href="${trademarkImageData}" target="_blank"><img src="${trademarkImageData}" width="40" height="40" style="object-fit: contain; border: 1px solid #ccc; border-radius: 2px;" /></a> (ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹åŸå›¾)<br>`;
                htmlContent += `<div>ğŸ“ æ–‡ä»¶: å·²ä¸Šä¼ å›¾ç‰‡</div>`;
            } else {
                htmlContent += `<div>âš ï¸ æœªä¸Šä¼ å•†æ ‡å›¾æ ·</div>`;
            }

            htmlContent += `<h2>äº”ã€å”®å‰å’¨è¯¢</h2>`;
            htmlContent += `<div>å¦‚æœ‰ç–‘é—®ï¼Œè”ç³»é™ˆå·¥ï¼Œä¸“ä¸šé¡¾é—®ä¸ºæ‚¨æœåŠ¡ï¼š</div>`;
            htmlContent += `<div>ğŸ“± å¾®ä¿¡ï¼šæ‰«ç æ·»åŠ </div>`;
            htmlContent += `<div>ğŸ“ ç”µè¯ï¼š13128311370</div>`;
            htmlContent += `<div>ğŸ•’ æœåŠ¡æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-18:00</div>`;
            htmlContent += `<div style="margin-top: 5px;">[è”ç³»é™ˆå·¥å¾®ä¿¡äºŒç»´ç ]</div>`;

            htmlContent += `
            <div class="footer">
                æœ¬è®¢å•ç”±ä¼ä¼˜å’¨å•†æ ‡ç”³è¯·ç³»ç»Ÿç”Ÿæˆ Â· å’¨è¯¢çƒ­çº¿ï¼š13128311370
            </div>
            </body></html>`;

            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å•†æ ‡è®¢å•_${applicant}_${tmName}.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('exportWordBtn').addEventListener('click', exportWord);

        // ==================== ç”ŸæˆåˆåŒï¼ˆä¼˜åŒ–ç‰ˆï¼Œå›¾ç‰‡ç¼©ç•¥å›¾+ç‚¹å‡»æŸ¥çœ‹åŸå›¾ï¼‰ ====================
        function generateContract() {
            const applicant = cleanInput(document.getElementById('applicantName').value);
            const tmName = cleanInput(document.getElementById('trademarkName').value);
            const phone = cleanInput(document.getElementById('contactPhone').value);
            const contact = cleanInput(document.getElementById('contactPerson').value);

            if (!applicant || !tmName) {
                alert('è¯·å¡«å†™ç”³è¯·äººå…¨ç§°å’Œå•†æ ‡åç§°');
                return;
            }
            
            const stats = getSelectedStats();
            if (stats.totalSubCount === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°ç±»');
                return;
            }

            const d = computeFeeDetails();
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            const contractNo = `QYZ-TM-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`;

            let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='UTF-8'><title>å•†æ ‡ç”³è¯·ä»£ç†æœåŠ¡åˆåŒ</title>
            <style>
                body { font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif; margin: 0.6cm; font-size: 10.5pt; line-height: 1.2; color: #333; }
                h1 { text-align: center; color: #003d7c; font-size: 16pt; margin: 0 0 4px; }
                .contract-no { text-align: center; color: #666; margin: 0 0 4px; font-size: 9pt; }
                h2 { color: #1f3a5f; font-size: 11pt; margin: 6px 0 3px; border-bottom: 1px solid #003d7c; padding-bottom: 2px; }
                .party { margin: 2px 0; }
                .party-title { font-weight: bold; color: #003d7c; }
                p { margin: 0 0 2px; }
                div { margin: 0 0 2px; }
                table { border-collapse: collapse; width: 100%; margin: 4px 0; font-size: 10pt; }
                th, td { border: 1px solid #333; padding: 4px; vertical-align: top; }
                th { background: #e8e8e8; text-align: center; }
                .highlight { background: #fffbeb; padding: 2px 4px; border-left: 3px solid #f59e0b; margin: 2px 0; }
                .underline-red { text-decoration: underline; color: red; }
                .signature-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                .signature-table td { border: none; padding: 4px 8px; vertical-align: bottom; }
                .signature-line { border-bottom: 1px solid #000; height: 20px; width: 100%; }
                .total-row { font-weight: bold; color: #C00000; background: #f0f0f0; }
                .bg-payment-plan { background-color: #FFF2CC; padding: 2px 4px; }
                .bg-payment-info { background-color: #E6E6FA; padding: 2px 4px; }
                .word-img { width: 40px; height: 40px; object-fit: contain; }
            </style>
            </head>
            <body>
            <h1>ğŸ“ å•†æ ‡ç”³è¯·ä»£ç†æœåŠ¡åˆåŒ</h1>
            <div class="contract-no">åˆåŒç¼–å·ï¼š${contractNo} &nbsp;&nbsp;&nbsp; ç­¾è®¢æ—¥æœŸï¼š${today}</div>

            <h2>ç¬¬ä¸€æ¡ ç”²æ–¹ï¼ˆå§”æ‰˜äººä¿¡æ¯ï¼‰</h2>
            <div class="party">
                <div><span class="party-title">å…¬å¸åç§°/ä¸ªäººå§“åï¼š</span>${escapeHtml(applicant)}</div>
                <div><span class="party-title">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /èº«ä»½è¯å·ç ï¼š</span><span class="underline-red">ï¼ˆå¡«å†™è¯¦ç»†ï¼‰</span></div>
                <div><span class="party-title">å·¥å•†æ³¨å†Œåœ°å€/èº«ä»½è¯åœ°å€ï¼š</span><span class="underline-red">ï¼ˆå¡«å†™è¯¦ç»†ï¼‰</span></div>
                <div><span class="party-title">è”ç³»äººï¼š</span>${escapeHtml(contact || '____________________')}</div>
                <div><span class="party-title">ç”µè¯å·ç ï¼š</span>${escapeHtml(phone || '____________________')}</div>
            </div>

            <h2>ç¬¬äºŒæ¡ ä¹™æ–¹ï¼ˆå—æ‰˜äººä¿¡æ¯ï¼‰</h2>
            <div class="party">
                <div><span class="party-title">å…¬å¸åç§°ï¼š</span>ä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</div>
                <div><span class="party-title">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š</span>91440111MADMM9PF77</div>
                <div><span class="party-title">æ³¨å†Œåœ°å€ï¼š</span>å¹¿å·å¸‚å¤©æ²³åŒºä½“è‚²ä¸œè·¯140-148å·2204æˆ¿B51å®¤</div>
                <div><span class="party-title">è”ç³»äººï¼š</span>é™ˆç„•æ³½</div>
                <div><span class="party-title">ç”µè¯å·ç ï¼š</span>13128311370</div>
            </div>

            <p>æ ¹æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹ã€ã€Šä¸­åäººæ°‘å…±å’Œå›½å•†æ ‡æ³•ã€‹ç­‰ç›¸å…³æ³•å¾‹æ³•è§„ï¼Œç”²ä¹™åŒæ–¹æœ¬ç€å¹³ç­‰è‡ªæ„¿ã€è¯šå®ä¿¡ç”¨çš„åŸåˆ™ï¼Œç»å‹å¥½åå•†ï¼Œå°±ç”²æ–¹å§”æ‰˜ä¹™æ–¹ä»£ç†å•†æ ‡ç”³è¯·äº‹å®œï¼Œè¾¾æˆå¦‚ä¸‹åè®®ï¼š</p>

            <h2>ç¬¬ä¸‰æ¡ å§”æ‰˜äº‹é¡¹</h2>
            <p>3.1 ç”²æ–¹å§”æ‰˜ä¹™æ–¹å°±ä»¥ä¸‹å•†æ ‡å‘å›½å®¶çŸ¥è¯†äº§æƒå±€å•†æ ‡å±€ç”³è¯·å•†æ ‡æ³¨å†Œäº‹é¡¹ï¼Œå…·ä½“ç”³è¯·ç±»åˆ«æ˜ç»†å¦‚ä¸‹ï¼š</p>
            <div><span class="party-title">å•†æ ‡ç”³è¯·ä¸»ä½“ï¼š</span>${escapeHtml(applicant)}</div>
            <div><span class="party-title">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š</span><span class="underline-red">ï¼ˆå¡«å†™è¯¦ç»†ï¼‰</span></div>
            <div><span class="party-title">å•†æ ‡æ³¨å†Œåœ°å€ï¼š</span><span class="underline-red">ï¼ˆå¡«å†™è¯¦ç»†ï¼‰</span></div>

            <h3>å·²é€‰ç±»åˆ«æ˜ç»†</h3>
            <table>
                <tr><th style="width:5%">åºå·</th><th style="width:15%">å•†æ ‡åç§°</th><th style="width:15%">å•†æ ‡å›¾æ ·</th><th style="width:10%">å·²é€‰å¤§ç±»</th><th>å°ç±»</th></tr>
            `;
            let idx = 1;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                const subText = selectedSubclasses[major].map(s => escapeHtml(s)).join('ï¼›');
                htmlContent += `<tr>
                    <td style="text-align: center;">${idx}</td>
                    <td style="text-align: center;">${escapeHtml(tmName)}</td>
                    <td style="text-align: center;">`;
                if (trademarkImageData) {
                    // æ·»åŠ å¯ç‚¹å‡»çš„ç¼©ç•¥å›¾é“¾æ¥ï¼Œç‚¹å‡»åœ¨æ–°çª—å£æŸ¥çœ‹åŸå›¾
                    htmlContent += `<a href="${trademarkImageData}" target="_blank"><img src="${trademarkImageData}" width="40" height="40" style="object-fit: contain;" alt="å•†æ ‡å›¾æ ·"></a><br><span style="font-size:8pt;">(ç‚¹å‡»æŸ¥çœ‹åŸå›¾)</span>`;
                } else {
                    htmlContent += `æ— å›¾æ ·`;
                }
                htmlContent += `</td>
                    <td style="text-align: center;">${escapeHtml(major)}</td>
                    <td>${subText}</td>
                </tr>`;
                idx++;
            }
            htmlContent += `</table>`;

            htmlContent += `
            <h2>ç¬¬å››æ¡ æœåŠ¡æ–¹æ¡ˆåŠè´¹ç”¨</h2>
            <p>4.1 ç”²æ–¹é€‰æ‹©ä¹™æ–¹æä¾›çš„ã€${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}ã€‘æœåŠ¡ã€‚</p>
            <p>    æ–¹æ¡ˆæè¿°ï¼š${d.scheme === 'A' ? 'é€‚åˆéœ€æ±‚ï¼šæ‚¨æ‡‚å•†æ ‡ä½†äº‹åŠ¡ç¹å¿™ï¼Ÿæµç¨‹è·Ÿè¿›å¸®æ‚¨çœå¿ƒçœåŠ›ã€‚æœåŠ¡å†…å®¹ï¼šææ–™å½¢å¼å®¡æ ¸ã€å®˜æ–¹æ–‡ä»¶ä»£æ”¶ä»£å‘ã€å…³é”®èŠ‚ç‚¹äººå·¥æé†’ã€å…¨æµç¨‹è¿›åº¦åŒæ­¥ã€‚' : d.scheme === 'B' ? 'é€‚åˆéœ€æ±‚ï¼šå¸Œæœ›æå‡å•†æ ‡æ³¨å†Œè§„èŒƒæ€§ï¼Ÿä¸“ä¸šè¾…å¯¼ä¸ºæ‚¨ä¿é©¾æŠ¤èˆªã€‚æœåŠ¡å†…å®¹ï¼šæ³¨å†Œå‰é£é™©è¯„ä¼°ã€ç±»åˆ«è§„åˆ’å»ºè®®ã€ç”³è¯·ææ–™ä¼˜åŒ–ã€ä¸“ä¸šè§£è¯»ä¸æŒ‡å¯¼ã€‚' : 'é€‚åˆéœ€æ±‚ï¼šæ‹…å¿ƒæ³¨å†Œä¸ä¸‹æ¥ï¼ŒæœåŠ¡è´¹ç™½ç»™ï¼Ÿåç½®ä»˜è´¹è®©æ‚¨æ›´ä»å®¹ã€‚æœåŠ¡å†…å®¹ï¼šå¯åŠ¨æˆæœ¬æ›´ä½ï¼Œä»…ä»˜å®˜è´¹ï¼›ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åå†ä»˜æœåŠ¡è´¹ï¼'}</p>
            <p>4.2 æœåŠ¡è´¹ç”¨è®¡ç®—æ ‡å‡†è¡¨ï¼š</p>

            <table>
                <tr><th>åºå·</th><th>å·²é€‰å¤§ç±»</th><th>å°ç±»æ•°é‡</th><th>è´¹ç”¨ï¼ˆå…ƒï¼‰</th></tr>
            `;
            let rowIdx = 1;
            for (const major in d.majorDetails) {
                htmlContent += `<tr>
                    <td style="text-align: center;">${rowIdx}</td>
                    <td>${escapeHtml(major)}</td>
                    <td style="text-align: center;">${d.majorDetails[major].count}</td>
                    <td style="text-align: right;">${d.majorDetails[major].cost.toFixed(2)}</td>
                </tr>`;
                rowIdx++;
            }

            htmlContent += `<tr>
                <td colspan="2" style="text-align: right; font-weight: bold;">å°è®¡ï¼ˆåŸä»·ï¼‰ï¼š</td>
                <td style="text-align: center;">${stats.totalSubCount}</td>
                <td style="text-align: right;">${d.totalOriginal.toFixed(2)}</td>
            </tr>`;

            if (d.discountNote) {
                htmlContent += `<tr>
                    <td colspan="3" style="text-align: right; color: green;">${escapeHtml(d.discountNote)}</td>
                    <td style="text-align: right;">-${(d.totalOriginal - d.finalTotal).toFixed(2)}</td>
                </tr>`;
            }

            if (d.withInvoice) {
                htmlContent += `<tr>
                    <td colspan="3" style="text-align: right;">ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰</td>
                    <td style="text-align: right;">${d.invoiceAmount.toFixed(2)}</td>
                </tr>`;
            }

            htmlContent += `</table>`;

            const totalAmount = (d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2);
            htmlContent += `<p style="font-weight: bold; color: #C00000; margin:2px 0;">åˆåŒæ€»é‡‘é¢ï¼š${totalAmount} å…ƒ${d.withInvoice ? 'ï¼ˆå«ä¸“ç¥¨ï¼‰' : ''}</p>`;

            htmlContent += `<h2>ç¬¬äº”æ¡ ä»˜æ¬¾æ–¹å¼</h2>`;
            if (d.scheme === 'C') {
                const firstPay = d.majorCount * 300; // å®˜è´¹æ€»é¢
                const tailTotal = (d.withInvoice ? d.totalWithInvoice : d.finalTotal) - firstPay;
                htmlContent += `<p>5.1 ç”²æ–¹é€‰æ‹©Cæ–¹æ¡ˆÂ·åç½®ä»˜è´¹æœåŠ¡ï¼Œä»˜æ¬¾æ–¹å¼å¦‚ä¸‹ï¼š</p>`;
                htmlContent += `<p>   åˆåŒæ€»é‡‘é¢ï¼š${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}å…ƒ${d.withInvoice ? 'ï¼ˆå«ä¸“ç¥¨ï¼‰' : ''}</p>`;
                htmlContent += `<p>   <strong>é¦–ä»˜æ¬¾</strong>ï¼ˆåˆåŒç­¾è®¢å3ä¸ªå·¥ä½œæ—¥å†…ï¼‰ï¼šå®˜è´¹éƒ¨åˆ† ${firstPay.toFixed(2)}å…ƒ</p>`;
                htmlContent += `<p>   <strong>å°¾æ¬¾æ”¯ä»˜ï¼š</strong>æ¯å½“æœ‰ä¸€ä¸ªå¤§ç±»ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åï¼Œç”²æ–¹åº”åœ¨æ”¶åˆ°ä¹™æ–¹é€šçŸ¥ä¹‹æ—¥èµ·3ä¸ªå·¥ä½œæ—¥å†…æ”¯ä»˜è¯¥å¤§ç±»çš„å°¾æ¬¾ã€‚å„å¤§ç±»å°¾æ¬¾æŒ‰è´¹ç”¨æ¯”ä¾‹åˆ†æ‘Šï¼Œå…·ä½“é‡‘é¢å¦‚ä¸‹ï¼š</p>`;
                let subIdx = 1;
                for (const major in d.majorDetails) {
                    const majorCost = d.majorDetails[major].cost;
                    const majorWithInvoice = d.withInvoice ? majorCost * 1.05 : majorCost;
                    const ratio = majorWithInvoice / (d.withInvoice ? d.totalWithInvoice : d.finalTotal);
                    const tail = tailTotal * ratio;
                    const circle = getCircledNumber(subIdx);
                    htmlContent += `<p>   ${circle} ${escapeHtml(major)}å¤§ç±»<strong>å°¾æ¬¾</strong>ï¼š${tail.toFixed(2)}å…ƒ</p>`;
                    subIdx++;
                }
            } else {
                htmlContent += `<p>5.1 ç”²æ–¹é€‰æ‹©${escapeHtml(d.scheme)}æ–¹æ¡ˆÂ·${escapeHtml(d.params.name)}æœåŠ¡ï¼Œä»˜æ¬¾æ–¹å¼å¦‚ä¸‹ï¼š</p>`;
                htmlContent += `<p>   åˆåŒæ€»é‡‘é¢ï¼š${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}å…ƒ</p>`;
                htmlContent += `<p>   ç”²æ–¹åº”äºæœ¬åˆåŒç­¾è®¢ä¹‹æ—¥èµ·3ä¸ªå·¥ä½œæ—¥å†…ï¼Œå°†åˆåŒæ€»é‡‘é¢ä¸€æ¬¡æ€§æ”¯ä»˜è‡³ä¹™æ–¹æŒ‡å®šè´¦æˆ·ã€‚</p>`;
            }

            htmlContent += `
            <p>5.2 ä¹™æ–¹æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯ï¼š</p>
            <p>   è´¦æˆ·åç§°ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</p>
            <p>   è´¦æˆ·å·ç ï¼š4405 0158 0107 0000 4275</p>
            <p>   å¼€æˆ·é“¶è¡Œï¼šä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸å¹¿å·èŠ±åŸæ”¯è¡Œ</p>
            <p>   ${d.withInvoice ? 'ç”²æ–¹å‘é€ç»™ä¹™æ–¹ä»˜æ¬¾æ°´å•åï¼Œä¹™æ–¹åº”åœ¨3ä¸ªå·¥ä½œæ—¥å†…ï¼Œå‘ç”²æ–¹å¼€å…·ç¥¨é¢ç¨ç‡ä¸º1%çš„å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ã€‚' : 'ç”²æ–¹å‘é€ç»™ä¹™æ–¹ä»˜æ¬¾æ°´å•åï¼Œä¹™æ–¹åº”åœ¨3ä¸ªå·¥ä½œæ—¥å†…ï¼Œå‘ç”²æ–¹å¼€å…·ç¥¨é¢ç¨ç‡ä¸º1%çš„å¢å€¼ç¨æ™®é€šå‘ç¥¨ã€‚'}</p>

            <h2>ç¬¬å…­æ¡ åŒæ–¹æƒåˆ©ä¹‰åŠ¡</h2>
            <p>6.1 ç”²æ–¹æƒåˆ©ä¹‰åŠ¡ï¼š</p>
            <p>   ï¼ˆ1ï¼‰ç”²æ–¹åº”ä¿è¯æä¾›çš„å•†æ ‡å›¾æ ·ã€ç”³è¯·äººä¿¡æ¯ç­‰èµ„æ–™çš„çœŸå®æ€§ã€åˆæ³•æ€§ï¼Œä¸å¾—å­˜åœ¨æ¶æ„ç”³è¯·ã€è¹­çƒ­åº¦ç­‰è¿èƒŒå…¬åºè‰¯ä¿—çš„è¡Œä¸ºï¼›</p>
            <p>   ï¼ˆ2ï¼‰ç”²æ–¹åº”æŒ‰çº¦å®šåŠæ—¶æ”¯ä»˜æœåŠ¡è´¹ç”¨ï¼›</p>
            <p>   ï¼ˆ3ï¼‰ç”²æ–¹åº”é…åˆä¹™æ–¹å®Œæˆå•†æ ‡ç”³è¯·æ‰€éœ€ææ–™çš„å‡†å¤‡å’Œæäº¤ï¼›</p>
            <p>   ï¼ˆ4ï¼‰ç”²æ–¹æœ‰æƒéšæ—¶äº†è§£å•†æ ‡ç”³è¯·è¿›å±•æƒ…å†µã€‚</p>
            <p>   ï¼ˆ5ï¼‰é‰´äºä¹™æ–¹æä¾›çš„æœåŠ¡ä¸ºçŸ¥è¯†æœåŠ¡ï¼Œå…·æœ‰ä¸å¯é€†æ€§ï¼Œè‡ªæœåŠ¡å¯åŠ¨ä¹‹æ—¥èµ·ï¼Œç”²æ–¹ä¸å¾—ä»¥ä»»ä½•ç†ç”±è¦æ±‚é€€æ¬¾ã€‚</p>
            <p>6.2 ä¹™æ–¹æƒåˆ©ä¹‰åŠ¡ï¼š</p>
            <p>   ï¼ˆ1ï¼‰ä¹™æ–¹åº”æŒ‰ç…§ä¸“ä¸šæ ‡å‡†å’Œè¡Œä¸šæƒ¯ä¾‹ä¸ºç”²æ–¹æä¾›å§”æ‰˜äº‹é¡¹æœåŠ¡ï¼›</p>
            <p>   ï¼ˆ2ï¼‰ä¹™æ–¹åº”åŠæ—¶å‘ç”²æ–¹æŠ¥å‘Šå•†æ ‡ç”³è¯·è¿›å±•æƒ…å†µï¼›</p>
            <p>   ï¼ˆ3ï¼‰ä¹™æ–¹åº”å¯¹ç”²æ–¹çš„å•†ä¸šç§˜å¯†å’Œå•†æ ‡ä¿¡æ¯äºˆä»¥ä¿å¯†ï¼›</p>
            <p>   ï¼ˆ4ï¼‰å•†æ ‡ç”³è¯·äº‹é¡¹èƒ½å¦æ ¸å‡†ç”±å›½å®¶çŸ¥è¯†äº§æƒå±€å•†æ ‡å±€ä¾æ³•å®¡æŸ¥å†³å®šï¼Œä¹™æ–¹ä¸æ‰¿è¯ºç”³è¯·ç»“æœã€‚</p>

            <h2>ç¬¬ä¸ƒæ¡ è¿çº¦è´£ä»»</h2>
            <p>7.1 ç”²æ–¹æœªæŒ‰çº¦å®šæ”¯ä»˜è´¹ç”¨çš„ï¼Œæ¯é€¾æœŸä¸€æ—¥ï¼Œåº”æŒ‰åº”ä»˜æœªä»˜é‡‘é¢çš„åƒåˆ†ä¹‹äº”å‘ä¹™æ–¹æ”¯ä»˜è¿çº¦é‡‘ã€‚</p>
            <p>7.2 å› ç”²æ–¹æä¾›çš„èµ„æ–™ä¸çœŸå®ã€ä¸å®Œæ•´æˆ–ä¸åˆæ³•å¯¼è‡´å•†æ ‡ç”³è¯·è¢«é©³å›æˆ–äº§ç”Ÿå…¶ä»–æŸå¤±çš„ï¼Œç”±ç”²æ–¹è‡ªè¡Œæ‰¿æ‹…è´£ä»»ã€‚</p>
            <p>7.3 å› ä¹™æ–¹è¿‡é”™å¯¼è‡´ç”³è¯·å¤±è´¥æˆ–å»¶è¯¯çš„ï¼Œä¹™æ–¹åº”ç§¯æé‡‡å–è¡¥æ•‘æªæ–½ã€‚</p>
            <p>7.4 ä»»ä½•ä¸€æ–¹è¿åæœ¬åˆåŒçº¦å®šï¼Œç»™å¯¹æ–¹é€ æˆæŸå¤±çš„ï¼Œåº”æ‰¿æ‹…èµ”å¿è´£ä»»ï¼Œèµ”å¿é‡‘é¢ä»¥ä¸è¶…è¿‡æœ¬åˆåŒæ€»é‡‘é¢ä¸ºé™ã€‚</p>

            <h2>ç¬¬å…«æ¡ åˆåŒæœŸé™</h2>
            <p>8.1 æœ¬åˆåŒè‡ªåŒæ–¹ç­¾å­—ç›–ç« ä¹‹æ—¥èµ·ç”Ÿæ•ˆï¼Œè‡³æœ¬åˆåŒå§”æ‰˜äº‹é¡¹è·å¾—å›½å®¶çŸ¥è¯†äº§æƒå±€å•†æ ‡å±€æ ¸å‡†æˆ–è¢«é©³å›ä¹‹æ—¥ç»ˆæ­¢ã€‚å¦‚æœ‰å…¶å®ƒå§”æ‰˜äº‹é¡¹ï¼Œé¡»å¦å¤–ç­¾è®¢æœåŠ¡åˆåŒã€‚</p>
            <p>8.2 åˆåŒç»ˆæ­¢åï¼ŒåŒæ–¹ä¹‹é—´çš„æƒåˆ©ä¹‰åŠ¡å…³ç³»ç»ˆæ­¢ï¼Œä½†ä¿å¯†æ¡æ¬¾ã€è¿çº¦è´£ä»»æ¡æ¬¾ç­‰ä¸å› åˆåŒç»ˆæ­¢è€Œå¤±æ•ˆã€‚</p>

            <h2>ç¬¬ä¹æ¡ äº‰è®®è§£å†³</h2>
            <p>9.1 å› å±¥è¡Œæœ¬åˆåŒå‘ç”Ÿçš„äº‰è®®ï¼ŒåŒæ–¹åº”å‹å¥½åå•†è§£å†³ï¼›åå•†ä¸æˆçš„ï¼Œä»»ä½•ä¸€æ–¹å‡æœ‰æƒå‘ä¹™æ–¹æ‰€åœ¨åœ°äººæ°‘æ³•é™¢æèµ·è¯‰è®¼ã€‚</p>

            <h2>ç¬¬åæ¡ å…¶ä»–</h2>
            <p>10.1 æœ¬åˆåŒä¸€å¼ä¸¤ä»½ï¼Œç”²ä¹™åŒæ–¹å„æ‰§ä¸€ä»½ï¼Œå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ï¼ˆç”µå­æ–‡ä»¶æˆ–è€…æ‰«æä»¶åŒæ ·æœ‰æ•ˆï¼‰ã€‚</p>
            <p>10.2 æœ¬åˆåŒæœªå°½äº‹å®œï¼ŒåŒæ–¹å¯å¦è¡Œç­¾è®¢è¡¥å……åè®®ï¼Œè¡¥å……åè®®ä¸æœ¬åˆåŒå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ã€‚</p>
            <p>10.3 æœ¬åˆåŒå±¥è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚éœ€å˜æ›´åˆåŒå†…å®¹ï¼Œåº”ç»åŒæ–¹åå•†ä¸€è‡´å¹¶ç­¾è®¢ä¹¦é¢å˜æ›´åè®®ã€‚</p>

            <table class="signature-table">
                <tr>
                    <td style="width: 50%;">
                        <div><strong>ç”²æ–¹ï¼ˆç›–ç« ï¼‰ï¼š</strong></div>
                        <div class="signature-line"></div>
                        <div>æˆæƒä»£è¡¨ï¼š${escapeHtml(contact || '__________')}</div>
                    </td>
                    <td style="width: 50%;">
                        <div><strong>ä¹™æ–¹ï¼ˆç›–ç« ï¼‰ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</strong></div>
                        <div class="signature-line"></div>
                        <div>æˆæƒä»£è¡¨ï¼šé™ˆç„•æ³½</div>
                    </td>
                </tr>
            </table>
            <p style="text-align: center; margin-top: 8px;">ç­¾è®¢æ—¥æœŸï¼š${today}</p>

            </body></html>`;

            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å•†æ ‡åˆåŒ_${applicant}_${tmName}.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('generateContractBtn').addEventListener('click', generateContract);

        // é€‰é¡¹å¡åˆ‡æ¢ - ä¼˜åŒ–å¯è®¿é—®æ€§
        const tabOrder = document.getElementById('tabOrder');
        const tabFlow = document.getElementById('tabFlow');
        const orderPanel = document.getElementById('orderPanel');
        const flowPanel = document.getElementById('flowPanel');

        function switchTab(activeTab, inactiveTab, activePanel, inactivePanel) {
            activeTab.classList.add('active');
            activeTab.setAttribute('aria-selected', 'true');
            activeTab.setAttribute('tabindex', '0');
            inactiveTab.classList.remove('active');
            inactiveTab.setAttribute('aria-selected', 'false');
            inactiveTab.setAttribute('tabindex', '-1');
            
            activePanel.style.display = activePanel.id === 'orderPanel' ? 'grid' : 'block';
            inactivePanel.style.display = 'none';
            
            // ç„¦ç‚¹ç®¡ç†
            activeTab.focus();
        }

        tabOrder.addEventListener('click', function() {
            switchTab(tabOrder, tabFlow, orderPanel, flowPanel);
        });

        tabFlow.addEventListener('click', function() {
            switchTab(tabFlow, tabOrder, flowPanel, orderPanel);
        });

        // é”®ç›˜å¯¼èˆªæ”¯æŒ
        document.querySelector('.tab-bar').addEventListener('keydown', function(e) {
            const tabs = Array.from(this.querySelectorAll('.tab'));
            const currentIndex = tabs.findIndex(t => t.classList.contains('active'));
            
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                const nextIndex = (currentIndex + 1) % tabs.length;
                tabs[nextIndex].click();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                const prevIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                tabs[prevIndex].click();
            }
        });

        // å¯åŠ¨
        loadJSON();
    })();

    // ==================== æµç¨‹å›¾ç›¸å…³å‡½æ•° ====================
    
    function toggleFlowStep(element) {
        element.classList.toggle('completed');
        const isCompleted = element.classList.contains('completed');
        element.setAttribute('aria-pressed', isCompleted ? 'true' : 'false');
        const text = element.querySelector('.step-text');
        
        if (isCompleted) {
            text.classList.add('check-icon');
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            text.classList.remove('check-icon');
        }
        
        saveFlowState();
    }

    function toggleFlowStart() {
        const startBox = document.getElementById('flowStartBox');
        startBox.classList.toggle('completed');
        const isCompleted = startBox.classList.contains('completed');
        startBox.setAttribute('aria-pressed', isCompleted ? 'true' : 'false');
        saveFlowState();
    }

    function handleQRImageError(img) {
        img.style.display = 'none';
        const fallback = img.nextElementSibling;
        if (fallback) fallback.style.display = 'flex';
        console.warn('äºŒç»´ç å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
    }

    function handleQRImageLoad(img) {
        img.style.display = 'block';
        const fallback = img.nextElementSibling;
        if (fallback) fallback.style.display = 'none';
    }

    function saveFlowState() {
        const completedSteps = [];
        document.querySelectorAll('.flow-step.completed').forEach((step, index) => {
            completedSteps.push(index);
        });
        
        const startCompleted = document.querySelector('.start-box.completed') ? true : false;
        
        try {
            localStorage.setItem('trademarkFlowState', JSON.stringify({
                steps: completedSteps,
                start: startCompleted,
                timestamp: new Date().toISOString()
            }));
        } catch (e) {
            console.warn('æ— æ³•ä¿å­˜æµç¨‹çŠ¶æ€:', e);
        }
    }

    function restoreFlowState() {
        try {
            const saved = localStorage.getItem('trademarkFlowState');
            if (saved) {
                const state = JSON.parse(saved);
                const steps = document.querySelectorAll('.flow-step');
                
                state.steps.forEach(index => {
                    if (steps[index]) {
                        steps[index].classList.add('completed');
                        steps[index].setAttribute('aria-pressed', 'true');
                        steps[index].querySelector('.step-text').classList.add('check-icon');
                    }
                });
                
                if (state.start) {
                    const startBox = document.getElementById('flowStartBox');
                    if (startBox) {
                        startBox.classList.add('completed');
                        startBox.setAttribute('aria-pressed', 'true');
                    }
                }
            }
        } catch (e) {
            console.error('æ¢å¤çŠ¶æ€å¤±è´¥', e);
        }
    }

    // æµç¨‹æ­¥éª¤é”®ç›˜æ”¯æŒ
    document.addEventListener('DOMContentLoaded', function() {
        restoreFlowState();
        
        document.querySelectorAll('.flow-step, .start-box').forEach(el => {
            el.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    });
</script>
</body>
</html>
