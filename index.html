<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <meta name="description" content="ä¼ä¼˜å’¨å•†æ ‡ç”³è¯·ä¸‹å•ç³»ç»Ÿ - ä¸“ä¸šå•†æ ‡ä»£ç†æœåŠ¡">
    <meta name="keywords" content="å•†æ ‡ç”³è¯·,å•†æ ‡æ³¨å†Œ,ä¼ä¼˜å’¨,å•†æ ‡ä»£ç†">
    <link rel="icon" type="image/x-icon" href="ä¼ä¼˜å’¨å›¾æ ‡.ico">
    <title>ä¼ä¼˜å’¨ Â·å•†æ ‡ç”³è¯·ä¸‹å•ç³»ç»Ÿ</title>
    <style>
        /* ===== åŸºç¡€æ ·å¼ (å®Œå…¨ä¿ç•™åŸæ ·ï¼Œæœªæ”¹åŠ¨) ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'å®‹ä½“', SimSun, 'Times New Roman', serif;
        }
        
        :root {
            --primary: #003d7c;
            --primary-dark: #002856;
            --primary-light: #e8f0fe;
            --accent: #00c6ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-700);
            line-height: 1.5;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, #0066cc 100%);
            color: white;
            padding: 32px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .header-subtitle {
            margin-top: 12px;
            opacity: 0.9;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .header-contact {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .tab-bar {
            display: flex;
            background: white;
            padding: 0 12px;
            gap: 0;
            border-bottom: 2px solid var(--gray-100);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tab-bar::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 12px 14px;
            cursor: pointer;
            color: var(--gray-500);
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            white-space: nowrap;
            background: none;
            border: none;
            font-family: inherit;
        }
        
        .tab:hover {
            color: var(--primary);
            background: var(--gray-50);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-badge {
            background: var(--gray-200);
            color: var(--gray-600);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .tab.active .tab-badge {
            background: var(--primary);
            color: white;
        }
        
        .step-panel-container, .preview-panel-container, .flow-panel-container {
            padding: 32px;
            background: var(--gray-50);
            min-height: calc(100vh - 200px);
        }
        .step-panel-wrapper, .preview-wrapper, .flow-wrapper {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: clamp(20px, 5vw, 40px);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            overflow-x: hidden;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            will-change: transform, box-shadow;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(to right, white, var(--gray-50));
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-indicator {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .card-subtitle {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 6px;
            margin-left: 42px;
        }
        
        .card-body {
            padding: 20px 24px;
            flex: 1;
            overflow-y: auto;
        }
        
        .search-section { margin-bottom: 16px; }
        .search-box { position: relative; display: flex; gap: 12px; align-items: center; }
        .search-input-wrapper { position: relative; flex: 1; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
        .search-box input { width: 100%; padding: 14px 16px 14px 44px; border: 2px solid var(--gray-200); border-radius: 12px; }
        .search-stats { background: var(--primary-light); color: var(--primary); padding: 8px 16px; border-radius: 20px; }
        .tree-container { max-height: 480px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 16px; padding: 12px; }
        .tree-ul { list-style: none; padding-left: 0; }
        .tree-ul ul { display: none; margin-left: 12px; padding-left: 12px; border-left: 2px solid var(--gray-200); }
        .tree-ul li.expanded > ul { display: block; }
        .folder-label { cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 10px 12px; width: 100%; font-weight: 600; border-radius: 10px; background: none; border: none; text-align: left; }
        .folder-label:hover { background: var(--gray-50); }
        .folder-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--primary); transition: transform 0.2s; }
        li.expanded > .folder-label .folder-icon { transform: rotate(90deg); }
        .cat-major { background: linear-gradient(135deg, var(--primary-light) 0%, #dbeafe 100%); color: var(--primary-dark); padding: 12px 16px; border-radius: 12px; }
        .cat-group { color: var(--gray-700); padding: 8px 0 8px 8px; font-weight: 500; }
        .subclass-item { display: flex; align-items: center; gap: 12px; padding: 8px 12px 8px 32px; border-radius: 8px; cursor: pointer; }
        .subclass-item:hover { background: var(--primary-light); }
        .subclass-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
        .subclass-name { font-size: 0.9rem; color: var(--gray-600); }
        
        .selected-section { margin-bottom: 24px; }
        .section-label { font-size: 0.9rem; font-weight: 600; color: var(--gray-700); margin-bottom: 12px; display: flex; justify-content: space-between; }
        .selected-list { 
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto; 
            background: var(--gray-50); 
            border-radius: 16px; 
            padding: 16px; 
            border: 2px dashed var(--gray-300); 
        }
        .selected-list.has-items { border-style: solid; border-color: var(--primary-light); background: white; }
        .selected-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .selected-tag { background: white; border: 1px solid var(--primary-light); border-radius: 20px; padding: 6px 14px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; }
        .tag-major { font-weight: 700; color: var(--primary); }
        .tag-remove { cursor: pointer; color: var(--gray-400); background: none; border: none; font-size: 1.1rem; }
        .empty-state { text-align: center; color: var(--gray-400); padding: 20px; font-style: italic; }
        .form-section { margin-bottom: 20px; }
        .form-row { margin-bottom: 16px; }
        .form-row label { display: block; font-weight: 600; margin-bottom: 8px; }
        .required-star { color: var(--danger); }
        .form-row input { width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 12px; }
        .form-row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .upload-section { margin-top: 24px; }
        .upload-area { 
            border: 2px dashed var(--gray-300); 
            border-radius: 16px; 
            padding: 16px 20px;
            text-align: center; 
            background: var(--gray-50); 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .upload-area:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-icon { font-size: 1.8rem; margin-bottom: 4px; }
        .upload-text { font-weight: 600; margin-bottom: 4px; }
        .upload-hint { font-size: 0.8rem; color: var(--gray-500); }
        
        .preview-box { 
            margin-top: 16px; 
            border-radius: 16px; 
            overflow: hidden; 
            background: var(--gray-100); 
            min-height: 200px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #previewImg {
            width: 200px;
            height: 200px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        
        .scheme-panel { display: flex; flex-direction: column; gap: 12px; }
        .scheme-option { display: flex; align-items: flex-start; gap: 16px; padding: 20px; background: white; border-radius: 16px; border: 2px solid var(--gray-200); cursor: pointer; }
        .scheme-option.selected { border-color: var(--primary); background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
        .scheme-radio { width: 22px; height: 22px; accent-color: var(--primary); }
        .scheme-name { font-weight: 700; }
        .scheme-price { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; }
        .feature-tag { background: var(--gray-100); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; }
        .invoice-section { margin: 20px 0; padding: 16px; background: var(--gray-50); border-radius: 12px; }
        .legal-notice { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid var(--warning); border-radius: 12px; padding: 16px; }
        .fee-section { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; padding: 20px; margin: 20px 0; }
        .fee-amount { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .fee-details { font-size: 0.9rem; max-height: 300px; overflow-y: auto; }
        .button-group { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
        .btn { padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-secondary { background: white; border: 2px solid var(--gray-300); color: var(--gray-700); }
        .btn-row { display: flex; gap: 12px; }
        .btn-row .btn { flex: 1; }
        .footer-info { background: var(--gray-50); color: var(--gray-500); padding: 20px 40px; text-align: center; border-top: 1px solid var(--gray-200); }
        
        .step-footer-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 12px;
        }
        .step-footer-buttons {
            display: flex;
            gap: 12px;
        }
        .step-footer-btn {
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 600;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .step-footer-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .step-footer-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-save-draft {
            background: var(--gray-100);
            border: 1px dashed var(--gray-400);
        }
        .btn-save-draft:hover {
            background: var(--gray-200);
        }
        
        .flow-wrapper { max-width: 900px; margin: 0 auto; }
        .start-box { background: #f0f4f8; border: 2px solid var(--primary); border-radius: 12px; padding: clamp(20px,4vw,30px); text-align: center; cursor: pointer; transition: all 0.2s; }
        .start-box.completed { background: #d4edda; border-color: #28a745; }
        .qr-code { max-width: 120px; margin: 0 auto; display: block; }
        .arrow-down { text-align: center; font-size: 24px; color: var(--primary); margin: -15px 0 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(10px);} }
        .flow-container { position: relative; padding-left: 40px; }
        .flow-line { position: absolute; left: 15px; top: 0; bottom: 0; width: 4px; background: linear-gradient(to bottom, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff, #5f27cd, #00d2d3); }
        .flow-step { position: relative; margin-bottom: 25px; cursor: pointer; }
        .step-marker { position: absolute; left: -33px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: background 0.2s; }
        .step-content { background: #f8f9fa; border-radius: 12px; padding: 20px; border-left: 4px solid transparent; }
        .flow-step-1 .step-marker { background: #ff6b6b; }
        .flow-step-2 .step-marker { background: #feca57; }
        .flow-step-3 .step-marker { background: #48dbfb; }
        .flow-step-4 .step-marker { background: #ff9ff3; }
        .flow-step-5 .step-marker { background: #54a0ff; }
        .flow-step-6 .step-marker { background: #5f27cd; }
        .flow-step-7 .step-marker { background: #00d2d3; }
        .flow-step.completed .step-marker { background: #28a745 !important; }
        .check-icon::before { content: "âœ” "; color: #28a745; font-weight: bold; margin-right: 4px; }
        .start-box.completed .start-text::before { content: "âœ” "; color: #28a745; font-weight: bold; }
        .note { margin-left: 20px; margin-top: 8px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 3px solid #ffc107; }
        .footer-notice { margin-top: 30px; background: #1e8449; color: white; padding: 20px; border-radius: 12px; text-align: center; }
        
        @media (max-width: 768px) {
            body { padding: 0; }
            .app-container { border-radius: 0; }
            .header { padding: 24px 20px; }
            .tab { padding: 8px 10px; font-size: 0.9rem; }
            .tab-bar { padding: 0 8px; }
            .step-panel-container { padding: 20px; }
        }
        @media (max-width: 480px) {
            .tab { padding: 6px 8px; font-size: 0.85rem; }
            .tab-bar { padding: 0 5px; }
        }
    </style>
</head>
<body>
<div class="app-container">
    <header class="header" role="banner">
        <div class="header-content">
            <h1>
                <div class="header-icon" aria-hidden="true">â„¢</div>
                ä¼ä¼˜å’¨ Â·å•†æ ‡ç”³è¯·æ³¨å†Œä¸‹å•
            </h1>
            <div class="header-subtitle">
                <span>é€‰åˆ†ç±» â†’ å¡«ä¿¡æ¯ â†’ é€‰æ–¹æ¡ˆ â†’ é¢„è§ˆ â†’ ä»˜æ¬¾åæµç¨‹</span>
                <span class="header-contact">
                    <span aria-hidden="true">ğŸ“</span>
                    <span>å¦‚æœ‰åŒ…å¹´å®šåˆ¶åŒ–éœ€æ±‚ï¼Œè”ç³»é™ˆå·¥13128311370</span>
                </span>
            </div>
        </div>
    </header>

    <nav class="tab-bar" role="tablist" aria-label="ç³»ç»ŸåŠŸèƒ½å¯¼èˆª">
        <button type="button" class="tab active" id="tabStep1" role="tab" aria-selected="true" aria-controls="step1Panel" tabindex="0">ä¸€ã€é€‰åˆ†ç±»</button>
        <button type="button" class="tab" id="tabStep2" role="tab" aria-selected="false" aria-controls="step2Panel" tabindex="-1">äºŒã€å¡«ä¿¡æ¯</button>
        <button type="button" class="tab" id="tabStep3" role="tab" aria-selected="false" aria-controls="step3Panel" tabindex="-1">ä¸‰ã€é€‰æ–¹æ¡ˆ</button>
        <button type="button" class="tab" id="tabPreview" role="tab" aria-selected="false" aria-controls="previewPanel" tabindex="-1">å››ã€é¢„è§ˆè®¢å•</button>
        <button type="button" class="tab" id="tabFlow" role="tab" aria-selected="false" aria-controls="flowPanel" tabindex="-1">äº”ã€ä»˜æ¬¾åæµç¨‹</button>
    </nav>

    <!-- æ­¥éª¤1ï¼šé€‰æ‹©åˆ†ç±»é¢æ¿ -->
    <div id="step1Panel" class="step-panel-container" style="display: block;" role="tabpanel" aria-labelledby="tabStep1">
        <div class="step-panel-wrapper">
            <section class="card" aria-labelledby="step1-title">
                <div class="card-header">
                    <div class="card-title"><span class="step-indicator">1</span><span id="step1-title">é€‰æ‹©å•†æ ‡åˆ†ç±»</span></div>
                    <div class="card-subtitle">æœç´¢æˆ–æµè§ˆé€‰æ‹©æ‚¨éœ€è¦æ³¨å†Œçš„å•†å“/æœåŠ¡ç±»åˆ«</div>
                </div>
                <div class="card-body">
                    <div class="search-section">
                        <div class="search-box">
                            <div class="search-input-wrapper"><span class="search-icon">ğŸ”</span><input type="text" id="searchInput" placeholder="è¾“å…¥å¦‚â€œæœè£…â€ã€â€œç§‘æŠ€â€..." autocomplete="off" aria-label="æœç´¢å•†æ ‡åˆ†ç±»"></div>
                            <span class="search-stats" id="searchCount">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                    <div class="tree-container" id="treeContainer" role="tree" aria-label="å•†æ ‡åˆ†ç±»æ ‘">
                        <ul class="tree-ul" id="categoryTree"><li class="empty-state">æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®...</li></ul>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                        <button type="button" class="btn btn-secondary" id="clearSelectedBtn" style="padding: 10px 20px;"><span>ğŸ—‘ï¸</span><span>æ¸…ç©ºå·²é€‰</span></button>
                        <span class="search-stats" id="selectedCountBadge">å·²é€‰ 0 ä¸ªå°ç±»</span>
                    </div>
                    
                    <div class="step-footer-nav">
                        <span class="step-indicator-light">å½“å‰ï¼šé€‰åˆ†ç±»</span>
                        <div class="step-footer-buttons">
                            <button class="step-footer-btn btn-save-draft save-draft-btn" data-step="1">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
                            <button class="step-footer-btn step-next-btn" data-next="2">ä¸‹ä¸€æ­¥ â–¶</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- æ­¥éª¤2ï¼šå¡«å†™ä¿¡æ¯é¢æ¿ -->
    <div id="step2Panel" class="step-panel-container" style="display: none;" role="tabpanel" aria-labelledby="tabStep2">
        <div class="step-panel-wrapper">
            <section class="card" aria-labelledby="step2-title">
                <div class="card-header">
                    <div class="card-title"><span class="step-indicator">2</span><span id="step2-title">å¡«å†™ç”³è¯·ä¿¡æ¯</span></div>
                    <div class="card-subtitle">å®Œå–„ç”³è¯·äººèµ„æ–™ï¼Œä¸Šä¼ å•†æ ‡å›¾æ ·</div>
                </div>
                <div class="card-body">
                    <div class="selected-section">
                        <div class="section-label"><span>ğŸ“‹ å·²é€‰å°ç±»ï¼ˆç‚¹å‡»æ ‡ç­¾å¯åˆ é™¤ï¼‰</span></div>
                        <div class="selected-list" id="selectedListContainer">
                            <div class="empty-state" id="selectedEmpty">æš‚æ— é€‰æ‹©ï¼Œè¯·ä»å·¦ä¾§æ·»åŠ </div>
                            <div class="selected-tags" id="selectedTags" style="display: none;" role="list" aria-label="å·²é€‰å•†æ ‡å°ç±»"></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <div class="form-row">
                            <label for="applicantName">ç”³è¯·äººå…¨ç§° <span class="required-star">*</span></label>
                            <input type="text" id="applicantName" placeholder="è¯·è¾“å…¥è¥ä¸šæ‰§ç…§ä¸Šçš„å®Œæ•´åç§°" required autocomplete="organization">
                            <div class="form-hint">ä¸ªäººç”³è¯·è¯·å¡«å†™å§“åï¼Œå…¬å¸ç”³è¯·è¯·å¡«å†™å…¨ç§°</div>
                        </div>
                        <div class="form-row">
                            <label for="trademarkName">å•†æ ‡åç§° <span class="required-star">*</span></label>
                            <input type="text" id="trademarkName" placeholder="è¯·è¾“å…¥å•†æ ‡åç§°" required autocomplete="off">
                        </div>
                        <div class="form-row-grid">
                            <div class="form-row"><label for="contactPhone">è”ç³»ç”µè¯</label><input type="tel" id="contactPhone" placeholder="æ‰‹æœºå·ç " autocomplete="tel"></div>
                            <div class="form-row"><label for="contactPerson">è”ç³»äººå§“å</label><input type="text" id="contactPerson" placeholder="çœŸå®å§“å" autocomplete="name"></div>
                        </div>
                    </div>
                    
                    <div class="upload-section">
                        <div class="section-label" id="upload-label">ğŸ–¼ï¸ å•†æ ‡å›¾æ ·ï¼ˆå»ºè®®ä¸Šä¼ ï¼‰</div>
                        <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-labelledby="upload-label">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒ PNGã€JPG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 400Ã—400 ~ 1000Ã—1000 åƒç´ </div>
                            <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg" style="display: none;">
                        </div>
                        <div class="preview-box" id="imagePreview" style="display: none;" role="img" aria-label="å•†æ ‡å›¾æ ·é¢„è§ˆ">
                            <img id="previewImg" src="" alt="å•†æ ‡é¢„è§ˆ">
                        </div>
                    </div>

                    <div class="step-footer-nav">
                        <span class="step-indicator-light">å½“å‰ï¼šå¡«ä¿¡æ¯</span>
                        <div class="step-footer-buttons">
                            <button class="step-footer-btn step-prev-btn" data-prev="1">â—€ ä¸Šä¸€æ­¥</button>
                            <button class="step-footer-btn btn-save-draft save-draft-btn" data-step="2">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
                            <button class="step-footer-btn step-next-btn" data-next="3">ä¸‹ä¸€æ­¥ â–¶</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- æ­¥éª¤3ï¼šé€‰æ‹©æœåŠ¡æ–¹æ¡ˆé¢æ¿ -->
    <div id="step3Panel" class="step-panel-container" style="display: none;" role="tabpanel" aria-labelledby="tabStep3">
        <div class="step-panel-wrapper">
            <section class="card" aria-labelledby="step3-title">
                <div class="card-header">
                    <div class="card-title"><span class="step-indicator">3</span><span id="step3-title">é€‰æ‹©æœåŠ¡æ–¹æ¡ˆ</span></div>
                    <div class="card-subtitle">é€‰æ‹©é€‚åˆçš„æœåŠ¡æ–¹æ¡ˆï¼ŒæŸ¥çœ‹è´¹ç”¨æ˜ç»†</div>
                </div>
                <div class="card-body">
                    <div class="scheme-panel" role="radiogroup" aria-label="æœåŠ¡æ–¹æ¡ˆé€‰æ‹©">
                        <div class="scheme-option selected" id="schemeA" data-scheme="A" role="radio" aria-checked="true" tabindex="0">
                            <input type="radio" name="scheme" value="A" id="radioA" class="scheme-radio" checked>
                            <div class="scheme-content">
                                <div class="scheme-header"><span class="scheme-name">Aæ–¹æ¡ˆ Â· æµç¨‹è·Ÿè¿›</span><span class="scheme-price">Â¥380<span style="font-size:0.7rem;">/å¤§ç±»</span></span></div>
                                <div class="scheme-desc">é€‚åˆæœ‰æ˜ç¡®æ³¨å†Œéœ€æ±‚çš„å®¢æˆ·ï¼Œå«10ä¸ªå°ç±»ï¼Œè¶…å‡º38å…ƒ/ä¸ª</div>
                                <div class="scheme-features"><span class="feature-tag">âœ“ ææ–™å®¡æ ¸</span><span class="feature-tag">âœ“ è¿›åº¦æé†’</span><span class="feature-tag">âœ“ å®˜æ–‡ä»£æ”¶</span></div>
                            </div>
                        </div>
                        <div class="scheme-option" id="schemeB" data-scheme="B" role="radio" aria-checked="false" tabindex="-1">
                            <input type="radio" name="scheme" value="B" id="radioB" class="scheme-radio">
                            <div class="scheme-content">
                                <div class="scheme-header"><span class="scheme-name">Bæ–¹æ¡ˆ Â· ä¸“ä¸šè¾…å¯¼</span><span class="scheme-price">Â¥580<span style="font-size:0.7rem;">/å¤§ç±»</span></span></div>
                                <div class="scheme-desc">å«é£é™©è¯„ä¼°ä¸ç±»åˆ«è§„åˆ’ï¼Œ6ä¸ªå¤§ç±»ä»¥ä¸Šäº«85æŠ˜ä¼˜æƒ </div>
                                <div class="scheme-features"><span class="feature-tag">âœ“ é£é™©è¯„ä¼°</span><span class="feature-tag">âœ“ ç±»åˆ«è§„åˆ’</span><span class="feature-tag">âœ“ ä¸“ä¸šè§£è¯»</span><span class="feature-tag">âœ“ ææ–™ä¼˜åŒ–</span></div>
                            </div>
                        </div>
                        <div class="scheme-option" id="schemeC" data-scheme="C" role="radio" aria-checked="false" tabindex="-1">
                            <input type="radio" name="scheme" value="C" id="radioC" class="scheme-radio">
                            <div class="scheme-content">
                                <div class="scheme-header"><span class="scheme-name">Cæ–¹æ¡ˆ Â· åˆ†æœŸä»˜è´¹</span><span class="scheme-price">Â¥1100<span style="font-size:0.7rem;">/å¤§ç±»</span></span></div>
                                <div class="scheme-desc">é¦–ä»˜300å…ƒé¦–æœŸæ¬¾ï¼Œä¸‹è¯åä»˜å°¾æ¬¾800å…ƒã€‚</div>
                                <div class="scheme-features"><span class="feature-tag">âœ“ å‰æœŸå¯åŠ¨æˆæœ¬ä½</span><span class="feature-tag">âœ“ ä¸‹è¯åä»˜æœåŠ¡è´¹</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="invoice-section">
                        <label class="invoice-check"><input type="checkbox" id="invoiceCheckbox"><span class="invoice-label">å¼€å…·å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼ˆåŠ æ”¶5%ï¼‰</span></label>
                        <div class="invoice-hint">å¦‚éœ€ä¸“ç¥¨ï¼Œæ€»è´¹ç”¨å¢åŠ 5%ç¨ç‚¹ï¼›å¦åˆ™é»˜è®¤å¼€å…·å¢å€¼ç¨æ™®é€šå‘ç¥¨</div>
                    </div>
                    <div class="legal-notice" role="alert">
                        <strong>âš ï¸ é‡è¦å£°æ˜ï¼š</strong>å•†æ ‡å®¡æŸ¥æƒå½’å±å›½å®¶çŸ¥è¯†äº§æƒå±€ï¼Œå®¡æŸ¥ç»“æœå­˜åœ¨ä¸»è§‚å› ç´ ï¼Œ<strong>ä»»ä½•ä»£ç†æœºæ„å‡ä¸å¾—æ‰¿è¯º"åŒ…è¿‡"</strong>ï¼è‹¥è¢«é©³å›æˆ–å¼‚è®®ï¼Œå·²æ”¶è´¹ç”¨ä¸å¯é€€ã€‚æ‹…å¿ƒé£é™©è¯·é€‰æ‹©Cæ–¹æ¡ˆã€‚
                    </div>
                    <div class="fee-section" aria-live="polite">
                        <div class="fee-header"><span class="fee-title"><span>ğŸ’°</span><span>è´¹ç”¨æ˜ç»†</span></span><span class="fee-amount" id="totalAmount">Â¥0</span></div>
                        <div class="fee-details" id="feeDisplay"><div class="empty-state">è¯·å…ˆé€‰æ‹©å•†æ ‡å°ç±»</div></div>
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" id="exportWordBtn"><span>ğŸ“</span><span>ä¸‹å•å‘é€PDFè®¢å•</span></button>
                        <div class="btn-row">
                            <button type="button" class="btn btn-secondary" id="previewOrderBtn"><span>ğŸ‘ï¸</span><span>é¢„è§ˆè®¢å•</span></button>
                            <button type="button" class="btn btn-secondary" id="generateContractBtn"><span>ğŸ“„</span><span>ä¸‹å•å‘é€PDFåˆåŒ</span></button>
                        </div>
                    </div>

                    <div class="step-footer-nav">
                        <span class="step-indicator-light">å½“å‰ï¼šé€‰æ–¹æ¡ˆ</span>
                        <div class="step-footer-buttons">
                            <button class="step-footer-btn step-prev-btn" data-prev="2">â—€ ä¸Šä¸€æ­¥</button>
                            <button class="step-footer-btn btn-save-draft save-draft-btn" data-step="3">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
                            <button class="step-footer-btn step-next-btn" data-next="preview">ä¸‹ä¸€æ­¥ â–¶</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- é¢„è§ˆè®¢å•é¢æ¿ -->
    <div id="previewPanel" class="preview-panel-container" style="display: none;" role="tabpanel" aria-labelledby="tabPreview">
        <div class="preview-wrapper">
            <div id="previewContent" class="preview-content"><div class="empty-state">è¯·å¡«å†™å¿…è¦ä¿¡æ¯å¹¶é€‰æ‹©å°ç±»åæŸ¥çœ‹é¢„è§ˆ</div></div>
            <div class="preview-actions">
                <div class="button-group">
                    <button type="button" class="btn btn-primary preview-export-word">ğŸ“ ä¸‹å•å‘é€PDFè®¢å•</button>
                    <button type="button" class="btn btn-secondary preview-generate-contract">ğŸ“„ ä¸‹å•å‘é€PDFåˆåŒ</button>
                </div>
            </div>
            <div class="step-footer-nav">
                <span class="step-indicator-light">å½“å‰ï¼šé¢„è§ˆè®¢å•</span>
                <div class="step-footer-buttons">
                    <button class="step-footer-btn step-prev-btn" data-prev="3">â—€ ä¸Šä¸€æ­¥</button>
                    <button class="step-footer-btn step-next-btn" data-next="flow">ä¸‹ä¸€æ­¥ â–¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æµç¨‹é¢æ¿ (ä»˜æ¬¾åæµç¨‹) -->
    <div id="flowPanel" class="flow-panel-container" style="display: none;" role="tabpanel" aria-labelledby="tabFlow">
        <div class="flow-wrapper">
            <div class="start-box" id="flowStartBox" onclick="toggleFlowStart()" role="button" tabindex="0" aria-pressed="false">
                <div class="qr-container">
                    <img src="è”ç³»é™ˆå·¥-å¾®ä¿¡äºŒç»´ç .png" alt="è”ç³»é™ˆå·¥å¾®ä¿¡äºŒç»´ç " class="qr-code" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.style.display='block'; this.nextElementSibling.style.display='none';" width="120" height="120">
                    <div class="qr-fallback" style="display: none;">äºŒç»´ç åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„</div>
                </div>
                <div class="start-text">ç­¾è®¢åˆåŒã€ä»˜æ¬¾åï¼Œå¼€å§‹æœåŠ¡æµç¨‹â†“â†“â†“</div>
            </div>
            <div class="arrow-down" aria-hidden="true">â†“</div>
            <div class="interactive-hint">ç‚¹å‡»æ­¥éª¤æ ‡è®°å®ŒæˆçŠ¶æ€</div>
            <div class="flow-container">
                <div class="flow-line"></div>
                <div class="flow-step flow-step-1" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">1</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">1</span>æ ¹æ®æ‚¨æ‰€é€‰æ–¹æ¡ˆè¿›è¡Œå¯¹åº”æœåŠ¡æµç¨‹</div>
                    </div>
                </div>
                <div class="flow-step flow-step-2" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">2</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">2</span>è·Ÿæ‚¨å†æ¬¡ç¡®è®¤å•†æ ‡ç”³è¯·ä¿¡æ¯è¡¨åï¼Œæäº¤å•†æ ‡å±€</div>
                    </div>
                </div>
                <div class="flow-step flow-step-3" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">3</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">3</span>æäº¤å•†æ ‡å±€åï¼Œæœ€å¿«å½“å¤©æœ‰å›æ‰§ä¹¦ç»™æ‚¨</div>
                    </div>
                </div>
                <div class="flow-step flow-step-4" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">4</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">4</span>å—ç†é€šçŸ¥ä¹¦ï¼ˆçº¦1ä¸ªæœˆï¼‰ï¼šå•†æ ‡å±€å½¢å¼å®¡æŸ¥é€šè¿‡ï¼Œä¸‹å‘å—ç†é€šçŸ¥ä¹¦</div>
                    </div>
                    <div class="note">å¦‚é‡è¡¥æ­£ï¼Œå…è´¹ååŠ©å¤„ç†ã€‚</div>
                </div>
                <div class="flow-step flow-step-5" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">5</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">5</span>å®è´¨å®¡æŸ¥ï¼ˆçº¦2-3ä¸ªæœˆï¼‰ï¼šå®¡æŸ¥å‘˜è¿›è¡Œå®è´¨å®¡æŸ¥ï¼Œç»“æœå¯èƒ½æ˜¯åˆæ­¥å®¡å®šå…¬å‘Šæˆ–è€…é©³å›</div>
                    </div>
                    <div class="note warning">å¦‚é‡é©³å›ï¼šæ‚¨å¯é€‰æ‹©æ˜¯å¦è¿›è¡Œé©³å›å¤å®¡ï¼ˆéœ€å¦ä»˜è´¹ï¼Œå‘¨æœŸçº¦1å¹´ï¼‰</div>
                </div>
                <div class="flow-step flow-step-6" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">6</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">6</span>å…¬å‘ŠæœŸï¼ˆ3ä¸ªæœˆï¼‰ï¼šåˆæ­¥å®¡å®šåè¿›å…¥å…¬å‘ŠæœŸï¼Œæ¥å—å…¬ä¼—ç›‘ç£ï¼Œç»“æœå¯èƒ½æ˜¯æ— å¼‚è®®æˆ–è€…è¢«æå‡ºå¼‚è®®</div>
                    </div>
                    <div class="note warning">å¦‚é‡å¼‚è®®ï¼šæ‚¨å¯é€‰æ‹©æ˜¯å¦è¿›è¡Œå¼‚è®®ç­”è¾©ï¼ˆéœ€å¦ä»˜è´¹ï¼Œå‘¨æœŸçº¦1å¹´ï¼‰</div>
                </div>
                <div class="flow-step flow-step-7" onclick="toggleFlowStep(this)" role="button" tabindex="0" aria-pressed="false">
                    <div class="step-marker">7</div>
                    <div class="step-content">
                        <div class="step-text"><span class="step-number">7</span>è·å¾—æ³¨å†Œè¯ï¼ˆçº¦1ä¸ªæœˆï¼‰ï¼šå…¬å‘ŠæœŸæ»¡æ— å¼‚è®®æˆ–å¼‚è®®ä¸æˆç«‹ï¼Œé¢å‘å•†æ ‡æ³¨å†Œè¯ä¹¦ï¼ˆCæ–¹æ¡ˆéœ€æ­¤æ—¶ç»“æ¸…å°¾æ¬¾ï¼‰</div>
                    </div>
                </div>
            </div>
            <div class="footer-notice">ä»¥ä¸Šæ—¶é—´ä¸ºç›®å‰æ”¿ç­–ä¸‹çš„ä¼°ç®—å‘¨æœŸï¼Œå…·ä½“ä»¥å•†æ ‡å±€å®é™…å®¡æŸ¥è¿›åº¦ä¸ºå‡†ã€‚</div>
            <div class="step-footer-nav">
                <span class="step-indicator-light">å½“å‰ï¼šä»˜æ¬¾åæµç¨‹</span>
                <div class="step-footer-buttons">
                    <button class="step-footer-btn step-prev-btn" data-prev="preview">â—€ ä¸Šä¸€æ­¥</button>
                    <button class="step-footer-btn" disabled>ä¸‹ä¸€æ­¥ â–¶</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-info">ä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸Â·å•†æ ‡Â·ç‰ˆæƒä¸“ä¸šä»£ç†æœåŠ¡ï¼š13128311370</footer>
</div>

<script>
    'use strict';
    // ==================== åŸæœ‰å…¨éƒ¨JavaScriptä»£ç ï¼ˆä»…æŒ‰éœ€ä¿®æ”¹å¯¼å‡ºå‡½æ•°ï¼Œå…¶ä½™å®Œå…¨ä¿ç•™ï¼‰====================
    (function() {
        // ----- å†…ç½®é»˜è®¤åˆ†ç±»æ•°æ® -----
        const DEFAULT_CATEGORIES = [
            {
                "å¤§ç±»": "25",
                "children": [
                    {
                        "ç±»ä¼¼ç¾¤ç»„": "2501",
                        "name": "è¡£ç‰©",
                        "children": [
                            { "å°ç±»": "æœè£…" },
                            { "å°ç±»": "è¡¬è¡«" },
                            { "å°ç±»": "Tæ¤" },
                            { "å°ç±»": "å¤–å¥—" },
                            { "å°ç±»": "è£¤å­" }
                        ]
                    },
                    {
                        "ç±»ä¼¼ç¾¤ç»„": "2502",
                        "name": "å©´å„¿çººç»‡å“",
                        "children": [
                            { "å°ç±»": "å©´å„¿æœè£…" },
                            { "å°ç±»": "å©´å„¿è£¤" }
                        ]
                    },
                    {
                        "ç±»ä¼¼ç¾¤ç»„": "2503",
                        "name": "ç‰¹ç§è¿åŠ¨æœè£…",
                        "children": [
                            { "å°ç±»": "æ¸¸æ³³è¡£" },
                            { "å°ç±»": "éª‘è‡ªè¡Œè½¦æœè£…" }
                        ]
                    }
                ]
            },
            {
                "å¤§ç±»": "9",
                "children": [
                    {
                        "ç±»ä¼¼ç¾¤ç»„": "0901",
                        "name": "ç”µå­è®¡ç®—æœºåŠå…¶å¤–éƒ¨è®¾å¤‡",
                        "children": [
                            { "å°ç±»": "è®¡ç®—æœº" },
                            { "å°ç±»": "ç¬”è®°æœ¬ç”µè„‘" },
                            { "å°ç±»": "å¹³æ¿ç”µè„‘" },
                            { "å°ç±»": "è®¡ç®—æœºè½¯ä»¶ï¼ˆå·²å½•åˆ¶ï¼‰" }
                        ]
                    },
                    {
                        "ç±»ä¼¼ç¾¤ç»„": "0907",
                        "name": "é€šä¿¡è®¾å¤‡",
                        "children": [
                            { "å°ç±»": "æ™ºèƒ½æ‰‹æœº" },
                            { "å°ç±»": "æ‰‹æœºå£³" }
                        ]
                    }
                ]
            },
            {
                "å¤§ç±»": "35",
                "children": [
                    {
                        "ç±»ä¼¼ç¾¤ç»„": "3501",
                        "name": "å¹¿å‘Š",
                        "children": [
                            { "å°ç±»": "å¹¿å‘Š" },
                            { "å°ç±»": "å¹¿å‘Šå®£ä¼ " }
                        ]
                    }
                ]
            }
        ];

        // æ•°æ®å­˜å‚¨
        let rawData = [];
        const selectedSubclasses = {};
        let trademarkImageData = null;
        
        // æ–¹æ¡ˆå‚æ•°
        const schemeParams = {
            A: { base: 380, extra: 38, name: 'æµç¨‹è·Ÿè¿›' },
            B: { base: 580, extra: 58, name: 'ä¸“ä¸šè¾…å¯¼' },
            C: { base: 1100, extra: 110, name: 'åˆ†æœŸä»˜è´¹' }
        };

        // å·¥å…·å‡½æ•°
        function cleanInput(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/\s+/g, '').trim();
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = unsafe;
            return div.innerHTML;
        }

        function escapeAttr(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // è·å–ç»Ÿè®¡ä¿¡æ¯
        function getSelectedStats() {
            let majorCount = 0, totalSubCount = 0;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length > 0) {
                    majorCount++;
                    totalSubCount += selectedSubclasses[major].length;
                }
            }
            return { majorCount, totalSubCount };
        }

        // è®¡ç®—è´¹ç”¨
        function computeFeeDetails() {
            const schemeRadio = document.querySelector('input[name="scheme"]:checked');
            const scheme = schemeRadio ? schemeRadio.value : 'A';
            const params = schemeParams[scheme];
            const withInvoice = document.getElementById('invoiceCheckbox').checked;

            let totalOriginal = 0;
            const majorDetails = {};
            for (const major in selectedSubclasses) {
                const subList = selectedSubclasses[major];
                if (subList.length === 0) continue;
                const count = subList.length;
                const originalCost = (count <= 10) ? params.base : (params.base + (count - 10) * params.extra);
                majorDetails[major] = { count, originalCost };
                totalOriginal += originalCost;
            }

            const majorCount = Object.keys(majorDetails).length;
            let finalTotal = totalOriginal;
            let discountNote = '';

            if (scheme === 'B' && majorCount > 6) {
                finalTotal = totalOriginal * 0.85;
                discountNote = 'Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šç«‹å‡15%';
            }
            
            if (scheme === 'C') {
                const discountFactor = (majorCount > 6) ? 0.85 : 1.0;
                let totalActual = 0;
                for (const major in majorDetails) {
                    const orig = majorDetails[major].originalCost;
                    const firstPay = 300;
                    let tail = orig - firstPay;
                    if (discountFactor < 1.0) {
                        tail = tail * discountFactor;
                    }
                    majorDetails[major].firstPay = firstPay;
                    majorDetails[major].tail = tail;
                    majorDetails[major].actualCost = firstPay + tail;
                    totalActual += majorDetails[major].actualCost;
                }
                finalTotal = totalActual;
                if (majorCount > 6) {
                    discountNote = 'Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šå°¾æ¬¾å‡å…15%';
                }
            }

            const invoiceAmount = withInvoice ? finalTotal * 0.05 : 0;
            const totalWithInvoice = finalTotal + invoiceAmount;

            return {
                scheme,
                params,
                withInvoice,
                majorDetails,
                majorCount,
                totalOriginal,
                finalTotal,
                invoiceAmount,
                totalWithInvoice,
                discountNote
            };
        }

        // ç”Ÿæˆè´¹ç”¨æ–‡æœ¬ï¼ˆç•¥ï¼Œä¿æŒåŸæ ·ï¼‰
        function computeFeeText() {
            const d = computeFeeDetails();
            if (Object.keys(d.majorDetails).length === 0) {
                return '<div class="empty-state">è¯·å…ˆé€‰æ‹©å•†æ ‡å°ç±»ä»¥æŸ¥çœ‹è´¹ç”¨</div>';
            }

            let html = '<div class="fee-rows">';
            
            html += `<div class="fee-row"><span>æœåŠ¡æ–¹æ¡ˆ</span><span class="fee-highlight">${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}</span></div>`;
            html += `<div class="fee-row"><span>è®¡ä»·æ–¹å¼</span><span>Â¥${d.params.base}/å¤§ç±»ï¼ˆå«10å°ç±»ï¼‰ï¼Œè¶…å‡ºÂ¥${d.params.extra}/å°ç±»</span></div>`;
            
            if (d.discountNote) {
                html += `<div class="fee-row" style="color: var(--success);"><span>ğŸ ä¼˜æƒ æ´»åŠ¨</span><span>${escapeHtml(d.discountNote)}</span></div>`;
            }
            
            html += '<div style="margin: 12px 0; border-top: 1px solid var(--gray-200);"></div>';
            
            for (const major in d.majorDetails) {
                const item = d.majorDetails[major];
                html += `<div class="fee-row"><span>ã€${escapeHtml(major)}ã€‘${item.count}ä¸ªå°ç±»</span><span>Â¥${item.originalCost.toFixed(2)}</span></div>`;
            }
            
            html += '<div style="margin: 12px 0; border-top: 1px solid var(--gray-200);"></div>';
            
            html += `<div class="fee-row"><span>å°è®¡ï¼ˆåŸä»·ï¼‰</span><span>Â¥${d.totalOriginal.toFixed(2)}</span></div>`;
            
            if (d.scheme === 'B' && d.majorCount > 6) {
                html += `<div class="fee-row" style="color: var(--success);"><span>ä¼˜æƒ å</span><span>Â¥${d.finalTotal.toFixed(2)}</span></div>`;
            }
            
            if (d.scheme === 'C') {
                html += `<div class="fee-row" style="color: var(--success);"><span>Cæ–¹æ¡ˆæ€»ä»·ï¼ˆä¼˜æƒ åï¼‰</span><span>Â¥${d.finalTotal.toFixed(2)}</span></div>`;
            }
            
            if (d.withInvoice) {
                html += `<div class="fee-row"><span>å¢å€¼ç¨ä¸“ç¥¨ï¼ˆåŠ æ”¶5%ï¼‰</span><span>Â¥${d.invoiceAmount.toFixed(2)}</span></div>`;
            }
            
            html += `<div class="fee-row" style="font-size: 1.2rem; color: var(--primary); margin-top: 8px;"><span>åº”ä»˜æ€»é¢</span><span>Â¥${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}</span></div>`;
            
            html += `<div style="margin-top: 8px; font-size:0.9rem;"><span>ğŸ“„ å‘ç¥¨ç±»å‹ï¼š${d.withInvoice ? 'å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼ˆå·²åŠ æ”¶5%ï¼‰' : 'å¢å€¼ç¨æ™®é€šå‘ç¥¨'}</span></div>`;
            
            html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--gray-200); font-size: 0.85rem; color: var(--gray-600);">';
            
            if (d.scheme === 'C') {
                let firstTotal = 0, tailTotal = 0;
                for (const major in d.majorDetails) {
                    firstTotal += d.majorDetails[major].firstPay;
                    tailTotal += d.majorDetails[major].tail;
                }
                if (d.withInvoice) {
                    firstTotal = firstTotal * 1.05;
                    tailTotal = tailTotal * 1.05;
                }
                html += `<div style="margin-bottom: 8px;"><strong>ä»˜æ¬¾è®¡åˆ’ï¼š</strong></div>`;
                html += `<div>â‘  é¦–æœŸæ¬¾æ€»é¢ï¼šÂ¥${firstTotal.toFixed(2)}ï¼ˆåˆåŒç­¾è®¢åæ”¯ä»˜ï¼Œ${d.withInvoice?'å«ä¸“ç¥¨':'æ™®ç¥¨'}ï¼‰</div>`;
                html += `<div>â‘¡ æœåŠ¡å°¾æ¬¾ï¼šæ¯ä¸ªå¤§ç±»ä¸‹å‘æ³¨å†Œè¯åæ”¯ä»˜ï¼Œå…·ä½“é‡‘é¢å¦‚ä¸‹ï¼š</div>`;
                let subIdx = 1;
                for (const major in d.majorDetails) {
                    let tail = d.majorDetails[major].tail;
                    if (d.withInvoice) tail = tail * 1.05;
                    const circle = getCircledNumber(subIdx);
                    html += `<div>${circle} ç¬¬${escapeHtml(major)}å¤§ç±»<strong>å°¾æ¬¾</strong>ï¼šÂ¥${tail.toFixed(2)}</div>`;
                    subIdx++;
                }
            } else {
                html += `<div><strong>ä»˜æ¬¾æ–¹å¼ï¼š</strong>åˆåŒç­¾è®¢åä¸€æ¬¡æ€§æ”¯ä»˜ï¼ˆ${d.withInvoice?'å«ä¸“ç¥¨':'æ™®ç¥¨'}ï¼‰</div>`;
            }
            
            html += '</div></div>';
            
            return html;
        }

        // å¸¦åœˆæ•°å­—å‡½æ•°
        function getCircledNumber(n) {
            const map = {
                1:'â‘ ',2:'â‘¡',3:'â‘¢',4:'â‘£',5:'â‘¤',6:'â‘¥',7:'â‘¦',8:'â‘§',9:'â‘¨',10:'â‘©',
                11:'â‘ª',12:'â‘«',13:'â‘¬',14:'â‘­',15:'â‘®',16:'â‘¯',17:'â‘°',18:'â‘±',19:'â‘²',20:'â‘³'
            };
            return map[n] || n + '.';
        }

        // æ›´æ–°UIï¼ˆå®Œå…¨ä¿ç•™åŸæ ·ï¼‰
        function refreshUI() { /* ä¿æŒåŸæ ·ï¼Œä»£ç ç•¥é•¿ï¼Œä½†å®Œå…¨ä¿ç•™ */ 
            document.querySelectorAll('.scheme-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.setAttribute('aria-checked', 'false');
                opt.setAttribute('tabindex', '-1');
                if (opt.querySelector('input').checked) {
                    opt.classList.add('selected');
                    opt.setAttribute('aria-checked', 'true');
                    opt.setAttribute('tabindex', '0');
                }
            });

            const tagsContainer = document.getElementById('selectedTags');
            const emptyState = document.getElementById('selectedEmpty');
            const selectedList = document.getElementById('selectedListContainer');
            
            tagsContainer.innerHTML = '';
            
            let hasItems = false;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                hasItems = true;
                
                selectedSubclasses[major].forEach(sub => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-tag';
                    tag.setAttribute('role', 'listitem');
                    tag.innerHTML = `
                        <span class="tag-major">${escapeHtml(major)}</span>
                        <span class="tag-sub">${escapeHtml(sub)}</span>
                        <button type="button" class="tag-remove" data-major="${escapeAttr(major)}" data-sub="${escapeAttr(sub)}" aria-label="åˆ é™¤ ${escapeHtml(major)} ${escapeHtml(sub)}">Ã—</button>
                    `;
                    tagsContainer.appendChild(tag);
                });
            }
            
            if (hasItems) {
                emptyState.style.display = 'none';
                tagsContainer.style.display = 'flex';
                selectedList.classList.add('has-items');
            } else {
                emptyState.style.display = 'block';
                tagsContainer.style.display = 'none';
                selectedList.classList.remove('has-items');
            }

            document.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const major = this.dataset.major;
                    const sub = this.dataset.sub;
                    if (selectedSubclasses[major]) {
                        const idx = selectedSubclasses[major].indexOf(sub);
                        if (idx > -1) {
                            selectedSubclasses[major].splice(idx, 1);
                            if (selectedSubclasses[major].length === 0) {
                                delete selectedSubclasses[major];
                            }
                        }
                    }
                    refreshUI();
                    syncCheckboxesFromSelected();
                });
            });

            const stats = getSelectedStats();
            document.getElementById('selectedCountBadge').textContent = `å·²é€‰ ${stats.totalSubCount} ä¸ªå°ç±»`;
            
            const feeHtml = computeFeeText();
            document.getElementById('feeDisplay').innerHTML = feeHtml;
            
            const d = computeFeeDetails();
            const total = d.withInvoice ? d.totalWithInvoice : d.finalTotal;
            document.getElementById('totalAmount').textContent = 'Â¥' + total.toFixed(0);
            
            syncCheckboxesFromSelected();
        }

        function syncCheckboxesFromSelected() { /* ä¿æŒåŸæ · */ 
            const checkboxes = document.querySelectorAll('.subclass-checkbox');
            checkboxes.forEach(cb => {
                const major = cb.dataset.major;
                const sub = cb.dataset.sub;
                cb.checked = !!(selectedSubclasses[major] && selectedSubclasses[major].includes(sub));
            });
        }

        function handleCheckboxChange(e) { /* ä¿æŒåŸæ · */ 
            const cb = e.target;
            const major = cb.dataset.major;
            const sub = cb.dataset.sub;
            if (!major || !sub) return;
            
            if (cb.checked) {
                if (!selectedSubclasses[major]) selectedSubclasses[major] = [];
                if (!selectedSubclasses[major].includes(sub)) {
                    selectedSubclasses[major].push(sub);
                }
            } else {
                if (selectedSubclasses[major]) {
                    const idx = selectedSubclasses[major].indexOf(sub);
                    if (idx > -1) selectedSubclasses[major].splice(idx, 1);
                    if (selectedSubclasses[major].length === 0) delete selectedSubclasses[major];
                }
            }
            refreshUI();
        }

        // æ¸²æŸ“æ ‘ï¼ˆä¿æŒåŸæ ·ï¼‰
        function renderTree(filterText = '') { /* ä¿æŒåŸæ ·ï¼Œç•¥ */ 
            const treeElem = document.getElementById('categoryTree');
            treeElem.innerHTML = '';
            
            if (!rawData || rawData.length === 0) {
                treeElem.innerHTML = '<li class="empty-state" style="color: var(--danger);">âš ï¸ æœªåŠ è½½åˆ†ç±»æ•°æ®ï¼Œè¯·ç¡®ä¿JSONæ–‡ä»¶å­˜åœ¨</li>';
                return;
            }

            let matchCount = 0;
            const lowerFilter = filterText.toLowerCase().trim();
            const hasFilter = lowerFilter !== '';

            rawData.forEach(majorNode => {
                const majorName = majorNode.å¤§ç±» || majorNode.name || '';
                let majorHasMatch = false;
                let groupsHTML = '';

                (majorNode.children || []).forEach(groupNode => {
                    const groupName = groupNode.name || groupNode.ç±»ä¼¼ç¾¤ç»„ || '';
                    const groupNumber = groupNode.ç±»ä¼¼ç¾¤ç»„ || '';
                    const groupText = `${groupNumber} ${groupName}`.toLowerCase();
                    let groupHasMatch = false;
                    let subItemsHTML = '';

                    (groupNode.children || []).forEach(subNode => {
                        const subName = subNode.å°ç±» || subNode.name || '';
                        const subText = subName.toLowerCase();
                        const match = !hasFilter || 
                                      majorName.toLowerCase().includes(lowerFilter) ||
                                      groupText.includes(lowerFilter) ||
                                      subText.includes(lowerFilter);
                        if (match || !hasFilter) {
                            groupHasMatch = true;
                            majorHasMatch = true;
                            matchCount++;
                            const checked = (selectedSubclasses[majorName] && selectedSubclasses[majorName].includes(subName)) ? 'checked' : '';
                            subItemsHTML += `<li class="subclass-item">
                                <input type="checkbox" class="subclass-checkbox" data-major="${escapeAttr(majorName)}" data-sub="${escapeAttr(subName)}" ${checked} id="cb-${escapeAttr(majorName)}-${escapeAttr(subName)}">
                                <label for="cb-${escapeAttr(majorName)}-${escapeAttr(subName)}" class="subclass-name">${escapeHtml(subName)}</label>
                            </li>`;
                        }
                    });

                    if (groupHasMatch || !hasFilter) {
                        const groupLiClass = 'tree-li group-li' + (hasFilter && groupHasMatch ? ' expanded' : '');
                        groupsHTML += `<li class="${groupLiClass}">
                            <button type="button" class="folder-label cat-group" data-group="${escapeAttr(groupNumber)}" aria-expanded="${hasFilter && groupHasMatch ? 'true' : 'false'}">
                                <span class="folder-icon" aria-hidden="true">â–¶</span>
                                <span>${escapeHtml(groupNumber)} - ${escapeHtml(groupName)}</span>
                            </button>
                            <ul class="group-subs">${subItemsHTML}</ul>
                        </li>`;
                    }
                });

                if (majorHasMatch || !hasFilter) {
                    const majorLiClass = 'tree-li major-li' + (hasFilter && majorHasMatch ? ' expanded' : '');
                    const majorLi = document.createElement('li');
                    majorLi.className = majorLiClass;
                    majorLi.innerHTML = `
                        <button type="button" class="folder-label cat-major" data-major="${escapeAttr(majorName)}" aria-expanded="${hasFilter && majorHasMatch ? 'true' : 'false'}">
                            <span class="folder-icon" aria-hidden="true">â–¶</span>
                            <span>å¤§ç±» ${escapeHtml(majorName)}</span>
                        </button>
                        <ul class="major-groups">${groupsHTML}</ul>
                    `;
                    treeElem.appendChild(majorLi);
                }
            });

            document.getElementById('searchCount').textContent = hasFilter ? `åŒ¹é… ${matchCount} é¡¹` : `å…± ${getTotalSubCount()} å°ç±»`;

            document.querySelectorAll('.subclass-checkbox').forEach(cb => {
                cb.removeEventListener('change', handleCheckboxChange);
                cb.addEventListener('change', handleCheckboxChange);
            });
            
            document.querySelectorAll('.subclass-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                        const cb = this.querySelector('input[type="checkbox"]');
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            });
            
            syncCheckboxesFromSelected();
            attachFolderListeners();
        }

        function attachFolderListeners() { /* ä¿æŒåŸæ · */ 
            document.querySelectorAll('.major-li > .folder-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const li = this.parentElement;
                    const isExpanded = li.classList.toggle('expanded');
                    this.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
                });
            });
            document.querySelectorAll('.group-li > .folder-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const li = this.parentElement;
                    const isExpanded = li.classList.toggle('expanded');
                    this.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
                });
            });
        }

        function getTotalSubCount() { /* ä¿æŒåŸæ · */ 
            let c = 0;
            rawData.forEach(m => (m.children || []).forEach(g => (g.children || []).forEach(() => c++)));
            return c;
        }

        // åŠ è½½æ•°æ®
        async function loadJSON() {
            try {
                const response = await fetch('å°¼æ–¯åˆ†ç±»è¡¨_æ ‘çŠ¶ç»“æ„.json');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½JSON');
                rawData = await response.json();
                renderTree();
                refreshUI();
            } catch (e) {
                console.error('åŠ è½½åˆ†ç±»æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®é»˜è®¤æ•°æ®:', e);
                rawData = DEFAULT_CATEGORIES;
                renderTree();
                refreshUI();
                const treeContainer = document.querySelector('.tree-container');
                const hint = document.createElement('div');
                hint.style.padding = '4px 8px';
                hint.style.background = '#fff3cd';
                hint.style.color = '#856404';
                hint.style.fontSize = '0.8rem';
                hint.style.borderRadius = '8px';
                hint.style.marginBottom = '8px';
                hint.textContent = 'âš ï¸ ä½¿ç”¨å†…ç½®ç¤ºä¾‹æ•°æ®ï¼ˆæœªèƒ½åŠ è½½å¤–éƒ¨åˆ†ç±»æ–‡ä»¶ï¼‰';
                treeContainer.prepend(hint);
            }
        }

        // äº‹ä»¶ç»‘å®šï¼ˆä¿æŒåŸæ ·ï¼‰
        document.getElementById('clearSelectedBtn').addEventListener('click', function() {
            if (Object.keys(selectedSubclasses).length === 0) return;
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å·²é€‰å°ç±»å—ï¼Ÿ')) {
                for (const key in selectedSubclasses) {
                    delete selectedSubclasses[key];
                }
                refreshUI();
                renderTree(document.getElementById('searchInput').value);
            }
        });

        const debouncedSearch = debounce((value) => {
            renderTree(value);
        }, 300);

        document.getElementById('searchInput').addEventListener('input', function(e) {
            debouncedSearch(e.target.value);
        });

        // æ–‡ä»¶ä¸Šä¼ ï¼ˆä¿æŒåŸæ ·ï¼‰
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewBox = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary)';
            uploadArea.style.background = 'var(--primary-light)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '';
            uploadArea.style.background = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '';
            uploadArea.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        uploadArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                fileInput.click();
            }
        });
        
        fileInput.addEventListener('change', function(e) {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                trademarkImageData = ev.target.result;
                previewImg.src = ev.target.result;
                previewBox.style.display = 'flex';
                uploadArea.classList.add('has-file');
                uploadArea.innerHTML = `
                    <div class="upload-icon" aria-hidden="true">âœ“</div>
                    <div class="upload-text">å·²ä¸Šä¼ ï¼š${escapeHtml(file.name)}</div>
                    <div class="upload-hint">ç‚¹å‡»é‡æ–°ä¸Šä¼ </div>
                `;
            };
            reader.onerror = () => {
                alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            reader.readAsDataURL(file);
        }

        // æ–¹æ¡ˆé€‰æ‹©ï¼ˆä¿æŒåŸæ ·ï¼‰
        document.querySelectorAll('.scheme-option').forEach(opt => {
            opt.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') return;
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                refreshUI();
            });

            opt.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    refreshUI();
                }
            });
        });

        document.querySelectorAll('input[name="scheme"]').forEach(r => {
            r.addEventListener('change', refreshUI);
        });

        document.getElementById('invoiceCheckbox').addEventListener('change', refreshUI);

        // ç”Ÿæˆè®¢å•é¢„è§ˆ HTML çš„å‡½æ•°ï¼ˆä¿æŒåŸæ ·ï¼‰
        function generateOrderPreviewHtml(applicant, tmName, phone, contact, stats, d, trademarkImageData) {
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const orderNo = `ZCXD-${year}${month}${day}${hours}${minutes}${seconds}`;

            let html = `
                <style>
                    body { font-family: 'å®‹ä½“', SimSun, serif; }
                    .word-bg-scheme { background-color: #D4E6F1; padding: 4px 8px; font-weight: bold; }
                    .word-bg-fee { background-color: #D5E8D4; padding: 4px 8px; font-weight: bold; }
                    .word-bg-payment-plan { background-color: #FFF2CC; padding: 4px 8px; font-weight: bold; }
                    .word-bg-payment-info { background-color: #E6E6FA; padding: 4px 8px; font-weight: bold; }
                    .word-bg-important { background-color: #FCE4D6; padding: 4px 8px; font-weight: bold; }
                    .word-total-red { color: #C00000; font-weight: bold; font-size: 12pt; }
                    .underline-red { text-decoration: underline; color: red; }
                    .word-table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 11pt; }
                    .word-table th { background: #f0f0f0; border: 1px solid #999; padding: 8px; text-align: center; font-weight: bold; }
                    .word-table td { border: 1px solid #999; padding: 6px; vertical-align: top; }
                    .word-img { width: 40px; height: 40px; object-fit: contain; display: block; margin: 0 auto; }
                    .word-img-preview { max-width: 60px; max-height: 60px; object-fit: contain; }
                    .word-contract-table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                    .word-contract-table td, .word-contract-table th { border: 1px solid #333; padding: 8px; }
                    .word-contract-table th { background: #e8e8e8; }
                    .word-signature-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
                    .word-signature-table td { border: none; padding: 10px 20px; vertical-align: bottom; }
                    .word-signature-line { border-bottom: 1px solid #000; height: 40px; width: 100%; }
                    .info-table { border-collapse: collapse; width: 100%; margin: 4px 0; }
                    .info-table td { border: 1px solid #999; padding: 4px; }
                    .info-table td:first-child { font-weight: bold; background: #f5f5f5; width: 30%; }
                </style>
                <h1 style="color: #003d7c; text-align: center; border-bottom: 2px solid #003d7c; padding-bottom: 3px; font-size: 14pt; margin: 0 0 4px;">ğŸ“„ å•†æ ‡ç”³è¯·è®¢å•</h1>
                
                <h2 style="color: #1f3a5f; margin: 6px 0 3px; font-size: 11pt; border-left: 3px solid #003d7c; padding-left: 4px;">ä¸€ã€åŸºæœ¬ä¿¡æ¯</h2>
                <table class="info-table">
                    <tr><td>ç”³è¯·äººå…¨ç§°ï¼š</td><td>${escapeHtml(applicant)}</td></tr>
                    <tr><td>è”ç³»äººå§“åï¼š</td><td>${escapeHtml(contact || 'æœªå¡«å†™')}</td></tr>
                    <tr><td>è”ç³»ç”µè¯ï¼š</td><td>${escapeHtml(phone || 'æœªå¡«å†™')}</td></tr>
                    <tr><td>è®¢å•å·ï¼š</td><td>${orderNo}</td></tr>
                    <tr><td>ä¸‹è®¢å•æ—¥æœŸï¼š</td><td>${today}</td></tr>
                    <tr><td>æœåŠ¡æ–¹æ¡ˆï¼š</td><td>${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}</td></tr>
                    <tr><td>æ–¹æ¡ˆæè¿°ï¼š</td><td>${d.scheme === 'A' ? 'é€‚åˆéœ€æ±‚ï¼šæ‚¨æ‡‚å•†æ ‡ä½†äº‹åŠ¡ç¹å¿™ï¼Ÿæµç¨‹è·Ÿè¿›å¸®æ‚¨çœå¿ƒçœåŠ›ã€‚æœåŠ¡å†…å®¹ï¼šææ–™å½¢å¼å®¡æ ¸ã€å®˜æ–¹æ–‡ä»¶ä»£æ”¶ä»£å‘ã€å…³é”®èŠ‚ç‚¹äººå·¥æé†’ã€å…¨æµç¨‹è¿›åº¦åŒæ­¥ã€‚' : d.scheme === 'B' ? 'é€‚åˆéœ€æ±‚ï¼šå¸Œæœ›æå‡å•†æ ‡æ³¨å†Œè§„èŒƒæ€§ï¼Ÿä¸“ä¸šè¾…å¯¼ä¸ºæ‚¨ä¿é©¾æŠ¤èˆªã€‚æœåŠ¡å†…å®¹ï¼šæ³¨å†Œå‰é£é™©è¯„ä¼°ã€ç±»åˆ«è§„åˆ’å»ºè®®ã€ç”³è¯·ææ–™ä¼˜åŒ–ã€ä¸“ä¸šè§£è¯»ä¸æŒ‡å¯¼ã€‚' : 'é€‚åˆéœ€æ±‚ï¼šæ‹…å¿ƒæ³¨å†Œä¸ä¸‹æ¥ï¼ŒæœåŠ¡è´¹ç™½ç»™ï¼Ÿåˆ†æœŸä»˜è´¹è®©æ‚¨æ›´ä»å®¹ã€‚æœåŠ¡å†…å®¹ï¼šå¯åŠ¨æˆæœ¬æ›´ä½ï¼Œä»…ä»˜é¦–æœŸæ¬¾ï¼›ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åå†ä»˜æœåŠ¡è´¹ï¼'}</td></tr>
                </table>

                <h2 style="color: #1f3a5f; margin: 6px 0 3px; font-size: 11pt; border-left: 3px solid #003d7c; padding-left: 4px;">äºŒã€å·²é€‰ç±»åˆ«æ˜ç»†</h2>
                <table class="word-table" style="table-layout: fixed;">
                    <colgroup>
                        <col style="width: 8%;">
                        <col style="width: 15%;">
                        <col style="width: 60px;">
                        <col style="width: 10%;">
                        <col style="width: auto;">
                    </colgroup>
                    <tr>
                        <th style="width: 8%;">åºå·</th>
                        <th style="width: 15%;">å•†æ ‡åç§°</th>
                        <th style="width: 60px;">å•†æ ‡å›¾æ ·</th>
                        <th style="width: 10%;">å·²é€‰å¤§ç±»</th>
                        <th>å°ç±»</th>
                    </tr>
            `;
            let idx = 1;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                const subText = selectedSubclasses[major].map(s => escapeHtml(s)).join('ï¼›');
                html += `<tr>
                    <td style="text-align: center;">${idx}</td>
                    <td style="text-align: center;">${escapeHtml(tmName)}</td>
                    <td style="width:60px; height:40px; padding:0; text-align:center; vertical-align:middle; font-size:0; line-height:0;">`;
                if (trademarkImageData) {
                    html += `<img src="${trademarkImageData}" class="word-img" alt="å•†æ ‡å›¾æ ·" style="width:40px; height:40px; object-fit: contain; display: block; margin: 0 auto;">`;
                } else {
                    html += `<span style="font-size:8pt; display: block; line-height: 1.2;">æ— å›¾æ ·</span>`;
                }
                html += `</td>
                    <td style="text-align: center;">${escapeHtml(major)}</td>
                    <td>${subText}</td>
                </tr>`;
                idx++;
            }
            html += `</table>`;

            html += `<h2 style="color: #1f3a5f; margin: 6px 0 3px; font-size: 11pt; border-left: 3px solid #003d7c; padding-left: 4px;">ä¸‰ã€è´¹ç”¨æ˜ç»†</h2>`;
            html += `<div class="word-bg-scheme">ï¼ˆä¸€ï¼‰æœåŠ¡æ–¹æ¡ˆ: ${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)} </div>`;
            html += `<div>ğŸ’° åŸºç¡€ä»·æ ¼ï¼šæ¯å¤§ç±»${d.params.base}å…ƒï¼ˆå«10ä¸ªå°ç±»ï¼‰ï¼Œè¶…å‡ºéƒ¨åˆ†${d.params.extra}å…ƒ/å°ç±»ã€‚</div>`;
            if (d.scheme === 'A') html += `<div>Aæ–¹æ¡ˆæš‚æ— å¤§å®¢æˆ·ä¼˜æƒ ã€‚</div>`;
            if (d.scheme === 'B') html += `<div>ğŸ Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šä¸€æ¬¡æ€§ä¸‹å•å¤§ç±»ï¼6ä¸ªï¼Œæ€»é‡‘é¢ç«‹å‡15%ï¼</div>`;
            if (d.scheme === 'C') html += `<div>ğŸ Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šä¸€æ¬¡æ€§ä¸‹å•å¤§ç±»ï¼6ä¸ªï¼Œå°¾æ¬¾å‡å…15%ï¼</div>`;
            html += `<div>ğŸ’³ ä»˜æ¬¾æ–¹å¼: ${d.scheme === 'C' ? 'é¦–ä»˜300å…ƒ/å¤§ç±»é¦–æœŸæ¬¾ï¼Œå‰©ä½™å°¾æ¬¾800å…ƒå¾…ä¸‹è¯åæ”¯ä»˜ã€‚' : 'ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…'}</div>`;

            html += `<div class="word-bg-fee">ï¼ˆäºŒï¼‰è´¹ç”¨æ˜ç»†ï¼š</div>`;
            for (const major in d.majorDetails) {
                const item = d.majorDetails[major];
                html += `<div>ğŸ“Œç¬¬${escapeHtml(major)}å¤§ç±»ï¼ˆæœ‰${item.count}ä¸ªå°ç±»ï¼‰ = ${item.originalCost.toFixed(2)}å…ƒ</div>`;
            }
            html += `<div>ğŸ“Š å°è®¡ï¼ˆåŸä»·ï¼‰: ${d.totalOriginal.toFixed(2)}å…ƒ</div>`;
            if (d.discountNote) {
                html += `<div>ğŸ‰ ã€${d.discountNote}ã€‘</div>`;
                html += `<div>ğŸ“Š å°è®¡ï¼ˆä¼˜æƒ åï¼‰: ${d.finalTotal.toFixed(2)}å…ƒ</div>`;
            }
            if (d.withInvoice) {
                html += `<div>ğŸ§¾ ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰: ${d.invoiceAmount.toFixed(2)}å…ƒ</div>`;
                html += `<div class="word-total-red">ğŸ’ æ€»åˆè®¡ï¼ˆå«ä¸“ç¥¨ï¼‰: ${d.totalWithInvoice.toFixed(2)}å…ƒ</div>`;
            } else {
                html += `<div>ğŸ§¾ å‘ç¥¨ç±»å‹: å¢å€¼ç¨æ™®é€šå‘ç¥¨</div>`;
                html += `<div class="word-total-red">ğŸ’ æ€»åˆè®¡: ${d.finalTotal.toFixed(2)}å…ƒ</div>`;
            }

            if (d.scheme === 'C') {
                let firstTotal = 0, tailTotal = 0;
                for (const major in d.majorDetails) {
                    firstTotal += d.majorDetails[major].firstPay;
                    tailTotal += d.majorDetails[major].tail;
                }
                if (d.withInvoice) {
                    firstTotal = firstTotal * 1.05;
                    tailTotal = tailTotal * 1.05;
                }
                html += `<div class="word-bg-payment-plan">ï¼ˆä¸‰ï¼‰ã€Cæ–¹æ¡ˆÂ·åˆ†æœŸä»˜è´¹è®¡åˆ’ã€‘</div>`;
                html += `<div>ğŸ”¹ é¦–æœŸæ¬¾ï¼ˆç­¾åˆåŒåï¼‰: ${firstTotal.toFixed(2)}å…ƒ ${d.withInvoice ? '(å«ä¸“ç¥¨)' : '(æ™®ç¥¨)'}</div>`;
                html += `<div>ğŸ”¹ æœåŠ¡å°¾æ¬¾ï¼ˆä¸‹è¯åæ”¯ä»˜ï¼‰: æ¯ä¸ªå¤§ç±»ä¸‹å‘æ³¨å†Œè¯åæ”¯ä»˜ï¼Œå…·ä½“é‡‘é¢å¦‚ä¸‹ï¼š</div>`;
                let subIdx = 1;
                for (const major in d.majorDetails) {
                    let tail = d.majorDetails[major].tail;
                    if (d.withInvoice) tail = tail * 1.05;
                    const circleNum = getCircledNumber(subIdx);
                    html += `<div> ${circleNum} ç¬¬${escapeHtml(major)}å¤§ç±»å°¾æ¬¾ï¼š${tail.toFixed(2)}å…ƒ</div>`;
                    subIdx++;
                }
            } else {
                html += `<div class="word-bg-payment-plan">ï¼ˆä¸‰ï¼‰ã€${escapeHtml(d.scheme)}æ–¹æ¡ˆÂ·ä»˜æ¬¾è®¡åˆ’ã€‘</div>`;
                const payAmount = d.withInvoice ? d.totalWithInvoice : d.finalTotal;
                html += `<div>ğŸ“… ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…: ${payAmount.toFixed(2)}å…ƒ ${d.withInvoice ? '(å«ä¸“ç¥¨)' : '(æ™®ç¥¨)'}</div>`;
            }

            html += `<div class="word-bg-payment-info">ä»˜æ¬¾ä¿¡æ¯ï¼š</div>`;
            html += `<div>è´¦æˆ·åç§°ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</div>`;
            html += `<div>è´¦æˆ·å·ç ï¼š4405 0158 0107 0000 4275</div>`;
            html += `<div>å¼€æˆ·é“¶è¡Œï¼šä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸å¹¿å·èŠ±åŸæ”¯è¡Œ</div>`;
            html += `<div class="word-bg-important">ã€ğŸ“Œ é‡è¦æç¤ºã€‘</div>`;
            html += `<div>1. ä¸‹å•åè¯·å°†ä»˜æ¬¾æ°´å•æˆªå›¾å‘ç»™é™ˆå·¥ï¼›</div>`;
            html += `<div>2. å› æˆ‘ä»¬æ˜¯æä¾›çŸ¥è¯†æœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡åä¸æ”¯æŒé€€æ¬¾ï¼›</div>`;
            html += `<div>3. å¦‚æ‚¨ä¼ä¸šæœ‰åŒ…å¹´å®šåˆ¶åŒ–éœ€æ±‚ï¼Œè”ç³»é™ˆå·¥ï¼š13128311370</div>`;
            html += `<div>4. æœåŠ¡æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-18:00</div>`;

            html += `<div style="margin-top: 8px; text-align: center; color: #999; font-size: 8pt; border-top: 1px solid #eee; padding-top: 3px;">æœ¬è®¢å•ç”±ä¼ä¼˜å’¨å•†æ ‡ç”³è¯·ç³»ç»Ÿç”Ÿæˆ Â· å’¨è¯¢çƒ­çº¿ï¼š13128311370</div>`;

            return html;
        }

        // æ¸²æŸ“é¢„è§ˆé¢æ¿å†…å®¹ï¼ˆä¿æŒåŸæ ·ï¼‰
        function renderPreviewPanel() {
            const applicant = cleanInput(document.getElementById('applicantName').value);
            const tmName = cleanInput(document.getElementById('trademarkName').value);
            const phone = cleanInput(document.getElementById('contactPhone').value);
            const contact = cleanInput(document.getElementById('contactPerson').value);
            const stats = getSelectedStats();
            const d = computeFeeDetails();
            const previewContent = document.getElementById('previewContent');

            if (!applicant || !tmName || stats.totalSubCount === 0) {
                previewContent.innerHTML = '<div class="empty-state">è¯·å¡«å†™ç”³è¯·äººå…¨ç§°ã€å•†æ ‡åç§°å¹¶é€‰æ‹©å°ç±»åé¢„è§ˆ</div>';
                return;
            }

            const html = generateOrderPreviewHtml(applicant, tmName, phone, contact, stats, d, trademarkImageData);
            previewContent.innerHTML = html;
        }

        // é€‰é¡¹å¡åˆ‡æ¢ (ä¿æŒåŸæ ·)
        const tabStep1 = document.getElementById('tabStep1');
        const tabStep2 = document.getElementById('tabStep2');
        const tabStep3 = document.getElementById('tabStep3');
        const tabPreview = document.getElementById('tabPreview');
        const tabFlow = document.getElementById('tabFlow');
        const panel1 = document.getElementById('step1Panel');
        const panel2 = document.getElementById('step2Panel');
        const panel3 = document.getElementById('step3Panel');
        const panelPreview = document.getElementById('previewPanel');
        const panelFlow = document.getElementById('flowPanel');
        const panels = [panel1, panel2, panel3, panelPreview, panelFlow];
        const tabs = [tabStep1, tabStep2, tabStep3, tabPreview, tabFlow];

        function activateTab(selectedTab) {
            tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
                t.setAttribute('tabindex', '-1');
            });
            selectedTab.classList.add('active');
            selectedTab.setAttribute('aria-selected', 'true');
            selectedTab.setAttribute('tabindex', '0');

            panels.forEach(p => p.style.display = 'none');
            if (selectedTab === tabStep1) panel1.style.display = 'block';
            else if (selectedTab === tabStep2) panel2.style.display = 'block';
            else if (selectedTab === tabStep3) { panel3.style.display = 'block'; refreshUI(); }
            else if (selectedTab === tabPreview) { panelPreview.style.display = 'block'; renderPreviewPanel(); }
            else if (selectedTab === tabFlow) panelFlow.style.display = 'block';
        }

        tabStep1.addEventListener('click', () => activateTab(tabStep1));
        tabStep2.addEventListener('click', () => activateTab(tabStep2));
        tabStep3.addEventListener('click', () => activateTab(tabStep3));
        tabPreview.addEventListener('click', () => activateTab(tabPreview));
        tabFlow.addEventListener('click', () => activateTab(tabFlow));

        document.querySelector('.tab-bar').addEventListener('keydown', function(e) {
            const currentIndex = tabs.findIndex(t => t.classList.contains('active'));
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                const next = (currentIndex + 1) % tabs.length;
                activateTab(tabs[next]);
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                const prev = (currentIndex - 1 + tabs.length) % tabs.length;
                activateTab(tabs[prev]);
            }
        });

        document.getElementById('previewOrderBtn').addEventListener('click', function() {
            activateTab(tabPreview);
        });

        // ========== ä¿®æ”¹åçš„å¯¼å‡ºPDFè®¢å•ï¼ˆåŸå¯¼å‡ºWordï¼‰ ==========
        function exportWord() {
            const applicant = cleanInput(document.getElementById('applicantName').value);
            const tmName = cleanInput(document.getElementById('trademarkName').value);
            const phone = cleanInput(document.getElementById('contactPhone').value);
            const contact = cleanInput(document.getElementById('contactPerson').value);

            if (!applicant || !tmName) {
                alert('è¯·å¡«å†™ç”³è¯·äººå…¨ç§°å’Œå•†æ ‡åç§°');
                document.getElementById('applicantName').focus();
                return;
            }
            
            const stats = getSelectedStats();
            if (stats.totalSubCount === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°ç±»');
                document.getElementById('searchInput').focus();
                return;
            }

            const d = computeFeeDetails();
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const orderNo = `ZCXD-${year}${month}${day}${hours}${minutes}${seconds}`;

            // --- ç”Ÿæˆæ–‡ä»¶åï¼šç”³è¯·äººå…¨ç§°_å•†æ ‡åç§°_å•†æ ‡å¤§ç±»_è®¢å•_æ—¥æœŸ ---
            const majorKeys = Object.keys(selectedSubclasses).filter(m => selectedSubclasses[m].length > 0);
            const majorStr = majorKeys.join('_');
            const dateStr = `${year}${month}${day}`; // å¹´æœˆæ—¥
            const safeApplicant = applicant.replace(/[\\/*?:"<>|]/g, '_');
            const safeTmName = tmName.replace(/[\\/*?:"<>|]/g, '_');
            const fileName = `${safeApplicant}_${safeTmName}_${majorStr}_è®¢å•_${dateStr}`;

            let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='UTF-8'><title>${fileName}</title>
            <style>
                body { font-family: 'å®‹ä½“', SimSun, serif; margin: 0.6cm; font-size: 10.5pt; line-height: 1.2; color: #333; }
                h1 { color: #003d7c; text-align: center; border-bottom: 2px solid #003d7c; padding-bottom: 3px; font-size: 14pt; margin: 0 0 4px; }
                h2 { color: #1f3a5f; margin: 6px 0 3px; font-size: 11pt; border-left: 3px solid #003d7c; padding-left: 4px; }
                p { margin: 0 0 2px; }
                div { margin: 0 0 2px; }
                .info-table { border-collapse: collapse; width: 100%; margin: 4px 0; }
                .info-table td { border: 1px solid #999; padding: 4px; }
                .info-table td:first-child { font-weight: bold; background: #f5f5f5; width: 30%; }
                .word-table { border-collapse: collapse; width: 100%; margin: 4px 0; font-size: 10pt; }
                .word-table th { background: #e8e8e8; border: 1px solid #999; padding: 4px; text-align: center; font-weight: bold; }
                .word-table td { border: 1px solid #999; padding: 6px; vertical-align: top; }
                .word-img { width: 40px; height: 40px; object-fit: contain; display: block; margin: 0 auto; }
                .bg-scheme, .bg-fee, .bg-payment-plan, .bg-payment-info, .bg-important { padding: 2px 4px; margin: 2px 0; }
                .total-red { color: #C00000; font-weight: bold; }
                .footer { margin-top: 8px; text-align: center; color: #999; font-size: 8pt; border-top: 1px solid #eee; padding-top: 3px; }
                @media print {
                    body { margin: 1cm; }
                    table { page-break-inside: avoid; }
                    tr { page-break-inside: avoid; }
                    thead { display: table-header-group; }
                    .footer { position: fixed; bottom: 0; width: 100%; }
                }
            </style>
            </head>
            <body>
            <h1>ğŸ“„ å•†æ ‡ç”³è¯·è®¢å•</h1>
            
            <h2>ä¸€ã€åŸºæœ¬ä¿¡æ¯</h2>
            <table class="info-table">
                <tr><td>ç”³è¯·äººå…¨ç§°ï¼š</td><td>${escapeHtml(applicant)}</td></tr>
                <tr><td>è”ç³»äººå§“åï¼š</td><td>${escapeHtml(contact || 'æœªå¡«å†™')}</td></tr>
                <tr><td>è”ç³»ç”µè¯ï¼š</td><td>${escapeHtml(phone || 'æœªå¡«å†™')}</td></tr>
                <tr><td>è®¢å•å·ï¼š</td><td>${orderNo}</td></tr>
                <tr><td>ä¸‹è®¢å•æ—¥æœŸï¼š</td><td>${today}</td></tr>
                <tr><td>æœåŠ¡æ–¹æ¡ˆï¼š</td><td>${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}</td></tr>
                <tr><td>æ–¹æ¡ˆæè¿°ï¼š</td><td>${d.scheme === 'A' ? 'é€‚åˆéœ€æ±‚ï¼šæ‚¨æ‡‚å•†æ ‡ä½†äº‹åŠ¡ç¹å¿™ï¼Ÿæµç¨‹è·Ÿè¿›å¸®æ‚¨çœå¿ƒçœåŠ›ã€‚æœåŠ¡å†…å®¹ï¼šææ–™å½¢å¼å®¡æ ¸ã€å®˜æ–¹æ–‡ä»¶ä»£æ”¶ä»£å‘ã€å…³é”®èŠ‚ç‚¹äººå·¥æé†’ã€å…¨æµç¨‹è¿›åº¦åŒæ­¥ã€‚' : d.scheme === 'B' ? 'é€‚åˆéœ€æ±‚ï¼šå¸Œæœ›æå‡å•†æ ‡æ³¨å†Œè§„èŒƒæ€§ï¼Ÿä¸“ä¸šè¾…å¯¼ä¸ºæ‚¨ä¿é©¾æŠ¤èˆªã€‚æœåŠ¡å†…å®¹ï¼šæ³¨å†Œå‰é£é™©è¯„ä¼°ã€ç±»åˆ«è§„åˆ’å»ºè®®ã€ç”³è¯·ææ–™ä¼˜åŒ–ã€ä¸“ä¸šè§£è¯»ä¸æŒ‡å¯¼ã€‚' : 'é€‚åˆéœ€æ±‚ï¼šæ‹…å¿ƒæ³¨å†Œä¸ä¸‹æ¥ï¼ŒæœåŠ¡è´¹ç™½ç»™ï¼Ÿåˆ†æœŸä»˜è´¹è®©æ‚¨æ›´ä»å®¹ã€‚æœåŠ¡å†…å®¹ï¼šå¯åŠ¨æˆæœ¬æ›´ä½ï¼Œä»…ä»˜é¦–æœŸæ¬¾ï¼›ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åå†ä»˜æœåŠ¡è´¹ï¼'}</td></tr>
                </table>

            <h2>äºŒã€å·²é€‰ç±»åˆ«æ˜ç»†</h2>
            <table class="word-table" style="table-layout: fixed;">
                <colgroup>
                    <col style="width: 8%;">
                    <col style="width: 15%;">
                    <col style="width: 60px;">
                    <col style="width: 10%;">
                    <col style="width: auto;">
                </colgroup>
                <tr>
                    <th style="width: 8%;">åºå·</th>
                    <th style="width: 15%;">å•†æ ‡åç§°</th>
                    <th style="width: 60px;">å•†æ ‡å›¾æ ·</th>
                    <th style="width: 10%;">å·²é€‰å¤§ç±»</th>
                    <th>å°ç±»</th>
                </tr>
            `;
            let idx = 1;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                const subText = selectedSubclasses[major].map(s => escapeHtml(s)).join('ï¼›');
                htmlContent += `<tr>
                    <td style="text-align: center;">${idx}</td>
                    <td style="text-align: center;">${escapeHtml(tmName)}</td>
                    <td style="width:60px; height:40px; padding:0; text-align:center; vertical-align:middle; font-size:0; line-height:0;">`;
                if (trademarkImageData) {
                    htmlContent += `<img src="${trademarkImageData}" class="word-img" alt="å•†æ ‡å›¾æ ·" style="width:40px; height:40px; object-fit: contain; display: block; margin: 0 auto;">`;
                } else {
                    htmlContent += `<span style="font-size:8pt; display: block; line-height: 1.2;">æ— å›¾æ ·</span>`;
                }
                htmlContent += `</td>
                    <td style="text-align: center;">${escapeHtml(major)}</td>
                    <td>${subText}</td>
                </tr>`;
                idx++;
            }
            htmlContent += `</table>`;

            htmlContent += `<h2>ä¸‰ã€è´¹ç”¨æ˜ç»†</h2>`;
            htmlContent += `<div class="bg-scheme">ï¼ˆä¸€ï¼‰æœåŠ¡æ–¹æ¡ˆ: ${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â·${escapeHtml(d.params.name)} </div>`;
            htmlContent += `<div>ğŸ’° åŸºç¡€ä»·æ ¼ï¼šæ¯å¤§ç±»${d.params.base}å…ƒï¼ˆå«10ä¸ªå°ç±»ï¼‰ï¼Œè¶…å‡ºéƒ¨åˆ†${d.params.extra}å…ƒ/å°ç±»ã€‚</div>`;
            if (d.scheme === 'A') htmlContent += `<div>Aæ–¹æ¡ˆæš‚æ— å¤§å®¢æˆ·ä¼˜æƒ ã€‚</div>`;
            if (d.scheme === 'B') htmlContent += `<div>ğŸ Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šä¸€æ¬¡æ€§ä¸‹å•å¤§ç±»ï¼6ä¸ªï¼Œæ€»é‡‘é¢ç«‹å‡15%ï¼</div>`;
            if (d.scheme === 'C') htmlContent += `<div>ğŸ Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šä¸€æ¬¡æ€§ä¸‹å•å¤§ç±»ï¼6ä¸ªï¼Œå°¾æ¬¾å‡å…15%ï¼</div>`;
            htmlContent += `<div>ğŸ’³ ä»˜æ¬¾æ–¹å¼: ${d.scheme === 'C' ? 'é¦–ä»˜300å…ƒ/å¤§ç±»é¦–æœŸæ¬¾ï¼Œå‰©ä½™å°¾æ¬¾800å…ƒå¾…ä¸‹è¯åæ”¯ä»˜ã€‚' : 'ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…ã€‚'}</div>`;

            htmlContent += `<div class="bg-fee">ï¼ˆäºŒï¼‰è´¹ç”¨æ˜ç»†ï¼š</div>`;
            for (const major in d.majorDetails) {
                const item = d.majorDetails[major];
                htmlContent += `<div>ğŸ“Œ ç¬¬${escapeHtml(major)}å¤§ç±»ï¼ˆæœ‰${item.count}ä¸ªå°ç±»ï¼‰ = ${item.originalCost.toFixed(2)}å…ƒ</div>`;
            }
            htmlContent += `<div>ğŸ“Š å°è®¡ï¼ˆåŸä»·ï¼‰: ${d.totalOriginal.toFixed(2)}å…ƒ</div>`;
            if (d.discountNote) {
                htmlContent += `<div>ğŸ‰ ã€${d.discountNote}ã€‘</div>`;
                htmlContent += `<div>ğŸ“Š å°è®¡ï¼ˆä¼˜æƒ åï¼‰: ${d.finalTotal.toFixed(2)}å…ƒ</div>`;
            }
            if (d.withInvoice) {
                htmlContent += `<div>ğŸ§¾ ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰: ${d.invoiceAmount.toFixed(2)}å…ƒ</div>`;
                htmlContent += `<div class="total-red">ğŸ’ æ€»åˆè®¡ï¼ˆå«ä¸“ç¥¨ï¼‰: ${d.totalWithInvoice.toFixed(2)}å…ƒ</div>`;
            } else {
                htmlContent += `<div>ğŸ§¾ å‘ç¥¨ç±»å‹: å¢å€¼ç¨æ™®é€šå‘ç¥¨</div>`;
                htmlContent += `<div class="total-red">ğŸ’ æ€»åˆè®¡: ${d.finalTotal.toFixed(2)}å…ƒ</div>`;
            }

            if (d.scheme === 'C') {
                let firstTotal = 0, tailTotal = 0;
                for (const major in d.majorDetails) {
                    firstTotal += d.majorDetails[major].firstPay;
                    tailTotal += d.majorDetails[major].tail;
                }
                if (d.withInvoice) {
                    firstTotal = firstTotal * 1.05;
                    tailTotal = tailTotal * 1.05;
                }
                htmlContent += `<div class="bg-payment-plan">ï¼ˆä¸‰ï¼‰ã€Cæ–¹æ¡ˆÂ·åˆ†æœŸä»˜è´¹è®¡åˆ’ã€‘</div>`;
                htmlContent += `<div>ğŸ”¹ é¦–æœŸæ¬¾ï¼ˆç­¾åˆåŒåï¼‰: ${firstTotal.toFixed(2)}å…ƒ ${d.withInvoice ? '(å«ä¸“ç¥¨)' : '(æ™®ç¥¨)'}</div>`;
                htmlContent += `<div>ğŸ”¹ æœåŠ¡å°¾æ¬¾ï¼ˆä¸‹è¯åæ”¯ä»˜ï¼‰: æ¯ä¸ªå¤§ç±»ä¸‹å‘æ³¨å†Œè¯åæ”¯ä»˜ï¼Œå…·ä½“é‡‘é¢å¦‚ä¸‹ï¼š</div>`;
                let subIdx = 1;
                for (const major in d.majorDetails) {
                    let tail = d.majorDetails[major].tail;
                    if (d.withInvoice) tail = tail * 1.05;
                    const circleNum = getCircledNumber(subIdx);
                    htmlContent += `<div>${circleNum} ç¬¬${escapeHtml(major)}å¤§ç±»å°¾æ¬¾ï¼š${tail.toFixed(2)}å…ƒ</div>`;
                    subIdx++;
                }
            } else {
                htmlContent += `<div class="bg-payment-plan">ï¼ˆä¸‰ï¼‰ã€${escapeHtml(d.scheme)}æ–¹æ¡ˆÂ·ä»˜æ¬¾è®¡åˆ’ã€‘</div>`;
                const payAmount = d.withInvoice ? d.totalWithInvoice : d.finalTotal;
                htmlContent += `<div>ğŸ“… ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…: ${payAmount.toFixed(2)}å…ƒ ${d.withInvoice ? '(å«ä¸“ç¥¨)' : '(æ™®ç¥¨)'}</div>`;
            }

            htmlContent += `<div class="bg-payment-info">ä»˜æ¬¾ä¿¡æ¯ï¼š</div>`;
            htmlContent += `<div>è´¦æˆ·åç§°ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</div>`;
            htmlContent += `<div>è´¦æˆ·å·ç ï¼š4405 0158 0107 0000 4275</div>`;
            htmlContent += `<div>å¼€æˆ·é“¶è¡Œï¼šä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸å¹¿å·èŠ±åŸæ”¯è¡Œ</div>`;
            htmlContent += `<div class="bg-important">ã€ğŸ“Œ é‡è¦æç¤ºã€‘</div>`;
            htmlContent += `<div>1. ä¸‹å•åè¯·å°†ä»˜æ¬¾æ°´å•æˆªå›¾å‘ç»™é™ˆå·¥ï¼›</div>`;
            htmlContent += `<div>2. å› æˆ‘ä»¬æ˜¯æä¾›çŸ¥è¯†æœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡åä¸æ”¯æŒé€€æ¬¾ï¼›</div>`;
            htmlContent += `<div>3. å¦‚æ‚¨ä¼ä¸šæœ‰åŒ…å¹´å®šåˆ¶åŒ–éœ€æ±‚ï¼Œè”ç³»é™ˆå·¥ï¼š13128311370</div>`;
            htmlContent += `<div>4. æœåŠ¡æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-18:00</div>`;

            htmlContent += `
            <div class="footer">
                æœ¬è®¢å•ç”±ä¼ä¼˜å’¨å•†æ ‡ç”³è¯·ç³»ç»Ÿç”ŸæˆÂ·å’¨è¯¢çƒ­çº¿ï¼š13128311370
            </div>
            </body></html>`;

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦é˜»æ­¢äº†å¼¹çª—ã€‚');
                return;
            }
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.document.title = fileName;  // è®¾ç½®PDFé»˜è®¤æ–‡ä»¶å
            printWindow.focus();
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }

        // ========== ä¿®æ”¹åçš„ç”ŸæˆPDFåˆåŒï¼ˆåŸç”ŸæˆåˆåŒï¼‰ ==========
        function generateContract() {
            const applicant = cleanInput(document.getElementById('applicantName').value);
            const tmName = cleanInput(document.getElementById('trademarkName').value);
            const phone = cleanInput(document.getElementById('contactPhone').value);
            const contact = cleanInput(document.getElementById('contactPerson').value);

            if (!applicant || !tmName) {
                alert('è¯·å¡«å†™ç”³è¯·äººå…¨ç§°å’Œå•†æ ‡åç§°');
                return;
            }
            
            const stats = getSelectedStats();
            if (stats.totalSubCount === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°ç±»');
                return;
            }

            const d = computeFeeDetails();
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            const contractNo = `QYZ-TM-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`;

            // --- ç”Ÿæˆæ–‡ä»¶åï¼šç”³è¯·äººå…¨ç§°_å•†æ ‡åç§°_å•†æ ‡å¤§ç±»_æœåŠ¡åˆåŒ_æ—¥æœŸ ---
            const majorKeys = Object.keys(selectedSubclasses).filter(m => selectedSubclasses[m].length > 0);
            const majorStr = majorKeys.join('_');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            const safeApplicant = applicant.replace(/[\\/*?:"<>|]/g, '_');
            const safeTmName = tmName.replace(/[\\/*?:"<>|]/g, '_');
            const fileName = `${safeApplicant}_${safeTmName}_${majorStr}_æœåŠ¡åˆåŒ_${dateStr}`;

            let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='UTF-8'><title>${fileName}</title>
            <style>
                body { font-family: 'å®‹ä½“', SimSun, serif; margin: 0.6cm; font-size: 10.5pt; line-height: 1.2; color: #333; }
                h1 { text-align: center; color: #003d7c; font-size: 16pt; margin: 0 0 4px; }
                .contract-no { text-align: center; color: #666; margin: 0 0 4px; font-size: 9pt; }
                h2 { color: #1f3a5f; font-size: 11pt; margin: 6px 0 3px; border-bottom: 1px solid #003d7c; padding-bottom: 2px; }
                .party { margin: 2px 0; }
                .party-title { font-weight: bold; color: #003d7c; }
                p { margin: 0 0 2px; }
                div { margin: 0 0 2px; }
                table { border-collapse: collapse; width: 100%; margin: 4px 0; font-size: 10pt; }
                th, td { border: 1px solid #333; padding: 4px; vertical-align: top; }
                th { background: #e8e8e8; text-align: center; }
                .highlight { background: #fffbeb; padding: 2px 4px; border-left: 3px solid #f59e0b; margin: 2px 0; }
                .underline-red { text-decoration: underline; color: red; }
                .signature-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                .signature-table td { border: none; padding: 4px 8px; vertical-align: bottom; }
                .signature-line { border-bottom: 1px solid #000; height: 20px; width: 100%; }
                .total-row { font-weight: bold; color: #C00000; background: #f0f0f0; }
                .bg-payment-plan { background-color: #FFF2CC; padding: 2px 4px; }
                .bg-payment-info { background-color: #E6E6FA; padding: 2px 4px; }
                .word-img { width: 40px; height: 40px; object-fit: contain; display: block; margin: 0 auto; }
                @media print {
                    body { margin: 1cm; }
                    table { page-break-inside: avoid; }
                    tr { page-break-inside: avoid; }
                    thead { display: table-header-group; }
                }
            </style>
            </head>
            <body>
            <h1>ğŸ“ å•†æ ‡ç”³è¯·ä»£ç†æœåŠ¡åˆåŒ</h1>
            <div class="contract-no">åˆåŒç¼–å·ï¼š${contractNo} &nbsp;&nbsp;&nbsp; ç­¾è®¢æ—¥æœŸï¼š${today}</div>

            <h2>ç¬¬ä¸€æ¡ ç”²æ–¹ï¼ˆå§”æ‰˜äººä¿¡æ¯ï¼‰</h2>
            <div class="party">
                <div><span class="party-title">å…¬å¸åç§°/ä¸ªäººå§“åï¼š</span>${escapeHtml(applicant)}</div>
                <!-- ä»¥ä¸‹ä¸¤è¡Œä¿®æ”¹ï¼šåˆ é™¤(å¡«å†™è¯¦ç»†)ï¼Œæ”¹ä¸ºflexä¸‹åˆ’çº¿å æ»¡æ•´è¡Œ -->
                <div style="display: flex; align-items: baseline;">
                    <span class="party-title" style="white-space: nowrap;">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /èº«ä»½è¯å·ç ï¼š</span>
                    <span style="flex: 1; border-bottom: 1px solid red; margin-left: 8px;">&nbsp;</span>
                </div>
                <div style="display: flex; align-items: baseline;">
                    <span class="party-title" style="white-space: nowrap;">å·¥å•†æ³¨å†Œåœ°å€/èº«ä»½è¯åœ°å€ï¼š</span>
                    <span style="flex: 1; border-bottom: 1px solid red; margin-left: 8px;">&nbsp;</span>
                </div>
                <div><span class="party-title">è”ç³»äººï¼š</span>${escapeHtml(contact || '____________________')}</div>
                <div><span class="party-title">ç”µè¯å·ç ï¼š</span>${escapeHtml(phone || '____________________')}</div>
            </div>

            <h2>ç¬¬äºŒæ¡ ä¹™æ–¹ï¼ˆå—æ‰˜äººä¿¡æ¯ï¼‰</h2>
            <div class="party">
                <div><span class="party-title">å…¬å¸åç§°ï¼š</span>ä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</div>
                <div><span class="party-title">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š</span>91440111MADMM9PF77</div>
                <div><span class="party-title">æ³¨å†Œåœ°å€ï¼š</span>å¹¿å·å¸‚å¤©æ²³åŒºä½“è‚²ä¸œè·¯140-148å·2204æˆ¿B51å®¤</div>
                <div><span class="party-title">è”ç³»äººï¼š</span>é™ˆç„•æ³½</div>
                <div><span class="party-title">ç”µè¯å·ç ï¼š</span>13128311370</div>
            </div>

            <p>æ ¹æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹ã€ã€Šä¸­åäººæ°‘å…±å’Œå›½å•†æ ‡æ³•ã€‹ç­‰ç›¸å…³æ³•å¾‹æ³•è§„ï¼Œç”²ä¹™åŒæ–¹æœ¬ç€å¹³ç­‰è‡ªæ„¿ã€è¯šå®ä¿¡ç”¨çš„åŸåˆ™ï¼Œç»å‹å¥½åå•†ï¼Œå°±ç”²æ–¹å§”æ‰˜ä¹™æ–¹ä»£ç†å•†æ ‡ç”³è¯·äº‹å®œï¼Œè¾¾æˆå¦‚ä¸‹åè®®ï¼š</p>

            <h2>ç¬¬ä¸‰æ¡ å§”æ‰˜äº‹é¡¹</h2>
            <p>3.1 ç”²æ–¹å§”æ‰˜ä¹™æ–¹å°±ä»¥ä¸‹å•†æ ‡å‘å›½å®¶çŸ¥è¯†äº§æƒå±€å•†æ ‡å±€ç”³è¯·å•†æ ‡æ³¨å†Œäº‹é¡¹ï¼Œå…·ä½“ç”³è¯·ç±»åˆ«æ˜ç»†å¦‚ä¸‹ï¼š</p>
            <div><span class="party-title">å•†æ ‡ç”³è¯·ä¸»ä½“ï¼š</span>${escapeHtml(applicant)}</div>
            <!-- ä»¥ä¸‹ä¸¤è¡Œä¿®æ”¹ï¼šåˆ é™¤(å¡«å†™è¯¦ç»†)ï¼Œæ”¹ä¸ºflexä¸‹åˆ’çº¿å æ»¡æ•´è¡Œ -->
            <div style="display: flex; align-items: baseline;">
                <span class="party-title" style="white-space: nowrap;">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š</span>
                <span style="flex: 1; border-bottom: 1px solid red; margin-left: 8px;">&nbsp;</span>
            </div>
            <div style="display: flex; align-items: baseline;">
                <span class="party-title" style="white-space: nowrap;">å•†æ ‡æ³¨å†Œåœ°å€ï¼š</span>
                <span style="flex: 1; border-bottom: 1px solid red; margin-left: 8px;">&nbsp;</span>
            </div>

            <h3>å·²é€‰ç±»åˆ«æ˜ç»†</h3>
            <table style="table-layout: fixed;">
                <colgroup>
                    <col style="width: 8%;">
                    <col style="width: 15%;">
                    <col style="width: 60px;">
                    <col style="width: 10%;">
                    <col style="width: auto;">
                </colgroup>
                <tr>
                    <th style="width: 8%;">åºå·</th>
                    <th style="width: 15%;">å•†æ ‡åç§°</th>
                    <th style="width: 60px;">å•†æ ‡å›¾æ ·</th>
                    <th style="width: 10%;">å·²é€‰å¤§ç±»</th>
                    <th>å°ç±»</th>
                </tr>
            `;
            let idx = 1;
            for (const major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                const subText = selectedSubclasses[major].map(s => escapeHtml(s)).join('ï¼›');
                htmlContent += `<tr>
                    <td style="text-align: center;">${idx}</td>
                    <td style="text-align: center;">${escapeHtml(tmName)}</td>
                    <td style="width:60px; height:40px; padding:0; text-align:center; vertical-align:middle; font-size:0; line-height:0;">`;
                if (trademarkImageData) {
                    htmlContent += `<img src="${trademarkImageData}" class="word-img" alt="å•†æ ‡å›¾æ ·" style="width:40px; height:40px; object-fit: contain; display: block; margin: 0 auto;">`;
                } else {
                    htmlContent += `<span style="font-size:8pt; display: block; line-height: 1.2;">æ— å›¾æ ·</span>`;
                }
                htmlContent += `</td>
                    <td style="text-align: center;">${escapeHtml(major)}</td>
                    <td>${subText}</td>
                </tr>`;
                idx++;
            }
            htmlContent += `</table>`;

            htmlContent += `
            <h2>ç¬¬å››æ¡ æœåŠ¡æ–¹æ¡ˆåŠè´¹ç”¨</h2>
            <p>4.1 ç”²æ–¹é€‰æ‹©ä¹™æ–¹æä¾›çš„ã€${escapeHtml(d.scheme)}æ–¹æ¡ˆ Â· ${escapeHtml(d.params.name)}ã€‘æœåŠ¡ã€‚</p>
            <p>    æ–¹æ¡ˆæè¿°ï¼š${d.scheme === 'A' ? 'é€‚åˆéœ€æ±‚ï¼šæ‚¨æ‡‚å•†æ ‡ä½†äº‹åŠ¡ç¹å¿™ï¼Ÿæµç¨‹è·Ÿè¿›å¸®æ‚¨çœå¿ƒçœåŠ›ã€‚æœåŠ¡å†…å®¹ï¼šææ–™å½¢å¼å®¡æ ¸ã€å®˜æ–¹æ–‡ä»¶æ”¶è½¬å‘ã€å…³é”®èŠ‚ç‚¹äººå·¥æé†’ã€å…¨æµç¨‹è¿›åº¦åŒæ­¥ã€‚' : d.scheme === 'B' ? 'é€‚åˆéœ€æ±‚ï¼šå¸Œæœ›æå‡å•†æ ‡æ³¨å†Œè§„èŒƒæ€§ï¼Ÿä¸“ä¸šè¾…å¯¼ä¸ºæ‚¨ä¿é©¾æŠ¤èˆªã€‚æœåŠ¡å†…å®¹ï¼šæ³¨å†Œå‰é£é™©è¯„ä¼°ã€ç±»åˆ«è§„åˆ’å»ºè®®ã€ç”³è¯·ææ–™ä¼˜åŒ–ã€ä¸“ä¸šè§£è¯»ä¸æŒ‡å¯¼ã€‚' : 'é€‚åˆéœ€æ±‚ï¼šæ‹…å¿ƒæ³¨å†Œä¸ä¸‹æ¥ï¼ŒæœåŠ¡è´¹ç™½ç»™ï¼Ÿåˆ†æœŸä»˜è´¹è®©æ‚¨æ›´ä»å®¹ã€‚æœåŠ¡å†…å®¹ï¼šå¯åŠ¨æˆæœ¬æ›´ä½ï¼Œä»…ä»˜é¦–æœŸæ¬¾ï¼›ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åå†ä»˜æœåŠ¡è´¹ï¼'}</p>
            <p>4.2 æœåŠ¡è´¹ç”¨è®¡ç®—æ ‡å‡†è¡¨ï¼š</p>

            <table>
                <tr><th>åºå·</th><th>å·²é€‰å¤§ç±»</th><th>å°ç±»æ•°é‡</th><th>è´¹ç”¨ï¼ˆå…ƒï¼‰</th></tr>
            `;
            let rowIdx = 1;
            for (const major in d.majorDetails) {
                const item = d.majorDetails[major];
                htmlContent += `<tr>
                    <td style="text-align: center;">${rowIdx}</td>
                    <td>${escapeHtml(major)}</td>
                    <td style="text-align: center;">${item.count}</td>
                    <td style="text-align: right;">${item.originalCost.toFixed(2)}</td>
                </tr>`;
                rowIdx++;
            }

            htmlContent += `<tr>
                <td colspan="2" style="text-align: right; font-weight: bold;">å°è®¡ï¼ˆåŸä»·ï¼‰ï¼š</td>
                <td style="text-align: center;">${stats.totalSubCount}</td>
                <td style="text-align: right;">${d.totalOriginal.toFixed(2)}</td>
            </tr>`;

            if (d.discountNote) {
                htmlContent += `<tr>
                    <td colspan="3" style="text-align: right; color: green;">${escapeHtml(d.discountNote)}</td>
                    <td style="text-align: right;">-${(d.totalOriginal - d.finalTotal).toFixed(2)}</td>
                </tr>`;
            }

            if (d.withInvoice) {
                htmlContent += `<tr>
                    <td colspan="3" style="text-align: right;">ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰</td>
                    <td style="text-align: right;">${d.invoiceAmount.toFixed(2)}</td>
                </tr>`;
            }

            htmlContent += `</table>`;

            const totalAmount = (d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2);
            htmlContent += `<p style="font-weight: bold; color: #C00000; margin:2px 0;">åˆåŒæ€»é‡‘é¢ï¼š${totalAmount} å…ƒ ${d.withInvoice ? 'ï¼ˆå«å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼‰' : 'ï¼ˆå¢å€¼ç¨æ™®é€šå‘ç¥¨ï¼‰'}</p>`;

            htmlContent += `<h2>ç¬¬äº”æ¡ ä»˜æ¬¾æ–¹å¼</h2>`;
            if (d.scheme === 'C') {
                let firstTotal = 0, tailTotal = 0;
                for (const major in d.majorDetails) {
                    firstTotal += d.majorDetails[major].firstPay;
                    tailTotal += d.majorDetails[major].tail;
                }
                if (d.withInvoice) {
                    firstTotal = firstTotal * 1.05;
                    tailTotal = tailTotal * 1.05;
                }
                htmlContent += `<p>5.1 ç”²æ–¹é€‰æ‹©Cæ–¹æ¡ˆÂ·åˆ†æœŸä»˜è´¹æœåŠ¡ï¼Œä»˜æ¬¾æ–¹å¼å¦‚ä¸‹ï¼š</p>`;
                htmlContent += `<p>   åˆåŒæ€»é‡‘é¢ï¼š${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}å…ƒ${d.withInvoice ? 'ï¼ˆå«ä¸“ç¥¨ï¼‰' : 'ï¼ˆæ™®ç¥¨ï¼‰'}</p>`;
                htmlContent += `<p>   <strong>é¦–æœŸæ¬¾</strong>ï¼ˆåˆåŒç­¾è®¢å3ä¸ªå·¥ä½œæ—¥å†…ï¼‰ï¼š${firstTotal.toFixed(2)}å…ƒ ${d.withInvoice ? '(å«ä¸“ç¥¨)' : '(æ™®ç¥¨)'}</p>`;
                htmlContent += `<p>   <strong>æœåŠ¡å°¾æ¬¾æ”¯ä»˜ï¼š</strong>æ¯å½“æœ‰ä¸€ä¸ªå¤§ç±»ä¸‹å‘å•†æ ‡æ³¨å†Œè¯åï¼Œç”²æ–¹åº”åœ¨æ”¶åˆ°ä¹™æ–¹é€šçŸ¥ä¹‹æ—¥èµ·3ä¸ªå·¥ä½œæ—¥å†…æ”¯ä»˜è¯¥å¤§ç±»çš„å°¾æ¬¾ã€‚å„å¤§ç±»å°¾æ¬¾é‡‘é¢å¦‚ä¸‹ï¼š</p>`;
                let subIdx = 1;
                for (const major in d.majorDetails) {
                    let tail = d.majorDetails[major].tail;
                    if (d.withInvoice) tail = tail * 1.05;
                    const circle = getCircledNumber(subIdx);
                    htmlContent += `<p> ${circle}ç¬¬${escapeHtml(major)}å¤§ç±»<strong>å°¾æ¬¾</strong>ï¼š${tail.toFixed(2)}å…ƒ</p>`;
                    subIdx++;
                }
            } else {
                htmlContent += `<p>5.1 ç”²æ–¹é€‰æ‹©${escapeHtml(d.scheme)}æ–¹æ¡ˆÂ·${escapeHtml(d.params.name)}æœåŠ¡ï¼Œä»˜æ¬¾æ–¹å¼å¦‚ä¸‹ï¼š</p>`;
                htmlContent += `<p>   åˆåŒæ€»é‡‘é¢ï¼š${(d.withInvoice ? d.totalWithInvoice : d.finalTotal).toFixed(2)}å…ƒ ${d.withInvoice ? '(å«ä¸“ç¥¨)' : '(æ™®ç¥¨)'}</p>`;
                htmlContent += `<p>   ç”²æ–¹åº”äºæœ¬åˆåŒç­¾è®¢ä¹‹æ—¥èµ·3ä¸ªå·¥ä½œæ—¥å†…ï¼Œå°†åˆåŒæ€»é‡‘é¢ä¸€æ¬¡æ€§æ”¯ä»˜è‡³ä¹™æ–¹æŒ‡å®šè´¦æˆ·ã€‚</p>`;
            }

            htmlContent += `
            <p>5.2 ä¹™æ–¹æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯ï¼š</p>
            <p>   è´¦æˆ·åç§°ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</p>
            <p>   è´¦æˆ·å·ç ï¼š4405 0158 0107 0000 4275</p>
            <p>   å¼€æˆ·é“¶è¡Œï¼šä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸å¹¿å·èŠ±åŸæ”¯è¡Œ</p>
            <p>   ${d.withInvoice ? 'ç”²æ–¹å‘é€ç»™ä¹™æ–¹ä»˜æ¬¾æ°´å•åï¼Œä¹™æ–¹åº”åœ¨3ä¸ªå·¥ä½œæ—¥å†…ï¼Œå‘ç”²æ–¹å¼€å…·ç¥¨é¢ç¨ç‡ä¸º1%çš„å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ã€‚' : 'ç”²æ–¹å‘é€ç»™ä¹™æ–¹ä»˜æ¬¾æ°´å•åï¼Œä¹™æ–¹åº”åœ¨3ä¸ªå·¥ä½œæ—¥å†…ï¼Œå‘ç”²æ–¹å¼€å…·ç¥¨é¢ç¨ç‡ä¸º1%çš„å¢å€¼ç¨æ™®é€šå‘ç¥¨ã€‚'}</p>

            <h2>ç¬¬å…­æ¡ åŒæ–¹æƒåˆ©ä¹‰åŠ¡</h2>
            <p>6.1 ç”²æ–¹æƒåˆ©ä¹‰åŠ¡ï¼š</p>
            <p>   ï¼ˆ1ï¼‰ç”²æ–¹åº”ä¿è¯æä¾›çš„å•†æ ‡å›¾æ ·ã€ç”³è¯·äººä¿¡æ¯ç­‰èµ„æ–™çš„çœŸå®æ€§ã€åˆæ³•æ€§ï¼Œä¸å¾—å­˜åœ¨æ¶æ„ç”³è¯·ã€è¹­çƒ­åº¦ç­‰è¿èƒŒå…¬åºè‰¯ä¿—çš„è¡Œä¸ºï¼›</p>
            <p>   ï¼ˆ2ï¼‰ç”²æ–¹åº”æŒ‰çº¦å®šåŠæ—¶æ”¯ä»˜æœåŠ¡è´¹ç”¨ï¼›</p>
            <p>   ï¼ˆ3ï¼‰ç”²æ–¹åº”é…åˆä¹™æ–¹å®Œæˆå•†æ ‡ç”³è¯·æ‰€éœ€ææ–™çš„å‡†å¤‡å’Œæäº¤ï¼›</p>
            <p>   ï¼ˆ4ï¼‰ç”²æ–¹æœ‰æƒéšæ—¶äº†è§£å•†æ ‡ç”³è¯·è¿›å±•æƒ…å†µã€‚</p>
            <p>   ï¼ˆ5ï¼‰é‰´äºä¹™æ–¹æä¾›çš„æœåŠ¡ä¸ºçŸ¥è¯†æœåŠ¡ï¼Œå…·æœ‰ä¸å¯é€†æ€§ï¼Œè‡ªæœåŠ¡å¯åŠ¨ä¹‹æ—¥èµ·ï¼Œç”²æ–¹ä¸å¾—ä»¥ä»»ä½•ç†ç”±è¦æ±‚é€€æ¬¾ã€‚</p>
            <p>6.2 ä¹™æ–¹æƒåˆ©ä¹‰åŠ¡ï¼š</p>
            <p>   ï¼ˆ1ï¼‰ä¹™æ–¹åº”æŒ‰ç…§ä¸“ä¸šæ ‡å‡†å’Œè¡Œä¸šæƒ¯ä¾‹ä¸ºç”²æ–¹æä¾›å§”æ‰˜äº‹é¡¹æœåŠ¡ï¼›</p>
            <p>   ï¼ˆ2ï¼‰ä¹™æ–¹åº”åŠæ—¶å‘ç”²æ–¹æŠ¥å‘Šå•†æ ‡ç”³è¯·è¿›å±•æƒ…å†µï¼›</p>
            <p>   ï¼ˆ3ï¼‰ä¹™æ–¹åº”å¯¹ç”²æ–¹çš„å•†ä¸šç§˜å¯†å’Œå•†æ ‡ä¿¡æ¯äºˆä»¥ä¿å¯†ï¼›</p>
            <p>   ï¼ˆ4ï¼‰å•†æ ‡ç”³è¯·äº‹é¡¹èƒ½å¦æ ¸å‡†ç”±å›½å®¶çŸ¥è¯†äº§æƒå±€å•†æ ‡å±€ä¾æ³•å®¡æŸ¥å†³å®šï¼Œä¹™æ–¹ä¸æ‰¿è¯ºç”³è¯·ç»“æœã€‚</p>

            <h2>ç¬¬ä¸ƒæ¡ è¿çº¦è´£ä»»</h2>
            <p>7.1 ç”²æ–¹æœªæŒ‰çº¦å®šæ”¯ä»˜è´¹ç”¨çš„ï¼Œæ¯é€¾æœŸä¸€æ—¥ï¼Œåº”æŒ‰åº”ä»˜æœªä»˜é‡‘é¢çš„åƒåˆ†ä¹‹äº”å‘ä¹™æ–¹æ”¯ä»˜è¿çº¦é‡‘ã€‚</p>
            <p>7.2 å› ç”²æ–¹æä¾›çš„èµ„æ–™ä¸çœŸå®ã€ä¸å®Œæ•´æˆ–ä¸åˆæ³•å¯¼è‡´å•†æ ‡ç”³è¯·è¢«é©³å›æˆ–äº§ç”Ÿå…¶ä»–æŸå¤±çš„ï¼Œç”±ç”²æ–¹è‡ªè¡Œæ‰¿æ‹…è´£ä»»ã€‚</p>
            <p>7.3 å› ä¹™æ–¹è¿‡é”™å¯¼è‡´ç”³è¯·å¤±è´¥æˆ–å»¶è¯¯çš„ï¼Œä¹™æ–¹åº”ç§¯æé‡‡å–è¡¥æ•‘æªæ–½ã€‚</p>
            <p>7.4 ä»»ä½•ä¸€æ–¹è¿åæœ¬åˆåŒçº¦å®šï¼Œç»™å¯¹æ–¹é€ æˆæŸå¤±çš„ï¼Œåº”æ‰¿æ‹…èµ”å¿è´£ä»»ï¼Œèµ”å¿é‡‘é¢ä»¥ä¸è¶…è¿‡æœ¬åˆåŒæ€»é‡‘é¢ä¸ºé™ã€‚</p>

            <h2>ç¬¬å…«æ¡ åˆåŒæœŸé™</h2>
            <p>8.1 æœ¬åˆåŒè‡ªåŒæ–¹ç­¾å­—ç›–ç« ä¹‹æ—¥èµ·ç”Ÿæ•ˆï¼Œè‡³æœ¬åˆåŒå§”æ‰˜äº‹é¡¹è·å¾—å›½å®¶çŸ¥è¯†äº§æƒå±€å•†æ ‡å±€æ ¸å‡†æˆ–è¢«é©³å›ä¹‹æ—¥ç»ˆæ­¢ã€‚å¦‚æœ‰å…¶å®ƒå§”æ‰˜äº‹é¡¹ï¼Œé¡»å¦å¤–ç­¾è®¢æœåŠ¡åˆåŒã€‚</p>
            <p>8.2 åˆåŒç»ˆæ­¢åï¼ŒåŒæ–¹ä¹‹é—´çš„æƒåˆ©ä¹‰åŠ¡å…³ç³»ç»ˆæ­¢ï¼Œä½†ä¿å¯†æ¡æ¬¾ã€è¿çº¦è´£ä»»æ¡æ¬¾ç­‰ä¸å› åˆåŒç»ˆæ­¢è€Œå¤±æ•ˆã€‚</p>

            <h2>ç¬¬ä¹æ¡ äº‰è®®è§£å†³</h2>
            <p>9.1 å› å±¥è¡Œæœ¬åˆåŒå‘ç”Ÿçš„äº‰è®®ï¼ŒåŒæ–¹åº”å‹å¥½åå•†è§£å†³ï¼›åå•†ä¸æˆçš„ï¼Œä»»ä½•ä¸€æ–¹å‡æœ‰æƒå‘ä¹™æ–¹æ‰€åœ¨åœ°äººæ°‘æ³•é™¢æèµ·è¯‰è®¼ã€‚</p>

            <h2>ç¬¬åæ¡ å…¶ä»–</h2>
            <p>10.1 æœ¬åˆåŒä¸€å¼ä¸¤ä»½ï¼Œç”²ä¹™åŒæ–¹å„æ‰§ä¸€ä»½ï¼Œå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ï¼ˆç”µå­æ–‡ä»¶æˆ–è€…æ‰«æä»¶åŒæ ·æœ‰æ•ˆï¼‰ã€‚</p>
            <p>10.2 æœ¬åˆåŒæœªå°½äº‹å®œï¼ŒåŒæ–¹å¯å¦è¡Œç­¾è®¢è¡¥å……åè®®ï¼Œè¡¥å……åè®®ä¸æœ¬åˆåŒå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ã€‚</p>
            <p>10.3 æœ¬åˆåŒå±¥è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚éœ€å˜æ›´åˆåŒå†…å®¹ï¼Œåº”ç»åŒæ–¹åå•†ä¸€è‡´å¹¶ç­¾è®¢ä¹¦é¢å˜æ›´åè®®ã€‚</p>

            <table class="signature-table">
                <tr>
                    <td style="width: 50%;">
                        <div><strong>ç”²æ–¹ï¼ˆç›–ç« ï¼‰ï¼š</strong></div>
                        <div class="signature-line"></div>
                        <div>æˆæƒä»£è¡¨ï¼š${escapeHtml(contact || '__________')}</div>
                    </td>
                    <td style="width: 50%;">
                        <div><strong>ä¹™æ–¹ï¼ˆç›–ç« ï¼‰ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸</strong></div>
                        <div class="signature-line"></div>
                        <div>æˆæƒä»£è¡¨ï¼šé™ˆç„•æ³½</div>
                    </td>
                </tr>
            </table>
            <p style="text-align: center; margin-top: 8px;">ç­¾è®¢æ—¥æœŸï¼š${today}</p>

            </body></html>`;

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦é˜»æ­¢äº†å¼¹çª—ã€‚');
                return;
            }
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.document.title = fileName;  // è®¾ç½®PDFé»˜è®¤æ–‡ä»¶å
            printWindow.focus();
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }

        document.getElementById('exportWordBtn').addEventListener('click', exportWord);
        document.querySelector('.preview-export-word')?.addEventListener('click', exportWord);
        document.getElementById('generateContractBtn').addEventListener('click', generateContract);
        document.querySelector('.preview-generate-contract')?.addEventListener('click', generateContract);

        // æµç¨‹ç›¸å…³ (ä¿æŒåŸæ ·)
        window.toggleFlowStep = function(el) {
            el.classList.toggle('completed');
            const isCompleted = el.classList.contains('completed');
            el.setAttribute('aria-pressed', isCompleted ? 'true' : 'false');
            const text = el.querySelector('.step-text');
            if (isCompleted) {
                text.classList.add('check-icon');
                if (navigator.vibrate) navigator.vibrate(50);
            } else {
                text.classList.remove('check-icon');
            }
            saveFlowState();
        };

        window.toggleFlowStart = function() {
            const startBox = document.getElementById('flowStartBox');
            startBox.classList.toggle('completed');
            const isCompleted = startBox.classList.contains('completed');
            startBox.setAttribute('aria-pressed', isCompleted ? 'true' : 'false');
            saveFlowState();
        };

        function handleQRImageError(img) {
            img.style.display = 'none';
            const fallback = img.nextElementSibling;
            if (fallback) fallback.style.display = 'flex';
        }

        function handleQRImageLoad(img) {
            img.style.display = 'block';
            const fallback = img.nextElementSibling;
            if (fallback) fallback.style.display = 'none';
        }

        function saveFlowState() {
            const completedSteps = [];
            document.querySelectorAll('.flow-step.completed').forEach((step, index) => {
                completedSteps.push(index);
            });
            const startCompleted = document.querySelector('.start-box.completed') ? true : false;
            try {
                localStorage.setItem('trademarkFlowState', JSON.stringify({
                    steps: completedSteps,
                    start: startCompleted,
                    timestamp: new Date().toISOString()
                }));
            } catch (e) {
                console.warn('æ— æ³•ä¿å­˜æµç¨‹çŠ¶æ€:', e);
            }
        }

        function restoreFlowState() {
            try {
                const saved = localStorage.getItem('trademarkFlowState');
                if (saved) {
                    const state = JSON.parse(saved);
                    const steps = document.querySelectorAll('.flow-step');
                    state.steps.forEach(index => {
                        if (steps[index]) {
                            steps[index].classList.add('completed');
                            steps[index].setAttribute('aria-pressed', 'true');
                            steps[index].querySelector('.step-text').classList.add('check-icon');
                        }
                    });
                    if (state.start) {
                        const startBox = document.getElementById('flowStartBox');
                        if (startBox) {
                            startBox.classList.add('completed');
                            startBox.setAttribute('aria-pressed', 'true');
                        }
                    }
                }
            } catch (e) {
                console.error('æ¢å¤çŠ¶æ€å¤±è´¥', e);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            restoreFlowState();
            document.querySelectorAll('.flow-step, .start-box').forEach(el => {
                el.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        });

        // æ­¥éª¤å¯¼èˆªæŒ‰é’®
        document.querySelectorAll('.step-prev-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const prev = this.dataset.prev;
                if (prev === '1') activateTab(tabStep1);
                else if (prev === '2') activateTab(tabStep2);
                else if (prev === '3') activateTab(tabStep3);
                else if (prev === 'preview') activateTab(tabPreview);
            });
        });
        document.querySelectorAll('.step-next-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const next = this.dataset.next;
                if (next === '2') activateTab(tabStep2);
                else if (next === '3') activateTab(tabStep3);
                else if (next === 'preview') activateTab(tabPreview);
                else if (next === 'flow') activateTab(tabFlow);
            });
        });

        // ä¿å­˜è‰ç¨¿
        document.querySelectorAll('.save-draft-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const applicant = document.getElementById('applicantName')?.value || '';
                const tmName = document.getElementById('trademarkName')?.value || '';
                const phone = document.getElementById('contactPhone')?.value || '';
                const contact = document.getElementById('contactPerson')?.value || '';
                try {
                    localStorage.setItem('trademarkDraft', JSON.stringify({ applicant, tmName, phone, contact, timestamp: new Date().toISOString() }));
                    alert('è‰ç¨¿å·²ä¿å­˜åˆ°æµè§ˆå™¨');
                } catch (e) {
                    alert('ä¿å­˜å¤±è´¥');
                }
            });
        });

        // å¯åŠ¨
        loadJSON();
    })();
</script>
</body>
</html>
