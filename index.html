<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ä¼ä¼˜å’¨Â·å•†æ ‡ç”³è¯·ä¸‹å•ç³»ç»Ÿ (æŠ˜å æ ‘ç‰ˆ)</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, 'å¾®è½¯é›…é»‘', system-ui, -apple-system, sans-serif;
        }
        body {
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 16px;
        }
        .app-container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0,20,60,0.08);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #002856 0%, #003d7c 100%);
            color: white;
            padding: 24px 22px;
        }
        .header h1 {
            font-size: 1.9rem;
            font-weight: 500;
            margin: 0;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }
        .header p {
            margin: 8px 0 0;
            opacity: 0.8;
            font-size: 0.95rem;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr;
            gap: 20px;
            padding: 24px;
            background: #f9fafc;
        }
        .card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.02);
            padding: 20px;
            border: 1px solid rgba(0,40,86,0.06);
        }
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #003d7c;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 2px solid #eef2f6;
            padding-bottom: 10px;
        }
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }
        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d9e1ec;
            border-radius: 40px;
            font-size: 1rem;
            outline: none;
        }
        .search-box input:focus {
            border-color: #003d7c;
            box-shadow: 0 0 0 3px rgba(0,61,124,0.1);
        }
        .tree-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eaeef4;
            border-radius: 20px;
            padding: 8px 4px;
            background: #ffffff;
        }
        /* æŠ˜å å±•å¼€æ ·å¼ */
        .tree-ul {
            list-style: none;
            padding-left: 0;
        }
        .tree-ul ul {
            display: none;  /* é»˜è®¤éšè—å­åˆ—è¡¨ */
            margin-left: 16px;
            padding-left: 8px;
            border-left: 1px dashed #ccc;
        }
        .tree-ul li.expanded > ul {
            display: block; /* å±•å¼€æ—¶æ˜¾ç¤ºå­åˆ—è¡¨ */
        }
        .folder-label {
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            width: 100%;
        }
        .folder-label::before {
            content: "â–¶";   /* æŠ˜å çŠ¶æ€å›¾æ ‡ */
            font-size: 0.8rem;
            color: #003d7c;
            transition: transform 0.1s;
            display: inline-block;
            width: 16px;
        }
        li.expanded > .folder-label::before {
            content: "â–¼";   /* å±•å¼€çŠ¶æ€å›¾æ ‡ */
        }
        .cat-major {
            font-weight: 600;
            color: #1e2f4e;
            background: #f2f6fc;
            padding: 8px 16px;
            border-radius: 30px;
            margin: 12px 0 6px;
            font-size: 1rem;
        }
        .cat-group {
            font-weight: 500;
            color: #2a4b7c;
            padding: 6px 0 4px 12px;
            background: #f8faff;
            border-radius: 20px 0 0 20px;
            margin: 4px 0;
        }
        .subclass-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px 6px 20px;
            border-radius: 30px;
        }
        .subclass-item:hover {
            background: #edf3ff;
        }
        .subclass-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #003d7c;
            flex-shrink: 0;
        }
        .subclass-name {
            font-size: 0.95rem;
            word-break: break-word;
        }
        .selected-list {
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
            background: #f8fafd;
            border-radius: 18px;
            padding: 12px;
            border: 1px solid #dee7f0;
            margin: 15px 0;
        }
        .selected-list ul {
            padding-left: 20px;
        }
        .selected-list li {
            margin: 5px 0;
            color: #1f3a5f;
        }
        .badge {
            background: #d3e5ff;
            color: #003d7c;
            border-radius: 30px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .btn-clear {
            background: white;
            border: 1px solid #ccdae9;
            border-radius: 40px;
            padding: 8px 18px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.1s;
        }
        .btn-clear:hover {
            background: #f0f4fe;
        }
        .form-row {
            margin-bottom: 18px;
        }
        .form-row label {
            display: block;
            font-weight: 500;
            color: #1f3a5f;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        .form-row input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d0ddee;
            border-radius: 40px;
            font-size: 1rem;
            outline: none;
        }
        .form-row input:focus {
            border-color: #003d7c;
            box-shadow: 0 0 0 3px rgba(0,61,124,0.1);
        }
        .upload-area {
            border: 2px dashed #b6cae0;
            border-radius: 24px;
            padding: 24px;
            text-align: center;
            background: #fcfdff;
            cursor: pointer;
            margin: 10px 0;
        }
        .upload-area:hover {
            background: #f2f8ff;
            border-color: #003d7c;
        }
        .preview-box {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            background: #f4f8ff;
            border-radius: 18px;
            padding: 16px;
            min-height: 120px;
            align-items: center;
        }
        .preview-box img {
            max-width: 100%;
            max-height: 160px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .scheme-panel {
            background: #f6faff;
            border-radius: 20px;
            padding: 12px;
        }
        .scheme-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 14px;
            background: white;
            border-radius: 40px;
            margin-bottom: 8px;
            border: 1px solid #e0eaf7;
            cursor: pointer;
        }
        .scheme-option.selected {
            border: 2px solid #003d7c;
            background: #eaf3ff;
        }
        .scheme-option input[type="radio"] {
            accent-color: #003d7c;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        .scheme-name {
            font-weight: 600;
            min-width: 120px;
            font-size: 0.95rem;
        }
        .scheme-desc {
            font-size: 0.85rem;
            color: #2f4b74;
        }
        .invoice-check {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 14px 18px;
            border-radius: 40px;
            border: 1px solid #dae3f0;
            margin: 18px 0;
        }
        .invoice-check input {
            width: 20px;
            height: 20px;
            accent-color: #003d7c;
        }
        .invoice-check label {
            font-weight: 500;
            font-size: 1rem;
        }
        .fee-box {
            background: #f2f6fd;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #c9d8ec;
        }
        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .btn-primary {
            background: #003d7c;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0,61,124,0.2);
            transition: 0.1s;
            flex: 1 1 auto;
        }
        .btn-primary:hover {
            background: #002856;
            transform: scale(0.98);
        }
        .btn-secondary {
            background: white;
            border: 1px solid #b6cae0;
            padding: 14px 24px;
            border-radius: 40px;
            font-weight: 500;
            cursor: pointer;
            flex: 1 1 auto;
        }
        .btn-secondary:hover {
            background: #f2f8ff;
        }
        .footer-info {
            color: #6f7d95;
            padding: 14px 24px;
            border-top: 1px solid #e0e8f2;
            font-size: 0.85rem;
            text-align: right;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 900px) {
            body { padding: 10px; }
            .main-layout {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
            }
            .tree-container { max-height: 400px; }
            .selected-list { max-height: 200px; }
            .fee-box { max-height: 300px; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.5rem; }
            .card { padding: 16px; }
            .subclass-item { padding-left: 10px; }
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">
        <h1>ğŸ“‹ ä¼ä¼˜å’¨ Â· å•†æ ‡ç”³è¯·</h1>
        <p>ç§»åŠ¨/æ¡Œé¢è‡ªé€‚åº” | æŠ˜å æ ‘ç‰ˆ | æ•°æ®åŠ è½½åŒç›®å½•ä¸‹ JSON</p>
    </div>

    <div class="main-layout">
        <!-- å·¦ä¾§ï¼šåˆ†ç±»æ ‘ + æœç´¢ -->
        <div class="card">
            <div class="card-title">ğŸ” ä¸€ã€å•†æ ‡åˆ†ç±»é€‰æ‹©</div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢...">
                <span class="badge" id="searchCount">0 é¡¹</span>
            </div>
            <div class="tree-container" id="treeContainer">
                <ul class="tree-ul" id="categoryTree"></ul>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                <button class="btn-clear" id="clearSelectedBtn">ğŸ§¹ æ¸…ç©ºå·²é€‰</button>
                <span class="badge" id="selectedCountBadge">å·²é€‰ 0 ä¸ªå°ç±»</span>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šå·²é€‰å°ç±» & ç”³è¯·äººä¿¡æ¯ & å›¾æ · -->
        <div class="card">
            <div class="card-title">ğŸ“‹ äºŒã€å·²é€‰å°ç±» & ç”³è¯·äºº</div>
            <div><strong>ğŸ“Œ å·²é€‰å°ç±»åˆ—è¡¨</strong></div>
            <div class="selected-list" id="selectedListContainer">
                <ul id="selectedListUl" style="padding-left: 16px;"></ul>
            </div>

            <div class="form-row">
                <label>ç”³è¯·äººå…¨ç§° <span style="color:#a00;">*</span></label>
                <input type="text" id="applicantName" placeholder="å¦‚ï¼šä¼ä¼˜å’¨æœ‰é™å…¬å¸">
            </div>
            <div class="form-row">
                <label>å•†æ ‡åç§° <span style="color:#a00;">*</span></label>
                <input type="text" id="trademarkName" placeholder="å¦‚ï¼šä¼ä¼˜å’¨">
            </div>
            <div class="form-row">
                <label>è”ç³»ç”µè¯</label>
                <input type="text" id="contactPhone" placeholder="æ‰‹æœº/å›ºè¯">
            </div>
            <div class="form-row">
                <label>è”ç³»äººå§“å</label>
                <input type="text" id="contactPerson" placeholder="å§“å">
            </div>

            <div><strong>ğŸ–¼ï¸ å•†æ ‡å›¾æ ·</strong></div>
            <div class="upload-area" id="uploadArea">
                ğŸ“ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (PNG/JPGç­‰)
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
            <div class="preview-box" id="imagePreview">
                <span style="color:#99aec6;">æš‚æ— é¢„è§ˆ</span>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæœåŠ¡æ–¹æ¡ˆ + è´¹ç”¨ + æ“ä½œ -->
        <div class="card">
            <div class="card-title">ğŸ¯ ä¸‰ã€æœåŠ¡æ–¹æ¡ˆ & è´¹ç”¨</div>
            <div class="scheme-panel">
                <div class="scheme-option" id="schemeA">
                    <input type="radio" name="scheme" value="A" id="radioA" checked> 
                    <span class="scheme-name">Aæ–¹æ¡ˆÂ·æµç¨‹è·Ÿè¿›</span>
                    <span class="scheme-desc">380å…ƒ/å¤§ç±»(å«10å°ç±»)ï¼Œè¶…å‡º38/å°ç±»</span>
                </div>
                <div class="scheme-option" id="schemeB">
                    <input type="radio" name="scheme" value="B" id="radioB"> 
                    <span class="scheme-name">Bæ–¹æ¡ˆÂ·ä¸“ä¸šè¾…å¯¼</span>
                    <span class="scheme-desc">580å…ƒ/å¤§ç±»ï¼Œè¶…å‡º58/å°ç±» å¤§ç±»ï¼6ç«‹å‡15%</span>
                </div>
                <div class="scheme-option" id="schemeC">
                    <input type="radio" name="scheme" value="C" id="radioC"> 
                    <span class="scheme-name">Cæ–¹æ¡ˆÂ·åç½®ä»˜è´¹</span>
                    <span class="scheme-desc">1100å…ƒ/å¤§ç±»ï¼Œè¶…å‡º110/å°ç±» é¦–ä»˜300å®˜è´¹</span>
                </div>

                <div class="invoice-check">
                    <input type="checkbox" id="invoiceCheckbox">
                    <label for="invoiceCheckbox" id="invoiceLabel">ğŸ“„ å¼€ä¸“ç¥¨ï¼ˆåŠ æ”¶5%ï¼‰</label>
                </div>
            </div>

            <div class="fee-box" id="feeDisplay">
                âš ï¸ è¯·å…ˆé€‰æ‹©å°ç±»
            </div>

            <div class="button-group">
                <button class="btn-secondary" id="previewOrderBtn">ğŸ“‹ é¢„è§ˆ</button>
                <button class="btn-primary" id="exportWordBtn">ğŸ“ å¯¼å‡ºWordè®¢å•</button>
            </div>
            <p style="font-size:0.75rem; color:#7f8fa4; margin-top: 8px;">*å¯¼å‡ºæ—¶æµè§ˆå™¨ä¼šæç¤ºä¸‹è½½ï¼Œæ–‡ä»¶å¯ä¿å­˜è‡³æ‰‹æœºã€‚</p>
        </div>
    </div>
    <div class="footer-info">
        æ•°æ®æ¥æº: å°¼æ–¯åˆ†ç±»è¡¨_æ ‘çŠ¶ç»“æ„.json | å®æ—¶è®¡ç®—
    </div>
</div>

<script>
    (function() {
        // ---------- å…¨å±€å˜é‡ ----------
        let rawData = [];
        let selectedSubclasses = {};          // å¤§ç±» -> å°ç±»åç§°æ•°ç»„
        let trademarkImageData = null;         // base64
        let imageFileName = '';

        const schemeParams = {
            A: { base: 380, extra: 38, name: 'æµç¨‹è·Ÿè¿›' },
            B: { base: 580, extra: 58, name: 'ä¸“ä¸šè¾…å¯¼' },
            C: { base: 1100, extra: 110, name: 'åç½®ä»˜è´¹' }
        };

        // ---------- å·¥å…·å‡½æ•° ----------
        function cleanInput(str) {
            return str.replace(/\s+/g, '');
        }

        function getSelectedStats() {
            let majorCount = 0, totalSubCount = 0;
            for (let major in selectedSubclasses) {
                if (selectedSubclasses[major].length > 0) {
                    majorCount++;
                    totalSubCount += selectedSubclasses[major].length;
                }
            }
            return { majorCount, totalSubCount };
        }

        // æ ¸å¿ƒè´¹ç”¨è®¡ç®—
        function computeFeeText() {
            const scheme = document.querySelector('input[name="scheme"]:checked')?.value || 'A';
            const params = schemeParams[scheme];
            const withInvoice = document.getElementById('invoiceCheckbox').checked;

            let totalOriginal = 0;
            const majorDetails = {};
            for (let major in selectedSubclasses) {
                let subList = selectedSubclasses[major];
                if (subList.length === 0) continue;
                let count = subList.length;
                let cost = (count <= 10) ? params.base : (params.base + (count - 10) * params.extra);
                majorDetails[major] = { count, cost };
                totalOriginal += cost;
            }

            const majorCount = Object.keys(selectedSubclasses).length;
            let discountNote = '';
            let finalTotal = totalOriginal;
            if (scheme === 'B' && majorCount > 6) {
                finalTotal = totalOriginal * 0.85;
                discountNote = 'ğŸ Bæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ : æ€»é‡‘é¢ç«‹å‡15%';
            }
            let invoiceAmount = withInvoice ? finalTotal * 0.05 : 0;
            let totalWithInvoice = finalTotal + invoiceAmount;

            let lines = [];
            lines.push(`=== æœåŠ¡æ–¹æ¡ˆ: ${scheme}æ–¹æ¡ˆÂ·${params.name} ===`);
            lines.push(`ğŸ’° åŸºç¡€ä»·æ ¼ï¼šæ¯å¤§ç±»${params.base}å…ƒï¼ˆå«10å°ç±»ï¼‰ï¼Œè¶…å‡ºéƒ¨åˆ†${params.extra}å…ƒ/å°ç±»ã€‚`);
            if (scheme === 'B' && majorCount > 6) lines.push(discountNote);
            if (scheme === 'C') lines.push('ğŸ Cæ–¹æ¡ˆå¤§å®¢æˆ·ä¼˜æƒ ï¼šå¤§ç±»ï¼6ä¸ªå°¾æ¬¾å‡å…15%');
            lines.push('');

            lines.push('=== ğŸ’° è´¹ç”¨æ˜ç»† ===');
            if (majorCount === 0) {
                lines.push('âš ï¸ å°šæœªé€‰æ‹©ä»»ä½•å°ç±»');
            } else {
                for (let major in majorDetails) {
                    let d = majorDetails[major];
                    lines.push(`ğŸ“Œ ${major}å¤§ç±»ï¼ˆ${d.count}ä¸ªå°ç±»ï¼‰ = ${d.cost}å…ƒ`);
                }
                lines.push(`ğŸ“Š å°è®¡ï¼ˆåŸä»·ï¼‰: ${totalOriginal.toFixed(2)}å…ƒ`);
                if (scheme === 'B' && majorCount > 6) {
                    lines.push(`ğŸ“Š å°è®¡ï¼ˆä¼˜æƒ åï¼‰: ${finalTotal.toFixed(2)}å…ƒ`);
                }
                if (withInvoice) {
                    lines.push(`ğŸ§¾ ä¸“ç¥¨è´¹ç”¨ï¼ˆåŠ æ”¶5%ï¼‰: ${invoiceAmount.toFixed(2)}å…ƒ`);
                    lines.push(`ğŸ’ æ€»åˆè®¡ï¼ˆå«ä¸“ç¥¨ï¼‰: ${totalWithInvoice.toFixed(2)}å…ƒ`);
                } else {
                    lines.push(`ğŸ§¾ ä¸“ç¥¨è´¹ç”¨: 0å…ƒï¼ˆæœªé€‰æ‹©ï¼‰`);
                    lines.push(`ğŸ’ æ€»åˆè®¡: ${finalTotal.toFixed(2)}å…ƒ`);
                }
                lines.push('');

                if (scheme === 'A' || scheme === 'B') {
                    lines.push(`ã€${scheme}æ–¹æ¡ˆÂ·ä»˜æ¬¾è®¡åˆ’ã€‘`);
                    let payAmount = withInvoice ? totalWithInvoice : finalTotal;
                    lines.push(`ğŸ“… ç­¾åˆåŒåä¸€æ¬¡æ€§ä»˜æ¸…: ${payAmount.toFixed(2)}å…ƒ`);
                } else if (scheme === 'C') {
                    lines.push('ã€Cæ–¹æ¡ˆÂ·åç½®ä»˜è´¹è®¡åˆ’ã€‘');
                    let baseForFirst = withInvoice ? totalWithInvoice : finalTotal;
                    let firstPayment = baseForFirst * (300/1100);
                    lines.push(`ğŸ”¹ é¦–ä»˜æ¬¾ï¼ˆç­¾åˆåŒåï¼‰: ${baseForFirst.toFixed(2)}Ã—27.27% = ${firstPayment.toFixed(2)}å…ƒ`);
                    if (majorCount > 6) lines.push('ğŸ ã€Cæ–¹æ¡ˆå°¾æ¬¾å‡å…15%ã€‘');
                    lines.push('ğŸ”¹ å°¾æ¬¾æ”¯ä»˜ï¼ˆæ¯å¤§ç±»ä¸‹å‘æ³¨å†Œè¯åï¼‰:');
                    let idx = 1;
                    for (let major in majorDetails) {
                        let cost = majorDetails[major].cost;
                        let withInvoiceCost = withInvoice ? cost * 1.05 : cost;
                        let tailPercent = 0.7273;
                        if (majorCount > 6) tailPercent *= 0.85;
                        let tail = withInvoiceCost * tailPercent;
                        lines.push(`   ${idx}. ${major}å¤§ç±»å°¾æ¬¾ï¼š${withInvoiceCost.toFixed(2)}Ã—${(tailPercent*100).toFixed(2)}% = ${tail.toFixed(2)}å…ƒ`);
                        idx++;
                    }
                }
                lines.push('');
                lines.push('=== ğŸ’³ ä»˜æ¬¾ä¿¡æ¯ ===');
                lines.push('è´¦æˆ·åç§°ï¼šä¼ä¼˜å’¨ï¼ˆå¹¿å·ï¼‰å’¨è¯¢æœ‰é™å…¬å¸');
                lines.push('è´¦æˆ·å·ç ï¼š4405 0158 0107 0000 4275');
                lines.push('å¼€æˆ·é“¶è¡Œï¼šä¸­å›½å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸å¹¿å·èŠ±åŸæ”¯è¡Œ');
                lines.push('ã€ğŸ“Œ é‡è¦æç¤ºã€‘1. ä»˜æ¬¾æ°´å•å‘ç»™é™ˆå·¥ï¼›2. å¯åŠ¨æœåŠ¡åä¸æ”¯æŒé€€æ¬¾');
            }
            return lines.join('\n');
        }

        function refreshUI() {
            // æ›´æ–°å·²é€‰åˆ—è¡¨æ˜¾ç¤º
            const ul = document.getElementById('selectedListUl');
            ul.innerHTML = '';
            for (let major in selectedSubclasses) {
                if (selectedSubclasses[major].length === 0) continue;
                let li = document.createElement('li');
                li.innerHTML = `<strong>ã€${escapeHtml(major)}ã€‘</strong>`;
                ul.appendChild(li);
                let subUl = document.createElement('ul');
                selectedSubclasses[major].forEach(sub => {
                    let subLi = document.createElement('li');
                    subLi.textContent = sub;
                    subUl.appendChild(subLi);
                });
                ul.appendChild(subUl);
            }
            if (ul.children.length === 0) {
                ul.innerHTML = '<span style="color:#aaa;">æš‚æ— å·²é€‰å°ç±»</span>';
            }

            let stats = getSelectedStats();
            document.getElementById('selectedCountBadge').innerText = `å·²é€‰ ${stats.totalSubCount} ä¸ªå°ç±»`;
            document.getElementById('feeDisplay').innerText = computeFeeText();
            syncCheckboxesFromSelected();
        }

        function syncCheckboxesFromSelected() {
            const checkboxes = document.querySelectorAll('.subclass-checkbox');
            checkboxes.forEach(cb => {
                const major = cb.dataset.major;
                const sub = cb.dataset.sub;
                cb.checked = !!(selectedSubclasses[major] && selectedSubclasses[major].includes(sub));
            });
        }

        function handleCheckboxChange(e) {
            const cb = e.target;
            const major = cb.dataset.major;
            const sub = cb.dataset.sub;
            if (!major || !sub) return;
            if (cb.checked) {
                if (!selectedSubclasses[major]) selectedSubclasses[major] = [];
                if (!selectedSubclasses[major].includes(sub)) {
                    selectedSubclasses[major].push(sub);
                }
            } else {
                if (selectedSubclasses[major]) {
                    const idx = selectedSubclasses[major].indexOf(sub);
                    if (idx > -1) selectedSubclasses[major].splice(idx, 1);
                    if (selectedSubclasses[major].length === 0) delete selectedSubclasses[major];
                }
            }
            refreshUI();
        }

        // è½¬ä¹‰å‡½æ•°
        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>"]/g, function(m) {
                if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
                return m;
            });
        }
        function escapeAttr(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function getTotalSubCount() {
            let c = 0;
            rawData.forEach(m => (m.children || []).forEach(g => (g.children || []).forEach(() => c++)));
            return c;
        }

        // æ¸²æŸ“æ ‘ï¼ˆå¸¦æŠ˜å å±•å¼€åŠŸèƒ½ï¼‰
        function renderTree(filterText = '') {
            const treeElem = document.getElementById('categoryTree');
            treeElem.innerHTML = '';
            if (!rawData || rawData.length === 0) {
                treeElem.innerHTML = '<li style="padding:20px; color:red;">âš ï¸ æœªåŠ è½½åˆ†ç±»æ•°æ®</li>';
                return;
            }

            let matchCount = 0;
            const lowerFilter = filterText.toLowerCase().trim();
            const hasFilter = lowerFilter !== '';

            rawData.forEach(majorNode => {
                const majorName = majorNode.å¤§ç±» || majorNode.name || '';
                let majorHasMatch = false;
                let groupsHTML = '';

                (majorNode.children || []).forEach(groupNode => {
                    const groupName = groupNode.name || groupNode.ç±»ä¼¼ç¾¤ç»„ || '';
                    const groupNumber = groupNode.ç±»ä¼¼ç¾¤ç»„ || '';
                    const groupText = `${groupNumber} ${groupName}`.toLowerCase();
                    let groupHasMatch = false;
                    let subItemsHTML = '';

                    (groupNode.children || []).forEach(subNode => {
                        const subName = subNode.å°ç±» || subNode.name || '';
                        const subText = subName.toLowerCase();
                        const match = !hasFilter || 
                                      majorName.toLowerCase().includes(lowerFilter) ||
                                      groupText.includes(lowerFilter) ||
                                      subText.includes(lowerFilter);
                        if (match || !hasFilter) {
                            groupHasMatch = true;
                            majorHasMatch = true;
                            matchCount++;
                            const checked = (selectedSubclasses[majorName] && selectedSubclasses[majorName].includes(subName)) ? 'checked' : '';
                            subItemsHTML += `<li class="subclass-item">
                                <input type="checkbox" class="subclass-checkbox" data-major="${escapeAttr(majorName)}" data-sub="${escapeAttr(subName)}" ${checked}>
                                <span class="subclass-name">${escapeHtml(subName)}</span>
                            </li>`;
                        }
                    });

                    if (groupHasMatch || !hasFilter) {
                        // å¦‚æœç¾¤ç»„ä¸‹æœ‰åŒ¹é…é¡¹ï¼ˆæˆ–æ²¡æœ‰è¿‡æ»¤ï¼‰ï¼Œåˆ™ç”Ÿæˆç¾¤ç»„HTMLï¼Œå¹¶æ ¹æ®æ˜¯å¦æœ‰è¿‡æ»¤å†³å®šæ˜¯å¦è‡ªåŠ¨å±•å¼€
                        let groupLiClass = 'tree-li group-li';
                        if (hasFilter && groupHasMatch) groupLiClass += ' expanded'; // æœç´¢æ—¶å±•å¼€åŒ¹é…çš„ç¾¤ç»„
                        groupsHTML += `<li class="${groupLiClass}">
                            <div class="folder-label cat-group" data-group="${escapeAttr(groupNumber)}">ğŸ“ ${escapeHtml(groupNumber)} - ${escapeHtml(groupName)}</div>
                            <ul class="group-subs">${subItemsHTML}</ul>
                        </li>`;
                    }
                });

                if (majorHasMatch || !hasFilter) {
                    // ç”Ÿæˆå¤§ç±»HTMLï¼Œå¹¶æ ¹æ®æ˜¯å¦æœ‰è¿‡æ»¤å†³å®šæ˜¯å¦è‡ªåŠ¨å±•å¼€
                    let majorLiClass = 'tree-li major-li';
                    if (hasFilter && majorHasMatch) majorLiClass += ' expanded'; // æœç´¢æ—¶å±•å¼€åŒ¹é…çš„å¤§ç±»
                    const majorLi = document.createElement('li');
                    majorLi.className = majorLiClass;
                    majorLi.innerHTML = `
                        <div class="folder-label cat-major" data-major="${escapeAttr(majorName)}">ğŸ“Œ å¤§ç±» ${escapeHtml(majorName)}</div>
                        <ul class="major-groups">${groupsHTML}</ul>
                    `;
                    treeElem.appendChild(majorLi);
                }
            });

            document.getElementById('searchCount').innerText = hasFilter ? `ğŸ” åŒ¹é… ${matchCount} é¡¹` : `å…± ${getTotalSubCount()} å°ç±»`;

            // é‡æ–°ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            document.querySelectorAll('.subclass-checkbox').forEach(cb => {
                cb.removeEventListener('change', handleCheckboxChange);
                cb.addEventListener('change', handleCheckboxChange);
            });
            syncCheckboxesFromSelected();

            // ä¸ºæ‰€æœ‰å¯æŠ˜å çš„æ ‡é¢˜æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå¤§ç±»ã€ç¾¤ç»„ï¼‰
            attachFolderListeners();
        }

        // æŠ˜å /å±•å¼€äº‹ä»¶ç›‘å¬
        function attachFolderListeners() {
            document.querySelectorAll('.major-li > .folder-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const li = this.parentElement;
                    li.classList.toggle('expanded');
                });
            });
            document.querySelectorAll('.group-li > .folder-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const li = this.parentElement;
                    li.classList.toggle('expanded');
                });
            });
        }

        // åŠ è½½JSON
        async function loadJSON() {
            try {
                const response = await fetch('å°¼æ–¯åˆ†ç±»è¡¨_æ ‘çŠ¶ç»“æ„.json');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½JSON (404)');
                rawData = await response.json();
                renderTree();
                refreshUI();
            } catch (e) {
                alert('åŠ è½½å°¼æ–¯åˆ†ç±»JSONå¤±è´¥ï¼Œè¯·å°† "å°¼æ–¯åˆ†ç±»è¡¨_æ ‘çŠ¶ç»“æ„.json" æ”¾åœ¨åŒç›®å½•ä¸‹ã€‚\né”™è¯¯ï¼š' + e.message);
            }
        }

        // æ¸…ç©º
        document.getElementById('clearSelectedBtn').addEventListener('click', function() {
            if (confirm('æ¸…ç©ºæ‰€æœ‰å·²é€‰å°ç±»ï¼Ÿ')) {
                selectedSubclasses = {};
                refreshUI();
                renderTree(document.getElementById('searchInput').value);
            }
        });

        // æœç´¢é˜²æŠ–
        let searchTimer;
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                renderTree(e.target.value);
            }, 300);
        });

        // å›¾ç‰‡ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewBox = document.getElementById('imagePreview');
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                trademarkImageData = ev.target.result;
                previewBox.innerHTML = `<img src="${ev.target.result}" alt="å•†æ ‡å›¾æ ·é¢„è§ˆ">`;
            };
            reader.readAsDataURL(file);
        });

        // æ–¹æ¡ˆåˆ‡æ¢/å‘ç¥¨æ›´æ–°
        document.querySelectorAll('input[name="scheme"]').forEach(r => {
            r.addEventListener('change', () => refreshUI());
        });
        document.getElementById('invoiceCheckbox').addEventListener('change', function() {
            document.getElementById('invoiceLabel').style.color = this.checked ? '#c00000' : 'inherit';
            refreshUI();
        });

        // é¢„è§ˆ
        document.getElementById('previewOrderBtn').addEventListener('click', function() {
            alert('å½“å‰è´¹ç”¨æ˜ç»†ï¼š\n\n' + computeFeeText());
        });

        // å¯¼å‡ºWord (é™çº§ä¸‹è½½)
        async function exportWord() {
            const applicant = cleanInput(document.getElementById('applicantName').value) || 'æœªå¡«å†™';
            const tmName = cleanInput(document.getElementById('trademarkName').value) || 'æœªå¡«å†™';
            const phone = cleanInput(document.getElementById('contactPhone').value) || '';
            const contact = cleanInput(document.getElementById('contactPerson').value) || '';

            if (!applicant || !tmName) {
                alert('è¯·å¡«å†™ç”³è¯·äººå…¨ç§°å’Œå•†æ ‡åç§°');
                return;
            }
            if (Object.keys(selectedSubclasses).length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°ç±»');
                return;
            }

            let htmlContent = `
            <html>
            <head><meta charset="UTF-8"><title>å•†æ ‡ç”³è¯·è®¢å•</title>
            <style>body { font-family: å¾®è½¯é›…é»‘, sans-serif; margin:2cm; } h2 { color:#003d7c; } table { border-collapse: collapse; width:100%; } td,th { border:1px solid #aaa; padding:8px; } .bold { font-weight:600; } .red { color:#c00000; }</style>
            </head>
            <body>
            <h2 style="text-align:center;">ğŸ“„ å•†æ ‡ç”³è¯·è®¢å•</h2>
            <p><strong>ç”³è¯·äººå…¨ç§°ï¼š</strong>${escapeHtml(applicant)}</p>
            <p><strong>å•†æ ‡åç§°ï¼š</strong>${escapeHtml(tmName)}</p>
            <p><strong>è”ç³»ç”µè¯ï¼š</strong>${escapeHtml(phone)}</p>
            <p><strong>è”ç³»äººï¼š</strong>${escapeHtml(contact)}</p>
            <p><strong>æ—¥æœŸï¼š</strong>${new Date().toLocaleDateString('zh-CN')}</p>
            <h3>ä¸€ã€å·²é€‰ç±»åˆ«æ˜ç»†</h3>
            <ul>`;
            for (let major in selectedSubclasses) {
                htmlContent += `<li><strong>ã€${escapeHtml(major)}ã€‘</strong><ul>`;
                selectedSubclasses[major].forEach(s => htmlContent += `<li>${escapeHtml(s)}</li>`);
                htmlContent += `</ul></li>`;
            }
            htmlContent += `</ul>`;
            if (trademarkImageData) {
                htmlContent += `<h3>äºŒã€å•†æ ‡å›¾æ ·</h3><img src="${trademarkImageData}" style="max-width:200px;" />`;
            }
            htmlContent += `<h3>ä¸‰ã€æœåŠ¡æ–¹æ¡ˆåŠè´¹ç”¨</h3><pre style="background:#f4f8ff; padding:16px;">${computeFeeText()}</pre>`;
            htmlContent += `<p>â€”â€” æœ¬è®¢å•ç”±ä¼ä¼˜å’¨ç³»ç»Ÿç”Ÿæˆ â€”â€”</p></body></html>`;

            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å•†æ ‡è®¢å•_${applicant}_${tmName}.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('exportWordBtn').addEventListener('click', exportWord);

        // å¯åŠ¨
        loadJSON();

        // è®©scheme-optionç‚¹å‡»é€‰ä¸­radio
        document.querySelectorAll('.scheme-option').forEach(opt => {
            opt.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') return;
                const radio = this.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
                refreshUI();
            });
        });
    })();
</script>
</body>
</html>
